---
title: "WB HRVS estimation"
author: "Matthew Gordon"
date: "7/7/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
rootdir <- dirname(getwd())
```

### Load packages and data

```{r, message=FALSE, echo=FALSE, warning=FALSE}
library(tidyverse)
library(sf)
library(lfe)
library(AER)
library(ggnewscale)
library(cowplot)
library(stargazer)
library(sandwich)
library(readstata13)
#devtools::install_github("mdgordo/rdrobust",ref="master")
library(rdrobust)
#devtools::install_github("mdgordo/dumbells",ref="master")
library(dumbells)
library(rdpower)
source(paste(rootdir, "/code/rdhelpers.r", sep = ""))

df.hh <- read_csv(paste(rootdir, "/data/processed/full_panel.csv", sep = ""), guess_max = 7500)
```

#### Regression Discontinuity

### MSE bandwidths - Cattaneo paper
Can try also with aid_total - similar

```{r}
bws <- rbind(optbw("aid_cumulative_bin", b = "dist_2_seg13", df = df.hh),
      optbw("consumption", b = "dist_2_seg13", df = df.hh, fuzzy = TRUE))

h0 <- bws[2,1]
b0 <- bws[2,3]
```

Power calculations

```{r, warning = FALSE}
df.pow <- filter(df.hh, !is.na(consumption))
powcovs <- model.matrix(~as.factor(df.pow$border_segment13)+as.factor(df.pow$border_segment13)*df.pow$dist_2_seg13 + df.pow$shake_pga + as.factor(df.pow$wave))
powcovs <- powcovs[, !(colnames(powcovs) %in% c("(Intercept)", "df.pow$dist_2_seg13"))]

df.pow <- mutate(df.pow, fcs60 = if_else(consumption < 60000, 1, 0),
                fcs100 = if_else(consumption < 100000, 1, 0),
                fcs200up = if_else(consumption < 200000, 0, 1))

print("First Stage")
a <- rdpower(data = cbind(df.pow$aid_cumulative_bin, df.pow$dist_2_seg13), h = h0, b = b0, kernel = "epanechnikov", vce = "hc3", 
        covs =  powcovs, cluster = df.pow$strata, weights = df.pow$wt_hh)
print("Consumption")
a <- rdpower(data = cbind(df.pow$consumption, df.pow$dist_2_seg13), h = h0, b = b0, kernel = "epanechnikov", vce = "hc3", 
        covs =  powcovs, cluster = df.pow$strata, weights = df.pow$wt_hh)
print("Consumption w IV")
a <- rdpower(data = cbind(df.pow$consumption, df.pow$dist_2_seg13), h = h0, b = b0, kernel = "epanechnikov", vce = "hc3", 
        covs =  powcovs, cluster = df.pow$strata, weights = df.pow$wt_hh, fuzzy = df.pow$aid_cumulative_bin)
print("Consumption Dummies")
a <- rdpower(data = cbind(df.pow$fcs60, df.pow$dist_2_seg13), h = h0, b = b0, kernel = "epanechnikov", vce = "hc3", 
        covs =  powcovs, cluster = df.pow$strata, weights = df.pow$wt_hh, fuzzy = df.pow$aid_cumulative_bin)

a <- rdpower(data = cbind(df.pow$fcs100, df.pow$dist_2_seg13), h = h0, b = b0, kernel = "epanechnikov", vce = "hc3", 
        covs =  powcovs, cluster = df.pow$strata, weights = df.pow$wt_hh, fuzzy = df.pow$aid_cumulative_bin)

a <- rdpower(data = cbind(df.pow$fcs200up, df.pow$dist_2_seg13), h = h0, b = b0, kernel = "epanechnikov", vce = "hc3", 
        covs =  powcovs, cluster = df.pow$strata, weights = df.pow$wt_hh, fuzzy = df.pow$aid_cumulative_bin)
```

### Functions for Mccrary test
Discrete version based on: https://cattaneo.princeton.edu/aie-rdd/Frandsen_2016_AIE.pdf
Sampling frame based on 2010 census - need to adjust to hhs per unit area

```{r}
mcplot <- histfunc("dist_2_seg13", filter(df.hh, wave==1), h = 50)

mcplot + labs(x = "distance to border")
```

### RD plots

Define vars and calculate optimal bandwidths
```{r}
placebos <- c("elevation", "shake_pga", "gorkha_loss", "gorkha_loss_amt", "high_caste", "femalehh", "age_hh", "highest_ed", 
              "always_lived_house", "always_lived_dist", "slope", "pub_transfers", "NGO_transfers")
infravars <- c("time_to_market", "time_to_bank", "time_to_school", "time_to_health")
aidvars <- c("aid_cumulative_bin", "aid_cumulative")
numvars <- c("hhmembers", "under5", "under18", "over65", "currentlyliving", "extended_members", "children_attending", "days_ill", "emotion_good", "years_ago_built")
consumptionvars <- c("food_consumption", "durables_consumption", "transportation", "energy_utilities", "ceremonial_expenses", "other_consumption",
                     "consumption_pc", "food_consumption_pc")
incomevars <- c("income", "remittance_income", "annual_wages", "ag_livestock_income", "business_income", "inf_transfers", "pub_transfers", 
                "inputs", "income_pc", "total_income")
pricevars <- c("chicken_price", "rice_price", "lentil_price", "sugar_price", "mutton_price", "potato_price")
assetvars <- c("livestock_sales", "livestock_purchases", "investments", "asset_sales",
               "loans_taken_past_year", "loan_payments", "avg_interest_past_year", "financial_assets", "home_value")
shockvars <- c("natural_shocks", "natural_shocks_bin", "market_shocks", "market_shocks_bin", "idiosyncratic_shocks", "idiosyncratic_shocks_bin")
copingvars <- c("temp_earth_housing", "dissaving", "felt_hunger", "school_interrupt", 
                "child_labor", "child_days_worked", "child_wage_days", "n_migrants")
```

### Placebo tests

```{r, message=FALSE, warning=FALSE}
plotlist <- lapply(placebos[!placebos %in% c("elevation", "shake_pga")], plotvar, b = "dist_2_seg13", df = df.hh)
plotlist
plotlist[[2]] +
  labs(x = "distance to border", y = "reported earthquake losses")

plotlist[[4]] +
  labs(x = "distance to border", y = "Female headed households")

plotlist[[11]] +
  labs(x = "distance to border", y = "NGO aid")
```

```{r, message=FALSE, warning=FALSE}
lapply(infravars, plotvar, b = "dist_2_seg13", df = df.hh)
lapply(pricevars, plotvar, b = "dist_2_seg13", df = df.hh)
```

### Aid vars

```{r, message=FALSE, warning=FALSE}
plotlist <- lapply(aidvars, plotvar, b = "dist_2_seg13", df = df.hh)
plotlist
```

### regressions

First stage

```{r, warnings=FALSE}
rdstg1 <- lapply(aidvars, regout, b = "dist_2_seg13", df = df.hh, h = h0, b0 = b0, k = "epanechnikov", vce = "hc3")

rdgazer(rdstg1, dvlabs = c("Received Aid", "Cumulative Aid"), 
        xlines = list(c("Wards", sapply(rdstg1, function(x) length(unique(x$X[abs(x$X)<x$bws[2,1]]))))), type = "text")

rdplacebo <- lapply(c(placebos[!(placebos %in% c("elevation", "shake_pga", "slope"))]), regout, b = "dist_2_seg13", df = df.hh, 
                    h = h0, b0 = b0, k = "epanechnikov", vce = "hc3")
rdgazer(rdplacebo, dvlabs = str_replace_all(c(placebos[!(placebos %in% c("elevation", "shake_pga", "slope"))]), "_", " "), 
        xlines = list(c("Wards", sapply(rdplacebo, function(x) length(unique(x$X[abs(x$X)<x$bws[2,1]]))))), type = "text")

rdprice <- lapply(c(pricevars, infravars), regout, b = "dist_2_seg13", df = df.hh, h = h0, b0 = b0)
rdgazer(rdprice, dvlabs = str_replace_all(c(pricevars, infravars), "_", " "), 
        xlines = list(c("Wards", sapply(rdprice, function(x) length(unique(x$X[abs(x$X)<x$bws[2,1]]))))), type = "text")
```


```{r, message=FALSE, echo=FALSE, warning=FALSE}
rdnum1 <- lapply(numvars, regout, b = "dist_2_seg13", df = df.hh, h = h0, b0 = b0, fuzzy = TRUE)
rdgazer(rdnum1, dvlabs = str_replace_all(numvars, "_", " "), 
        xlines = list(c("Wards", sapply(rdnum1, function(x) length(unique(x$X[abs(x$X)<x$bws[2,1]]))))))
```

```{r}
lapply(numvars[numvars!="emotion_good"], plotvar, b = "dist_2_seg13", df = df.hh, h = 50)
```

```{r, message=FALSE, echo=FALSE, warning=FALSE}
rdcash <- lapply(consumptionvars, regout, b = "dist_2_seg13", df = df.hh, h = h0, b0 = b0, fuzzy = TRUE)
rdgazer(rdcash, dvlabs = str_replace_all(consumptionvars, "_", " "), 
        xlines = list(c("Wards", sapply(rdcash, function(x) length(unique(x$X[abs(x$X)<x$bws[2,1]]))))), type = "text")
```

```{r}
plotlist <- lapply(consumptionvars, plotvar, b = "dist_2_seg13", df = df.hh, ihs=FALSE)
plotlist
```

```{r, message=FALSE, echo=FALSE, warning=FALSE}
rdcash <- lapply(incomevars, regout, b = "dist_2_seg13", df = df.hh, h = h0, b0 = b0, fuzzy = TRUE)
rdgazer(rdcash, dvlabs = str_replace_all(incomevars, "_", " "), 
        xlines = list(c("Wards", sapply(rdcash, function(x) length(unique(x$X[abs(x$X)<x$bws[2,1]]))))), type = "text")
```


```{r, message=FALSE, echo=FALSE, warning=FALSE}
plotlist <- lapply(incomevars, plotvar, b = "dist_2_seg13", df = df.hh, ihs=FALSE)
plotlist
```

```{r, message=FALSE, echo=FALSE, warning=FALSE}
rdcash <- lapply(assetvars, regout, b = "dist_2_seg13", df = df.hh, h = h0, b0 = b0, fuzzy = TRUE)
rdgazer(rdcash, dvlabs = str_replace_all(assetvars, "_", " "), 
        xlines = list(c("Wards", sapply(rdcash, function(x) length(unique(x$X[abs(x$X)<x$bws[2,1]]))))), type = "text")
```


```{r, message=FALSE, echo=FALSE, warning=FALSE}
plotlist <- lapply(assetvars, plotvar, b = "dist_2_seg13", df = df.hh)
plotlist
```

Wave 2 saw drought in some districts

```{r, message=FALSE, echo=FALSE, warning=FALSE}
rdshock <- lapply(shockvars, regout, b = "dist_2_seg13", df = df.hh, h = h0, b0 = b0, fuzzy = TRUE)
rdgazer(rdshock, dvlabs = str_replace_all(shockvars, "_", " "), 
        xlines = list(c("Wards", sapply(rdshock, function(x) length(unique(x$X[abs(x$X)<x$bws[2,1]]))))), type = "text")
```

```{r, message=FALSE, echo=FALSE, warning=FALSE}
plotlist <- lapply(shockvars, plotvar, b = "dist_2_seg13", df = df.hh)
plotlist
```

### Probability of shock & coping vars

```{r, message=FALSE, echo=FALSE, warning=FALSE}
rdshock <- lapply(copingvars, regout, b = "dist_2_seg13", df = df.hh, h = h0, b0 = b0, fuzzy = TRUE)
rdgazer(rdshock, dvlabs = str_replace_all(copingvars, "_", " "), 
        xlines = list(c("Wards", sapply(rdshock, function(x) length(unique(x$X[abs(x$X)<x$bws[2,1]]))))), type = "text")
```

```{r, message=FALSE, echo=FALSE, warning=FALSE}
plotlist <- lapply(copingvars, plotvar, b = "dist_2_seg13", df = df.hh)
plotlist
```

### Quantile RD

```{r, warning = FALSE}
cvarscutpts <- seq(40000, 200000, 20000)
ctlist <- lapply(cvarscutpts, cutvars, var = "consumption")
df <- cbind(df.hh, do.call(cbind, ctlist))

cvarst <- paste("t", cvarscutpts, sep = "")
cvarsu <- paste("u", cvarscutpts, sep = "")
cvarsc <- paste("c", cvarscutpts, sep = "")

rdc <- lapply(cvarst, regout, b = "dist_2_seg13", df = df, h = h0, b0 = b0, fuzzy = TRUE)
rdgazer(rdc, dvlabs = paste("<", cvarscutpts/1000, "k npr", sep = ""), 
        xlines = list(c("Wards", sapply(rdc, function(x) length(unique(x$X[abs(x$X)<x$bws[2,1]]))))), type = "text")

rdcu <- lapply(cvarsu, regout, b = "dist_2_seg13", df = df, h = h0, b0 = b0, fuzzy = "inv")
rdgazer(rdcu, dvlabs = paste("<", cvarscutpts/1000, "k npr", sep = ""), 
        xlines = list(c("Wards", sapply(rdcu, function(x) length(unique(x$X[abs(x$X)<x$bws[2,1]]))))), type = "text")

rdcc <- lapply(cvarsc, regout, b = "dist_2_seg13", df = df, h = h0, b0 = b0, fuzzy = TRUE)
rdgazer(rdcc, dvlabs = paste("<", cvarscutpts/1000, "k npr", sep = ""), 
        xlines = list(c("Wards", sapply(rdcc, function(x) length(unique(x$X[abs(x$X)<x$bws[2,1]]))))), type = "text")
```

```{r}
qplot("consumption")
```

Food Consumption - 100,000 is about $2.7/day, close to the median

```{r, warning = FALSE}
cvarscutpts <- seq(40000, 200000, 20000)
ctlist <- lapply(cvarscutpts, cutvars, var = "food_consumption")
df <- cbind(df.hh, do.call(cbind, ctlist))

cvarst <- paste("t", cvarscutpts, sep = "")
cvarsu <- paste("u", cvarscutpts, sep = "")
cvarsc <- paste("c", cvarscutpts, sep = "")

rdc <- lapply(cvarst, regout, b = "dist_2_seg13", df = df, h = h0, b0 = b0, fuzzy = TRUE)
rdgazer(rdc, dvlabs = paste("<", cvarscutpts/1000, "k npr", sep = ""), 
        xlines = list(c("Wards", sapply(rdc, function(x) length(unique(x$X[abs(x$X)<x$bws[2,1]]))))), type = "text")

rdcu <- lapply(cvarsu, regout, b = "dist_2_seg13", df = df, h = h0, b0 = b0, fuzzy = "inv")
rdgazer(rdcu, dvlabs = paste("<", cvarscutpts/1000, "k npr", sep = ""), 
        xlines = list(c("Wards", sapply(rdcu, function(x) length(unique(x$X[abs(x$X)<x$bws[2,1]]))))), type = "text")

rdcc <- lapply(cvarsc, regout, b = "dist_2_seg13", df = df, h = h0, b0 = b0, fuzzy = TRUE)
rdgazer(rdcc, dvlabs = paste("<", cvarscutpts/1000, "k npr", sep = ""), 
        xlines = list(c("Wards", sapply(rdcc, function(x) length(unique(x$X[abs(x$X)<x$bws[2,1]]))))), type = "text")
```

```{r}
qplot("food_consumption")
```


```{r, warning = FALSE}
cvarscutpts <- seq(10000, 190000, 20000)
ctlist <- lapply(cvarscutpts, cutvars, var = "income")
df <- cbind(df.hh, do.call(cbind, ctlist))

cvarst <- paste("t", cvarscutpts, sep = "")
cvarsu <- paste("u", cvarscutpts, sep = "")
cvarsc <- paste("c", cvarscutpts, sep = "")

rdc <- lapply(cvarst, regout, b = "dist_2_seg13", df = df, h = h0, b0 = b0, fuzzy = TRUE)
rdgazer(rdc, dvlabs = paste("<", cvarscutpts/1000, "k npr", sep = ""), 
        xlines = list(c("Wards", sapply(rdc, function(x) length(unique(x$X[abs(x$X)<x$bws[2,1]]))))), type = "text")

rdcu <- lapply(cvarsu, regout, b = "dist_2_seg13", df = df, h = h0, b0 = b0, fuzzy = "inv")
rdgazer(rdcu, dvlabs = paste("<", cvarscutpts/1000, "k npr", sep = ""), 
        xlines = list(c("Wards", sapply(rdcu, function(x) length(unique(x$X[abs(x$X)<x$bws[2,1]]))))), type = "text")

rdcc <- lapply(cvarsc, regout, b = "dist_2_seg13", df = df, h = h0, b0 = b0, fuzzy = TRUE)
rdgazer(rdcc, dvlabs = paste("<", cvarscutpts/1000, "k npr", sep = ""), 
        xlines = list(c("Wards", sapply(rdcc, function(x) length(unique(x$X[abs(x$X)<x$bws[2,1]]))))), type = "text")
```


```{r}
qplot("income")
```


```{r, warning = FALSE}
cvarscutpts <- seq(50000, 500000, 50000)
ctlist <- lapply(cvarscutpts, cutvars, var = "productive_assets")
df <- cbind(df.hh, do.call(cbind, ctlist))

cvarst <- paste("t", cvarscutpts, sep = "")
cvarsu <- paste("u", cvarscutpts, sep = "")
cvarsc <- paste("c", cvarscutpts, sep = "")

rdc <- lapply(cvarst, regout, b = "dist_2_seg13", df = df, h = h0, b0 = b0, fuzzy = TRUE)
rdgazer(rdc, dvlabs = paste("<", cvarscutpts/1000, "k npr", sep = ""), 
        xlines = list(c("Wards", sapply(rdc, function(x) length(unique(x$X[abs(x$X)<x$bws[2,1]]))))), type = "text")

rdcu <- lapply(cvarsu, regout, b = "dist_2_seg13", df = df, h = h0, b0 = b0, fuzzy = "inv")
rdgazer(rdcu, dvlabs = paste("<", cvarscutpts/1000, "k npr", sep = ""), 
        xlines = list(c("Wards", sapply(rdcu, function(x) length(unique(x$X[abs(x$X)<x$bws[2,1]]))))), type = "text")

rdcc <- lapply(cvarsc, regout, b = "dist_2_seg13", df = df, h = h0, b0 = b0, fuzzy = TRUE)
rdgazer(rdcc, dvlabs = paste("<", cvarscutpts/1000, "k npr", sep = ""), 
        xlines = list(c("Wards", sapply(rdcc, function(x) length(unique(x$X[abs(x$X)<x$bws[2,1]]))))), type = "text")
```

```{r}
qplot("productive_assets")
```