---
title: "WB HRVS descriptive"
author: "Matthew Gordon"
date: "7/7/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
rootdir <- dirname(getwd())
```

### Load packages and data

```{r, messages=FALSE, echo=FALSE, warnings=FALSE}
library(tidyverse)
library(sf)
library(lfe)
library(AER)
library(quantreg)
library(ggnewscale)
library(cowplot)
library(stargazer)
library(xtable)
library(sandwich)
library(readstata13)
#devtools::install_github("mdgordo/dumbells",ref="master")
library(dumbells)
library(rdrobust)
source(paste(rootdir, "/code/rdhelpers.r", sep = ""))

df.hh <- read_csv(paste(rootdir, "/data/processed/full_panel.csv", sep = ""), guess_max = 7500)
df <- filter(df.hh, !is.na(total_income) & food_consumption>0)
```

#### Summary Stats

```{r}
dfsum <- df[,c("consumption", "food_consumption", "income_gross", "productive_assets",
              "home_value", "home_investment", "financial_assets",
              "loans_taken_past_year", "loans_made_past_year", "remittance_income",
              "currentlyliving", "n_migrants", "skipped_meal", "aid_cumulative", "received_aid", 
              "NGO_transfers", "pub_transfers", "inf_transfers", "gorkha_hh")]

xtabwts <- sumstats.wtd(dfsum, df$wt_hh, d = 2, labs = c("Consumption", "Food Consumption", "Income", "Productive Assets", 
                              "Home Value", "Home Investment", "Financial Assets", "Loans Taken Past Year",
                              "Loans Made Past Year", "Remittance Income", "Household Members", "Connected Migrants", "Skipped Meal(%)",
                              "Earthquake Aid", "Earthquake Aid(%)", "NGO Aid", 
                              "Public Transfers", "Informal Transfers", "Affected by Earthquake"))
print(xtabwts, include.rownames = FALSE)

weighted.mean(df$n_migrants > 0, df$wt_hh)
weighted.mean(df$migrants_overseas, df$wt_hh)/weighted.mean(df$n_migrants, df$wt_hh)
weighted.mean(df$migrants_past_year, df$wt_hh)/weighted.mean(df$n_migrants, df$wt_hh)
weighted.mean(df$skipped_meal[df$wave==1], df$wt_hh[df$wave==1])
weighted.mean(df$skipped_meal[df$wave==2], df$wt_hh[df$wave==2])
weighted.mean(df$skipped_meal[df$wave==3], df$wt_hh[df$wave==3])
```

```{r}
aidtab <- df.hh %>%
  group_by(wave, quake_aid) %>%
  summarize(n = n())

ggplot(filter(aidtab, between(quake_aid, 1, 250000))) +
  geom_col(aes(x = as.factor(quake_aid/1000), y = n, fill = as.factor(wave), group = as.factor(wave)), position = "dodge") +
  theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), text = element_text(size = 20)) + 
  labs(x = "Aid (000s NPR)", fill = "Wave")
ggsave(paste(rootdir, "/presentation_materials/aid_hist.png", sep = ""), width = 10, height = 7)

disttab <- df.hh %>%
  group_by(designation) %>%
  summarize(affected_hhs = mean(gorkha_hh, na.rm = TRUE)*10e4,
            avg_losses = mean(quake_losses, na.rm = TRUE)) %>%
  pivot_longer(-designation, names_to = "var", values_to = "val")
disttab$designation <- factor(disttab$designation, levels = c("severe", "crisis", "heavy", "hit", "slight", "none"))
disttab$var <- factor(disttab$var, levels = c("avg_losses", "affected_hhs"))

ggplot(disttab) +
  geom_col(aes(x = designation, y = val, fill = var, group = var), position = "dodge") +
  theme_bw() + theme(text = element_text(size = 20)) + 
  labs(x = "", fill = "") + scale_y_continuous("Quake Losses (NPR)", label = scales::comma, sec.axis = sec_axis(~ ./10e4, name = "Affected HHs")) +
  scale_fill_discrete(labels = c("Average Loss", "Fraction Affected"))
ggsave(paste(rootdir, "/presentation_materials/distdesignations.png", sep = ""), width = 12, height = 7)

disttabfine <- df.hh %>%
  group_by(district, designation) %>%
  summarize(affected_hhs = mean(gorkha_hh, na.rm = TRUE),
            avg_losses = mean(quake_losses, na.rm = TRUE))

df.loss <- read.dta13(paste(rootdir, "/data/NPL_2016-2018_HRVS_v01_M_STATA12/Wave 1 - Household/Section_15a.dta", sep = "")) %>%
  filter(shockid %in% c("Earthquake", "Landslide") & s15q02!=4) %>%
  group_by(s15q02) %>%
  summarize(loss_type = n()*200,
            loss_amt = mean(s15q03, na.rm = TRUE)) %>%
  pivot_longer(-s15q02, names_to = "var", values_to = "val")

ggplot(df.loss) +
  geom_col(aes(x = as.factor(s15q02), y = val, fill = var, group = var), position = "dodge") +
  theme_bw() + theme(text = element_text(size = 20)) + 
  labs(x = "", fill = "") + scale_y_continuous("Quake Losses (NPR)", label = scales::comma, sec.axis = sec_axis(~ ./200, name = "Number of HHs")) +
  scale_fill_discrete(labels = c("Loss Amount", "Number of HHs")) + scale_x_discrete(labels = c("Income", "Assets", "Both"))
ggsave(paste(rootdir, "/presentation_materials/typeofloss.png", sep = ""), width = 12, height = 7)
```

Solukhumbhu had higher average losses than Makwanpur - otherwise all heaviest hit districts are in top two categories

### Risk sharing regressions
Income doesnt include remittances/transfers/loans or inputs - zeros dropped
coefficients usually about .2 (see Morten/Townsend)

Heterogeneity

```{r}
df <- filter(df, income_gross>0)

risksharing_all <- felm(log(food_consumption) ~ log(income_gross) 
                        | as.factor(hhid) + as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

risksharing_hc1 <- felm(log(food_consumption) ~ log(income_gross) + log(income_gross):caste_recode
                       | as.factor(hhid) + as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

risksharing_fh1 <- felm(log(food_consumption) ~ log(income_gross) + log(income_gross):femalehh
                        | as.factor(hhid) + as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

risksharing_l1 <- felm(log(food_consumption) ~ log(income_gross) + log(income_gross):land_qtle
                       | as.factor(hhid) + as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

risksharing_r1 <- felm(log(food_consumption) ~ log(income_gross) + log(income_gross):region
                       | as.factor(hhid) + as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

risksharing_q1 <- felm(log(food_consumption) ~ log(income_gross) + log(income_gross):gorkha_hh
                       | as.factor(hhid) + as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

mods <- list(risksharing_all, risksharing_hc1, risksharing_fh1, risksharing_l1, risksharing_r1, risksharing_q1)

stargazer(mods, type = "latex", style = "QJE", df = FALSE, omit.stat = c("adj.rsq", "ser"),
          notes = c("All regressions include household and village-year fixed effects. Standard errors clustered at the ward."), notes.align = "l")

weighted.mean(df.hh$remittance_income[df.hh$femalehh==1]>0, df.hh$wt_hh[df.hh$femalehh==1], na.rm = TRUE)
weighted.mean(df.hh$remittance_income[df.hh$femalehh==0]>0, df.hh$wt_hh[df.hh$femalehh==0], na.rm = TRUE)
```

### Cyclicality - ways of smoothing- HH FE
Interestingly, more likely to sell livestock than buy in a good year, but must be investing in other assets

```{r}
pubtransreg <- felm(log(pub_transfers + 1) ~ log(income_gross) | as.factor(hhid) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

inftransreg <- felm(log(inf_transfers + 1) ~ log(income_gross) | as.factor(hhid) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

aidreg <- felm(log(quake_aid + 1) ~ log(income_gross) | as.factor(hhid) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

ngoreg <- felm(log(NGO_transfers + 1) ~ log(income_gross) | as.factor(hhid) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

migreg <- felm(log(migrants_past_year+1) ~ log(income_gross) | as.factor(hhid) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

remreg2 <- felm(log(remittance_income + 1) ~ log(income_gross) + log(lag_remitt + 1) | as.factor(hhid) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

loanreg2 <- felm(log(loans_taken_past_year + 1) ~ log(income_gross) + log(lag_loan + 1) | as.factor(hhid) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

livereg2 <- felm(log(productive_assets+1) ~ log(income_gross) | as.factor(hhid) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

mods <- list(aidreg, pubtransreg, ngoreg, remreg2, migreg, loanreg2)

stargazer(mods, type = "latex", style = "QJE", df = FALSE, omit.stat = c("adj.rsq", "ser"),
          add.lines = list(c("Fixed Effects", rep("Household", 8)),
                           c("Cluster", rep("Ward", 8))))
```
### Progressivity - land value - VDC-YR FE

```{r}
cpubtransregvdc <- felm(log(pub_transfers + 1) ~ land_qtle | as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

cinftransregvdc <- felm(log(inf_transfers + 1) ~ land_qtle | as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

caidregvdc <- felm(log(quake_aid + 1) ~ land_qtle | as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

cngoregvdc <- felm(log(NGO_transfers + 1) ~ land_qtle | as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

cmigregvdc <- felm(log(migrants_past_year+1) ~ land_qtle | as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

cremregvdc <- felm(log(remittance_income + 1) ~ land_qtle | as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

cloanregvdc <- felm(log(loans_taken_past_year+1) ~ land_qtle | as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

mods <- list(caidregvdc, cpubtransregvdc, cngoregvdc, cremregvdc, cmigregvdc, cloanregvdc)

stargazer(mods, type = "latex", style = "QJE", df = FALSE, omit.stat = c("adj.rsq", "ser"),
          add.lines = list(c("Fixed Effects", rep("Village-Year", 8)),
                           c("Cluster", rep("Ward", 8))))
```
Summarizing:
Remittances, loans, migration are counter cyclical
Productive assets are procyclical
Within village aid is positively correlated with income/consumption - could be reverse causal
Within village loans uncorrelated w income but strong correlation w consumption, remittances negative w income, positive w consumption
Damage is most robust predictor of receiving aid

Argument: 
Wealthy suffer lower damages, but even conditional on damage,
damages are a noisy measure of need - wealthy hhs are insured through remittances/loans
Disasters are double whammy for poor - more damage + less insured


### sources of income
~ 100 nepali rupees = 1 dollar in 2016
Avg income ~ $2000
Best interpreted as fraction with source of income in a given year - eg total # of hhs that get a remittance over the study period is 48%, but only about 34% in a given year

```{r}
df.inc <- df.hh %>% 
  mutate(home_food_production = if_else(food_home_production > 0, 1, 0),
         agriculture = if_else(wet_ag_sales >0 | dry_ag_sales > 0, 1, 0),
         livestock = if_else(livestock_income > 0, 1, 0),
         business = if_else(business_revenues >0 ,1, 0),
         wages = if_else(annual_wages > 0, 1, 0),
         rental = if_else(landrents > 0 | equip_rental_income > 0 | cap_gains > 0 | rent_earned > 0, 1, 0),
         remittance = if_else(remittance_income > 0, 1, 0),
         informal = if_else(inf_transfers > 0, 1, 0),
         NGO_aid = if_else(NGO_transfers > 0, 1, 0),
         pub_transfers = if_else(pub_transfers > 0, 1, 0)) %>%
  summarize(home_food_production = weighted.mean(home_food_production, w = wt_hh, na.rm = TRUE),
            agriculture = weighted.mean(agriculture, w = wt_hh, na.rm = TRUE),
            livestock = weighted.mean(livestock, w = wt_hh, na.rm = TRUE),
            business = weighted.mean(business, w = wt_hh, na.rm = TRUE),
            wages = weighted.mean(wages, w = wt_hh, na.rm = TRUE),
            rental = weighted.mean(rental, w = wt_hh, na.rm = TRUE),
            remittance = weighted.mean(remittance, w = wt_hh, na.rm = TRUE),
            quake_aid = weighted.mean(received_aid, w = wt_hh, na.rm = TRUE),
            pub_aid = weighted.mean(pub_transfers, w = wt_hh, na.rm = TRUE),
            inf_aid = weighted.mean(informal, w = wt_hh, na.rm = TRUE),
            NGO_aid = weighted.mean(NGO_aid, w = wt_hh, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "source", values_to = "fraction")

df.inc$source <- factor(df.inc$source, levels = c("home_food_production", "agriculture", "livestock", "wages", "business", "rental", 
                                                  "quake_aid", "remittance", "pub_aid", "inf_aid", "NGO_aid"))

g1 <- ggplot(df.inc) + geom_bar(aes(x = source, weight = fraction, fill = source)) +
      theme_light() + theme(legend.position = "none", text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + 
      labs(y = "fraction of HHs with income", x = "")

df.inc <- df.hh %>% 
  mutate(home_food_productionwt = if_else(food_home_production > 0, 1, 0)*wt_hh,
         agriculturewt = if_else(wet_ag_sales >0 | dry_ag_sales > 0, 1, 0)*wt_hh,
         livestockwt = if_else(livestock_income > 0, 1, 0)*wt_hh,
         businesswt = if_else(business_revenues >0 ,1, 0)*wt_hh,
         wageswt = if_else(annual_wages > 0, 1, 0)*wt_hh,
         rentalwt = if_else(landrents > 0 | equip_rental_income > 0 | cap_gains > 0 | rent_earned > 0, 1, 0)*wt_hh,
         remittancewt = if_else(remittance_income > 0, 1, 0)*wt_hh,
         pubwt = if_else(pub_transfers > 0, 1, 0)*wt_hh,
         infwt = if_else(inf_transfers > 0, 1, 0)*wt_hh,
         ngowt = if_else(NGO_transfers > 0, 1, 0)*wt_hh) %>%
  summarize(home_food_production = 52*weighted.mean(food_home_production, w = home_food_productionwt, na.rm = TRUE),
            agriculture = weighted.mean(x = (wet_ag_sales + dry_ag_sales), w = agriculturewt, na.rm = TRUE),
            ag_costs = -1*weighted.mean(ag_costs, w = agriculturewt, na.rm = TRUE),
            landrent_paid = -1*weighted.mean(x = (landrent_paid_cash + landrent_paid_inkind), w = agriculturewt, na.rm = TRUE),
            livestock = weighted.mean(livestock_income, w = livestockwt, na.rm = TRUE),
            livestock_costs = -1*weighted.mean(livestock_costs, w = livestockwt, na.rm = TRUE),
            business = weighted.mean(business_revenues, w = businesswt, na.rm = TRUE),
            business_costs = -1*weighted.mean(business_expenses, w = businesswt, na.rm = TRUE),
            wages = weighted.mean(annual_wages, w = wageswt, na.rm = TRUE),
            rental = weighted.mean(x = (landrents + equip_rental_income + cap_gains + rent_earned), w = rentalwt, na.rm = TRUE),
            remittance = weighted.mean(remittance_income, w = remittancewt, na.rm = TRUE),
            quake_aid = weighted.mean(aid_total, w = received_aid*wt_hh, na.rm = TRUE),
            pub_aid = weighted.mean(pub_transfers, w = pubwt, na.rm = TRUE),
            inf_aid = weighted.mean(inf_transfers, w = infwt, na.rm = TRUE),
            NGO_aid = weighted.mean(NGO_transfers, w = ngowt, na.rm = TRUE),
            income = weighted.mean(income, w = wt_hh, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "source", values_to = "fraction")

df.inc$source <- factor(df.inc$source, levels = c("home_food_production", "agriculture", "ag_costs", "landrent_paid", "livestock", "livestock_costs", 
                                                  "wages", "business", "business_costs", "rental", "remittance", "quake_aid", "pub_aid", "inf_aid", "NGO_aid", "income"))

g2 <- ggplot(df.inc) + geom_bar(aes(x = source, weight = fraction, fill = source)) +
      theme_light() + theme(legend.position = "none", text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + 
      labs(y = "Avg Income | source > 0", x = "")

plot_grid(g1, g2, nrow = 1, rel_widths = c(4/9, 5/9))
ggsave(paste(rootdir, "/presentation_materials/income.png", sep = ""), width = 10, height = 7)
```

### types of assets

```{r}
df.assets <- df.hh %>% 
  mutate(home_value = if_else(home_value > 0, 1, 0),
         durables_stock = if_else(durables_stock > 0, 1, 0),
         landvalue = if_else(landvalue > 0, 1, 0),
         equip_stock = if_else(equip_stock >0 ,1, 0),
         livestock_value = if_else(livestock_value > 0, 1, 0),
         financial_assets = if_else(financial_assets > 0, 1, 0),
         savings_group = if_else(savings_group > 0, 1, 0),
         insurance_assets = if_else(insurance_assets > 0, 1, 0)) %>%
  summarize(home_value = weighted.mean(home_value, w = wt_hh, na.rm = TRUE),
            durables_stock = weighted.mean(durables_stock, w = wt_hh, na.rm = TRUE),
            landvalue = weighted.mean(landvalue, w = wt_hh, na.rm = TRUE),
            equip_stock = weighted.mean(equip_stock, w = wt_hh, na.rm = TRUE),
            livestock_value = weighted.mean(livestock_value, w = wt_hh, na.rm = TRUE),
            financial_assets = weighted.mean(financial_assets, w = wt_hh, na.rm = TRUE),
            savings_group = weighted.mean(savings_group, w = wt_hh, na.rm = TRUE),
            insurance_assets = weighted.mean(insurance_assets, w = wt_hh, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "asset_type", values_to = "fraction")

g1 <- ggplot(df.assets) + geom_bar(aes(x = asset_type, weight = fraction, fill = asset_type)) +
      theme_light() + theme(legend.position = "none", text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + 
      labs(y = "fraction of HHs with asset", x = "")

df.assets <- df.hh %>% 
  mutate(home_valuewt = if_else(home_value > 0, 1, 0)*wt_hh,
         durables_stockwt = if_else(durables_stock > 0, 1, 0)*wt_hh,
         landvaluewt = if_else(landvalue > 0, 1, 0)*wt_hh,
         equip_stockwt = if_else(equip_stock >0 ,1, 0)*wt_hh,
         livestock_valuewt = if_else(livestock_value > 0, 1, 0)*wt_hh,
         financial_assetswt = if_else(financial_assets > 0, 1, 0)*wt_hh,
         savings_groupwt = if_else(savings_group > 0, 1, 0)*wt_hh,
         insurance_assetswt = if_else(insurance_assets > 0, 1, 0)*wt_hh) %>%
  summarize(home_value = weighted.mean(home_value, w = home_valuewt, na.rm = TRUE),
            durables_stock = weighted.mean(durables_stock, w = durables_stockwt, na.rm = TRUE),
            landvalue = weighted.mean(landvalue, w = landvaluewt, na.rm = TRUE),
            equip_stock = weighted.mean(equip_stock, w = equip_stockwt, na.rm = TRUE),
            livestock_value = weighted.mean(livestock_value, w = livestock_valuewt, na.rm = TRUE),
            financial_assets = weighted.mean(financial_assets, w = financial_assetswt, na.rm = TRUE),
            savings_group = weighted.mean(savings_group, w = savings_groupwt, na.rm = TRUE),
            insurance_assets = weighted.mean(insurance_assets, w = insurance_assetswt, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "asset_type", values_to = "fraction")

g2 <- ggplot(df.assets) + geom_bar(aes(x = asset_type, weight = fraction, fill = asset_type)) +
      theme_light() + theme(legend.position = "none", text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + 
      labs(y = "Avg Value | asset_type > 0", x = "")

plot_grid(g1, g2, nrow = 1, rel_widths = c(4/9, 5/9))
ggsave(paste(rootdir, "/presentation_materials/assets.png", sep = ""), width = 10, height = 7)
```

### Investments
## note about half of loans come from and go to friends and relatives

```{r}
df.investments <- df.hh %>% 
  mutate(land_purchased = if_else(land_purchased > 0, 1, 0),
         land_sales = if_else(land_sales > 0, 1, 0),
         livestock_purchases = if_else(livestock_purchases > 0, 1, 0),
         livestock_sales = if_else(livestock_sales >0 ,1, 0),
         equip_purchases = if_else(equip_purchases > 0, 1, 0),
         equip_sales = if_else(equip_sales > 0, 1, 0),
         business_investment = if_else(business_investment > 0, 1, 0),
         business_asset_sales = if_else(business_asset_sales > 0, 1, 0),
         loans_taken_past_year = if_else(loans_taken_past_year > 0, 1, 0),
         loans_made_past_year = if_else(loans_made_past_year > 0, 1, 0)) %>%
  summarize(land_purchased = weighted.mean(land_purchased, w = wt_hh, na.rm = TRUE),
            land_sales = weighted.mean(land_sales, w = wt_hh, na.rm = TRUE),
            livestock_purchases = weighted.mean(livestock_purchases, w = wt_hh, na.rm = TRUE),
            livestock_sales = weighted.mean(livestock_sales, w = wt_hh, na.rm = TRUE),
            equip_purchases = weighted.mean(equip_purchases, w = wt_hh, na.rm = TRUE),
            equip_sales = weighted.mean(equip_sales, w = wt_hh, na.rm = TRUE),
            business_investment = weighted.mean(business_investment, w = wt_hh, na.rm = TRUE),
            business_asset_sales = weighted.mean(business_asset_sales, w = wt_hh, na.rm = TRUE),
            loans_taken_past_year = weighted.mean(loans_taken_past_year, w = wt_hh, na.rm = TRUE),
            loans_made_past_year = weighted.mean(loans_made_past_year, w = wt_hh, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "investment_type", values_to = "fraction")

g1 <- ggplot(df.investments) + geom_bar(aes(x = investment_type, weight = fraction, fill = investment_type)) +
      theme_light() + theme(legend.position = "none", text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + 
      labs(y = "fraction of HHs making investment", x = "")

df.investments <- df.hh %>% 
  mutate(land_purchasedwt = if_else(land_purchased > 0, 1, 0)*wt_hh,
         land_saleswt = if_else(land_sales > 0, 1, 0)*wt_hh,
         livestock_purchaseswt = if_else(livestock_purchases > 0, 1, 0)*wt_hh,
         livestock_saleswt = if_else(livestock_sales >0 ,1, 0)*wt_hh,
         equip_purchaseswt = if_else(equip_purchases > 0, 1, 0)*wt_hh,
         equip_saleswt = if_else(equip_sales > 0, 1, 0)*wt_hh,
         business_investmentwt = if_else(business_investment > 0, 1, 0)*wt_hh,
         business_asset_saleswt = if_else(business_asset_sales > 0, 1, 0)*wt_hh,
         loans_taken_past_yearwt = if_else(loans_taken_past_year > 0, 1, 0)*wt_hh,
         loans_made_past_yearwt = if_else(loans_made_past_year > 0, 1, 0)*wt_hh) %>%
  summarize(land_purchased = weighted.mean(land_purchased, w = land_purchasedwt, na.rm = TRUE),
            land_sales = weighted.mean(land_sales, w = land_saleswt, na.rm = TRUE),
            livestock_purchases = weighted.mean(livestock_purchases, w = livestock_purchaseswt, na.rm = TRUE),
            livestock_sales = weighted.mean(livestock_sales, w = livestock_saleswt, na.rm = TRUE),
            equip_purchases = weighted.mean(equip_purchases, w = equip_purchaseswt, na.rm = TRUE),
            equip_sales = weighted.mean(equip_sales, w = equip_saleswt, na.rm = TRUE),
            business_investment = weighted.mean(business_investment, w = business_investmentwt, na.rm = TRUE),
            business_asset_sales = weighted.mean(business_asset_sales, w = business_asset_saleswt, na.rm = TRUE),
            loans_taken_past_year = weighted.mean(loans_taken_past_year, w = loans_taken_past_yearwt, na.rm = TRUE),
            loans_made_past_year = weighted.mean(loans_made_past_year, w = loans_made_past_yearwt, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "investment_type", values_to = "fraction")

g2 <- ggplot(df.investments) + geom_bar(aes(x = investment_type, weight = fraction, fill = investment_type)) +
      theme_light() + theme(legend.position = "none", text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + 
      labs(y = "Avg Amount | investment > 0", x = "")

plot_grid(g1, g2, nrow = 1, rel_widths = c(4/9, 5/9))
ggsave(paste(rootdir, "/presentation_materials/investments.png", sep = ""), width = 10, height = 7)
```

### Consumption

```{r}
df.consumption <- df.hh %>% 
  mutate(other = entertainment_other + other_expenses + craft_consumption) %>%
  summarize(food_home_production = weighted.mean(food_home_production, w = wt_hh, na.rm = TRUE)*52,
            food_market = weighted.mean(food_market, w = wt_hh, na.rm = TRUE)*52,
            food_inkind = weighted.mean(food_inkind, w = wt_hh, na.rm = TRUE)*52,
            durables_consumption = weighted.mean(durables_consumption, w = wt_hh, na.rm = TRUE),
            energy = weighted.mean(energy, w = wt_hh, na.rm = TRUE),
            utilities = weighted.mean(utilities_paid, w = wt_hh, na.rm = TRUE),
            rent = weighted.mean(rent_paid, w = wt_hh, na.rm = TRUE),
            transportation = weighted.mean(transportation, w = wt_hh, na.rm = TRUE),
            clothing_cleaning_home = weighted.mean(clothing_cleaning_home, w = wt_hh, na.rm = TRUE),
            other = weighted.mean(other, w = wt_hh, na.rm = TRUE),
            ceremonial_expenses = weighted.mean(ceremonial_expenses, w = wt_hh, na.rm = TRUE),
            taxes = weighted.mean(taxes, w = wt_hh, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "consumption_type", values_to = "average_spending")

df.consumption$consumption_type <- factor(df.consumption$consumption_type, levels = c("food_market", "food_home_production", "food_inkind", "durables_consumption",
                                                                                      "clothing_cleaning_home", "energy", "utilities", "rent", "transportation", "ceremonial_expenses",
                                                                                      "taxes", "other"))

ggplot(df.consumption) + geom_bar(aes(x = consumption_type, weight = average_spending, fill = consumption_type)) +
      theme_light() + theme(legend.position = "none", text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + 
      labs(y = "average_consumption", x = "")
ggsave(paste(rootdir, "/presentation_materials/consumption.png", sep = ""), width = 10, height = 7)

df.hh %>% mutate(food_share = (food_market + food_home_production)/consumption) %>% ggplot() +
  geom_point(aes(x = log(consumption), y = food_share))
```

### Savings and Transfers

```{r}
df.transfers <- df.hh %>% 
  summarize(net_loans = weighted.mean(net_loans, w = wt_hh, na.rm = TRUE),
            net_loan_payments = weighted.mean(net_loan_payments, w = wt_hh, na.rm = TRUE),
            food_inkind = weighted.mean(food_inkind, w = wt_hh, na.rm = TRUE),
            financial_assets = weighted.mean(financial_assets, w = wt_hh, na.rm = TRUE),
            informal_transfers = weighted.mean(inf_transfers, w = wt_hh, na.rm = TRUE) - 
              weighted.mean(inf_transfers_made, w = wt_hh, na.rm = TRUE),
            migration_costs = weighted.mean(migration_costs, w = wt_hh, na.rm = TRUE),
            remittance_income = weighted.mean(remittance_income, w = wt_hh, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "forms_of_saving", values_to = "amount")

df.transfers$forms_of_saving <- factor(df.transfers$forms_of_saving, levels = c("net_loans", "net_loan_payments", "informal_transfers", "food_inkind",
                                                                                "ceremonial_expenses", "migration_costs", "remittance_income",
                                                                                "financial_assets"))

g1 <- ggplot(df.transfers) + geom_bar(aes(x = forms_of_saving, weight = amount, fill = forms_of_saving)) +
      theme_light() + theme(legend.position = "none", text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + 
      labs(y = "Average Amount", x = "")
g1

df.transfers <- df.hh %>% 
  summarize(loans_taken = weighted.mean(net_loans>0, w = wt_hh, na.rm = TRUE),
            loans_made = weighted.mean(net_loans<0, w = wt_hh, na.rm = TRUE),
            net_repayer = weighted.mean(net_loan_payments>0, w = wt_hh, na.rm = TRUE),
            net_collector = weighted.mean(net_loan_payments<0, w = wt_hh, na.rm = TRUE),
            food_inkind = weighted.mean(food_inkind>0, w = wt_hh, na.rm = TRUE),
            financial_assets = weighted.mean(financial_assets>0, w = wt_hh, na.rm = TRUE),
            inf_transfer_rec = weighted.mean(inf_transfers - inf_transfers_made>0, w = wt_hh, na.rm = TRUE),
            inf_transfer_made = weighted.mean(inf_transfers - inf_transfers_made<0, w = wt_hh, na.rm = TRUE),
            migration_costs = weighted.mean(migration_costs>0, w = wt_hh, na.rm = TRUE),
            remittance_income = weighted.mean(remittance_income>0, w = wt_hh, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "forms_of_saving", values_to = "fraction_of_hhs")

df.transfers$forms_of_saving <- factor(df.transfers$forms_of_saving, levels = c("loans_taken", "loans_made", "net_repayer", "net_collector",
                                                                                "inf_transfer_rec", "inf_transfer_made", "food_inkind",
                                                                                "migration_costs", "remittance_income",
                                                                                "financial_assets"))

g2 <- ggplot(df.transfers) + geom_bar(aes(x = forms_of_saving, weight = fraction_of_hhs, fill = forms_of_saving)) +
      theme_light() + theme(legend.position = "none", text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + 
      labs(y = "Fraction of HHs", x = "")
g2
cowplot::plot_grid(g2, g1)
ggsave(paste(rootdir, "/presentation_materials/savingtransfers.png", sep = ""), width = 10, height = 7)

ggplot(df.hh) +
  geom_histogram(aes(x = imputed_bufferstock)) + theme_bw() + xlim(-1.5e6, 1.5e6)
```

### experienced shocks

```{r}
df.shocks <- df.hh %>%
  group_by(wave) %>%
  summarize(quake = weighted.mean(quake, w = wt_hh, na.rm = TRUE),
            riot = weighted.mean(riot, w = wt_hh, na.rm = TRUE),
            price_shock = weighted.mean(price_shock, w = wt_hh, na.rm = TRUE),
            livestock_farm_shock = weighted.mean(livestock_farm_shock, w = wt_hh, na.rm = TRUE),
            illness_injury_shock = weighted.mean(illness_injury_shock, w = wt_hh, na.rm = TRUE),
            job_default_shock = weighted.mean(job_default_shock, w = wt_hh, na.rm = TRUE),
            violence_shock = weighted.mean(violence_shock, w = wt_hh, na.rm = TRUE),
            other_nat_disaster = weighted.mean(other_nat_disaster, w = wt_hh, na.rm = TRUE),
            quake_aid = weighted.mean(quake_aid_bin, w = wt_hh, na.rm = TRUE)) %>%
  pivot_longer(-wave, names_to = "shock_type", values_to = "fraction_of_hh")

g1 <- ggplot(df.shocks) +
  geom_col(aes(x = shock_type, y = fraction_of_hh, group = as.factor(wave), fill = as.factor(wave)), position = "dodge") +
  scale_fill_viridis_d() +
  theme_light() + labs(fill = "wave", x = "") + theme(legend.position = "none", text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1))

df.shocks <- df.hh %>%
  group_by(wave) %>%
  summarize(quake = weighted.mean(quake_losses, w = wt_hh*quake, na.rm = TRUE),
            riot = weighted.mean(riot_losses, w = wt_hh*riot, na.rm = TRUE),
            price_shock = weighted.mean(price_shock_losses, w = wt_hh*price_shock, na.rm = TRUE),
            livestock_farm_shock = weighted.mean(livestock_farm_losses, w = wt_hh*livestock_farm_shock, na.rm = TRUE),
            illness_injury_shock = weighted.mean(illness_injury_losses, w = wt_hh*illness_injury_shock, na.rm = TRUE),
            job_default_shock = weighted.mean(job_default_losses, w = wt_hh*job_default_shock, na.rm = TRUE),
            violence_shock = weighted.mean(violence_losses, w = wt_hh*violence_shock, na.rm = TRUE),
            other_nat_disaster = weighted.mean(other_nat_disaster_losses, w = wt_hh*other_nat_disaster, na.rm = TRUE),
            quake_aid = weighted.mean(quake_aid, w = wt_hh*quake_aid_bin, na.rm = TRUE)) %>%
  pivot_longer(-wave, names_to = "shock_type", values_to = "reported_losses")

g2 <- ggplot(df.shocks) +
  geom_col(aes(x = shock_type, y = reported_losses, group = as.factor(wave), fill = as.factor(wave)), position = "dodge") +
  scale_fill_viridis_d() +
  theme_light() + labs(fill = "wave", y = "reported_losses | shock", x = "") + 
  theme(text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1))

plot_grid(g1, g2, nrow = 1, rel_widths = c(4/9, 5/9))
ggsave(paste(rootdir, "/presentation_materials/shocks.png", sep = ""), width = 10, height = 7)
```

### Migration

```{r, message = FALSE, warning = FALSE, echo = FALSE}
df.migr <- df.hh %>%
  group_by(tot_hhmembers) %>%
  summarize(migrants = mean(n_migrants, na.rm = TRUE),
            n = n())

ggplot(filter(df.migr, tot_hhmembers < 15)) +
  geom_col(aes(x = tot_hhmembers, y = migrants, fill = tot_hhmembers)) +
  scale_fill_viridis_c() + theme_light() + theme(legend.position = "none")


print("fraction of hhs with migrant")
sum(df.hh$wt_hh[df.hh$wave==1 & df.hh$n_migrants > 0])/sum(df.hh$wt_hh[df.hh$wave==1])
sum(df.hh$wt_hh[df.hh$wave==2 & df.hh$n_migrants > 0])/sum(df.hh$wt_hh[df.hh$wave==2])
sum(df.hh$wt_hh[df.hh$wave==3 & df.hh$n_migrants > 0])/sum(df.hh$wt_hh[df.hh$wave==3])

print("avg # of migrants in hhs conditional on at least 1")
weighted.mean(df.hh$n_migrants[df.hh$wave==1 & df.hh$n_migrants>0], w = df.hh$wt_hh[df.hh$wave==1 & df.hh$n_migrants>0])
weighted.mean(df.hh$n_migrants[df.hh$wave==2 & df.hh$n_migrants>0], w = df.hh$wt_hh[df.hh$wave==2 & df.hh$n_migrants>0])
weighted.mean(df.hh$n_migrants[df.hh$wave==3 & df.hh$n_migrants>0], w = df.hh$wt_hh[df.hh$wave==3 & df.hh$n_migrants>0])

print("fraction overseas")
sum(df.hh$migrants_overseas[df.hh$wave==1]*df.hh$wt_hh[df.hh$wave==1])/sum(df.hh$n_migrants[df.hh$wave==1]*df.hh$wt_hh[df.hh$wave==1])
sum(df.hh$migrants_overseas[df.hh$wave==2]*df.hh$wt_hh[df.hh$wave==2])/sum(df.hh$n_migrants[df.hh$wave==2]*df.hh$wt_hh[df.hh$wave==2])
sum(df.hh$migrants_overseas[df.hh$wave==3]*df.hh$wt_hh[df.hh$wave==3])/sum(df.hh$n_migrants[df.hh$wave==3]*df.hh$wt_hh[df.hh$wave==3])

print("fraction that left more than 1 year/2 years ago")
setwd(paste(rootdir, "/data/NPL_2016-2018_HRVS_v01_M_STATA12/", sep = ""))
folders <- c("Wave 1 - Household", "Wave 2 - Household", "Wave 3 - Household")

for (i in c(1:3)) {
  setwd(folders[i])
  df.11 <- read.dta13("Section_11.dta")
  df.11 <- merge(df.hh[df.hh$wave==i,], df.11, by = "hhid")
  a <- weighted.mean(df.11$s11q03 > 11, w = df.11$wt_hh, na.rm = TRUE)
  b <- weighted.mean(df.11$s11q03 > 23, w = df.11$wt_hh, na.rm = TRUE)
  print(a)
  print(b)
  setwd("..")
}

```
### Coping strategies
Cutting food more than non food suggests maybe some asset smoothing

```{r}
df.coping <- df.hh %>% mutate(asset_sales = if_else(investments - asset_sales<0,1,0),
                              migrate = if_else(migrants_past_year>0,1,0),
                              loans = if_else(loans_taken_past_year>0,1,0),
                              remittances = if_else(remittance_income>0,1,0)) %>%
  group_by(wave) %>%
  summarize(cut_food = mean(cut_food, na.rm = TRUE),
            dissaving = mean(dissaving, na.rm = TRUE),
            cut_nonfood = mean(cut_nonfood, na.rm = TRUE),
            school_interrupt = mean(school_interrupt, na.rm = TRUE),
            asset_sales = mean(asset_sales, na.rm = TRUE),
            child_labor = mean(child_labor, na.rm = TRUE),
            child_wage_labor = mean(child_wage_labor, na.rm = TRUE),
            migration = mean(migrate, na.rm = TRUE),
            loans = mean(loans, na.rm = TRUE),
            remittances = mean(remittances, na.rm = TRUE)) %>%
  pivot_longer(cols = -c("wave"), names_to = "var", values_to = "frac_hh")

df.coping$var <- factor(df.coping$var, levels = c("dissaving", "loans", "asset_sales", "remittances", "migration", "cut_food", "cut_nonfood",
                                                  "school_interrupt", "child_labor", "child_wage_labor"))

ggplot(df.coping) +
  geom_col(aes(x = var, y = frac_hh, group = as.factor(wave), fill = as.factor(wave)), position = "dodge") +
  scale_fill_viridis_d() + theme_light() + labs(x = "", y = "Fraction of households", fill = "Wave") +
  theme(text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1))

ggsave(paste(rootdir, "/presentation_materials/coping.png", sep = ""), width = 10, height = 7)
```


### Mapping district designations: 
https://www.preventionweb.net/files/63268_18moderatelyaffecteddistrictsovervi.pdf 
#### green dots are border districts (<50 km)


```{r}
df.RS <- read_csv(paste(rootdir, "/data/remote_sensing/UF1416_masked.csv", sep = "")) %>%
  mutate(UFchg_100m = UF16_100m_mean - UF14_100m_mean,
         UFchg_250m = UF16_250m_mean - UF14_250m_mean,
         UFchg_500m = UF16_500m_mean - UF14_500m_mean)

df.wards <- merge(df.wards, df.RS[,c("district", "distname", "vdc", "ward", "UFchg_100m", "UFchg_250m", "UFchg_500m")], 
                  by = c("district", "distname", "vdc", "ward"))
```

```{r}
RSmap <- ggplot() +
        geom_sf(data = df.shp) +
        geom_sf(data = df.designations, aes(color = designation, fill = designation), alpha = .3) +
        scale_color_manual(values = c("red", "orange", "yellow", "green", "blue")) +
        scale_fill_manual(values = c("red", "orange", "yellow", "green", "blue")) +
        new_scale_color() +
        geom_sf(data = df.wards, aes(color = UFchg_250m)) + scale_color_gradient2(low = "red", high = "blue") +
        theme_light() + theme(legend.title = element_blank(), axis.text = element_blank())
RSmap
```

FEMA data from: https://www.fema.gov/openfema-data-page/individuals-and-households-program-valid-registrations-v1 

```{r}
library(data.table)
df.fema <- fread(paste(rootdir, "/data/FEMA/ihp.csv", sep = "")) 
  
df.femasum <- df.fema %>%
  mutate(year = year(declarationDate)) %>%
  group_by(year) %>%
  summarize(repair = sum(repairAmount),
            rental = sum(rentalAssistanceAmount),
            replace = sum(replacementAmount),
            other = sum(personalPropertyAmount))

df.femafrac <- transmute(df.femasum, year = year,
                     tot = repair + rental + replace + other,
                     repair = repair/tot,
                     rental = rental/tot,
                     replace = replace/tot,
                     other = other/tot) %>%
  pivot_longer(-year, names_to = "type", values_to = "amt")

df.femasum <- df.femasum %>%
  pivot_longer(-year, names_to = "type", values_to = "amt")

ggplot(filter(df.femafrac, type != "tot")) +
  geom_line(aes(x = year, y = amt, color = type))

ggplot(df.femasum) +
  geom_line(aes(x = year, y = amt, color = type))

ggplot(filter(df.femafrac, type == "tot")) +
  geom_line(aes(x = year, y = amt, color = type))

sum(df.femasum$amt[df.femasum$year>2009 & df.femasum$type=="repair"])/sum(df.femasum$amt[df.femasum$year>2009])
sum(df.femasum$amt[df.femasum$year>2009 & df.femasum$type=="rental"])/sum(df.femasum$amt[df.femasum$year>2009])
sum(df.femasum$amt[df.femasum$year>2009 & df.femasum$type=="replace"])/sum(df.femasum$amt[df.femasum$year>2009])
sum(df.femasum$amt[df.femasum$year>2009 & df.femasum$type=="other"])/sum(df.femasum$amt[df.femasum$year>2009])
```



