---
title: "WB HRVS descriptive"
author: "Matthew Gordon"
date: "7/7/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
rootdir <- dirname(getwd())
```

### Load packages and data

```{r, messages=FALSE, echo=FALSE, warnings=FALSE}
library(tidyverse)
library(sf)
library(fixest)
library(AER)
library(ggnewscale)
library(cowplot)
library(xtable)
library(sandwich)
library(modelsummary)
library(readstata13)
#devtools::install_github("mdgordo/dumbells",ref="master")
library(dumbells)
library(rdrobust)
source(paste(rootdir, "/code/rdhelpers.r", sep = ""))

df.hh <- read_csv(paste(rootdir, "/data/processed/full_panel.csv", sep = ""), guess_max = 7500)
df.hh <- filter(df.hh, !is.na(total_income) & food_consumption>0 & total_income>0)
df <- filter(df.hh, n_waves==3) %>%
  mutate(land_med = if_else(land_qtle %in% c(1,2), 1, 2),
         gorkha_loss_ever = gorkha_loss_ever/1000,
         quake_aid = quake_aid/1000,
         non_quake_aid = non_quake_aid/1000,
         cash_savings = cash_savings/1000,
         NGO_transfers = NGO_transfers/1000,
         remittance_income = remittance_income/1000,
         new_loans_taken = new_loans_taken/1000,
         livestock_purchases = livestock_purchases/1000,
         livestock_sales = livestock_sales/1000,
         land_purchased = land_purchased/1000,
         land_sales = land_sales/1000,
         equip_purchases = equip_purchases/1000,
         equip_sales = equip_sales/1000,
         business_investment = business_investment/1000,
         business_asset_sales = business_asset_sales/1000,
         school_costs = school_costs/1000,
         work_aid_wages = work_aid_wages/1000,
         non_quake_aid = non_quake_aid/1000,
         net_informal = (inf_transfers - inf_transfers_made)/1000,
         financial_assets = financial_assets/1000,
         jewelery = jewelery/1000)
```

### Risk sharing regressions
Income doesnt include remittances/transfers/loans or inputs - zeros dropped
coefficients usually about .2 (see Morten/Townsend)

Heterogeneity

```{r}
risksharing_all <- feols(log(food_consumption) ~ log(total_income) | as.factor(hhid) + as.factor(vdc_yr),
                         data = df, weights = df$wt_hh, vcov = ~strata)

risksharing_hc1 <- feols(log(food_consumption) ~ log(total_income) + log(total_income):caste_recode | as.factor(hhid) + as.factor(vdc_yr),
                         data = df, weights = df$wt_hh, vcov = ~strata)

risksharing_fh1 <- feols(log(food_consumption) ~ log(total_income) + log(total_income):femalehh | as.factor(hhid) + as.factor(vdc_yr),
                         data = df, weights = df$wt_hh, vcov = ~strata)

risksharing_l1 <- feols(log(food_consumption) ~ log(total_income) + log(total_income):as.factor(land_med) | as.factor(hhid) + as.factor(vdc_yr),
                         data = df, weights = df$wt_hh, vcov = ~strata)

risksharing_q1 <- feols(log(food_consumption) ~ log(total_income) + log(total_income):gorkha_hh | as.factor(hhid) + as.factor(vdc_yr),
                         data = df, weights = df$wt_hh, vcov = ~strata)

mods <- list(risksharing_all, risksharing_hc1, risksharing_fh1, risksharing_l1, risksharing_q1)

modelsummary(dvnames(mods), stars = TRUE, gof_omit = "IC|Adj|Within|RMSE")
```


```{r}

risksharing_all <- feols(log(food_consumption) ~ log(total_income) | as.factor(hhid) + as.factor(caste_yr),
                         data = df, weights = df$wt_hh, vcov = ~strata)

risksharing_hc1 <- feols(log(food_consumption) ~ log(total_income) + log(total_income):caste_recode | as.factor(hhid) + as.factor(caste_yr),
                         data = df, weights = df$wt_hh, vcov = ~strata)

risksharing_fh1 <- feols(log(food_consumption) ~ log(total_income) + log(total_income):femalehh | as.factor(hhid) + as.factor(caste_yr),
                         data = df, weights = df$wt_hh, vcov = ~strata)

risksharing_l1 <- feols(log(food_consumption) ~ log(total_income) + log(total_income):as.factor(land_med) | as.factor(hhid) + as.factor(caste_yr),
                         data = df, weights = df$wt_hh, vcov = ~strata)

risksharing_q1 <- feols(log(food_consumption) ~ log(total_income) + log(total_income):gorkha_hh | as.factor(hhid) + as.factor(caste_yr),
                         data = df, weights = df$wt_hh, vcov = ~strata)

mods <- list(risksharing_all, risksharing_hc1, risksharing_fh1, risksharing_l1, risksharing_q1)

modelsummary(dvnames(mods), gof_omit = "IC|Adj|Within|RMSE", stars = TRUE)
```

### Female Headed Households with remittance income

```{r}
weighted.mean(df.hh$remittance_income[df.hh$femalehh==1]>0, df.hh$wt_hh[df.hh$femalehh==1], na.rm = TRUE)
weighted.mean(df.hh$remittance_income[df.hh$femalehh==0]>0, df.hh$wt_hh[df.hh$femalehh==0], na.rm = TRUE)
```

### Rainfall instruments

## First Stage
```{r}
stg1reg <- feols(log(total_income) ~ rainfall_month_7 + rainfall_month_8 + rainfall_month_9 + rainfall_month_10 + 
                  rainfall_month_11 + rainfall_month_12 + rainfall_month_1 + rainfall_month_2 + rainfall_month_3 + 
                  rainfall_month_4 + rainfall_month_5 + rainfall_month_6 | as.factor(hhid),
                data = df, weights = df$wt_hh)

modelsummary(dvnames(stg1reg), stars = TRUE, gof_omit = "IC|Adj|Within|RMSE")
```

```{r}
risksharing_all <- feols(log(food_consumption) ~ 1 | as.factor(hhid) | 
                           log(total_income) ~ rainfall_month_7 + rainfall_month_8 + rainfall_month_9 + rainfall_month_10 + 
                            rainfall_month_11 + rainfall_month_12 + rainfall_month_1 + rainfall_month_2 + rainfall_month_3 + 
                            rainfall_month_4 + rainfall_month_5 + rainfall_month_6,
                        data = df, weights = df$wt_hh)

risksharing_hc1 <- feols(log(food_consumption) ~ 1 | as.factor(hhid) | 
                           log(total_income) + log(total_income):caste_recode ~ rainfall_month_7 + rainfall_month_8 + rainfall_month_9 + rainfall_month_10 + 
                            rainfall_month_11 + rainfall_month_12 + rainfall_month_1 + rainfall_month_2 + rainfall_month_3 + 
                            rainfall_month_4 + rainfall_month_5 + rainfall_month_6 + 
                           caste_recode:(rainfall_month_7 + rainfall_month_8 + rainfall_month_9 + rainfall_month_10 + 
                            rainfall_month_11 + rainfall_month_12 + rainfall_month_1 + rainfall_month_2 + rainfall_month_3 + 
                            rainfall_month_4 + rainfall_month_5 + rainfall_month_6),
                        data = df, weights = df$wt_hh)

risksharing_fh1 <- feols(log(food_consumption) ~ 1 | as.factor(hhid) | 
                           log(total_income) + log(total_income):femalehh ~ rainfall_month_7 + rainfall_month_8 + rainfall_month_9 + rainfall_month_10 + 
                            rainfall_month_11 + rainfall_month_12 + rainfall_month_1 + rainfall_month_2 + rainfall_month_3 + 
                            rainfall_month_4 + rainfall_month_5 + rainfall_month_6 + 
                           femalehh:(rainfall_month_7 + rainfall_month_8 + rainfall_month_9 + rainfall_month_10 + 
                            rainfall_month_11 + rainfall_month_12 + rainfall_month_1 + rainfall_month_2 + rainfall_month_3 + 
                            rainfall_month_4 + rainfall_month_5 + rainfall_month_6),
                        data = df, weights = df$wt_hh)

risksharing_l1 <- feols(log(food_consumption) ~ 1 | as.factor(hhid) | 
                           log(total_income) + log(total_income):as.factor(land_med) ~ rainfall_month_7 + rainfall_month_8 + rainfall_month_9 + rainfall_month_10 + 
                            rainfall_month_11 + rainfall_month_12 + rainfall_month_1 + rainfall_month_2 + rainfall_month_3 + 
                            rainfall_month_4 + rainfall_month_5 + rainfall_month_6 + 
                           as.factor(land_med):(rainfall_month_7 + rainfall_month_8 + rainfall_month_9 + rainfall_month_10 + 
                            rainfall_month_11 + rainfall_month_12 + rainfall_month_1 + rainfall_month_2 + rainfall_month_3 + 
                            rainfall_month_4 + rainfall_month_5 + rainfall_month_6),
                        data = df, weights = df$wt_hh)

risksharing_q1 <- feols(log(food_consumption) ~ 1 | as.factor(hhid) | 
                           log(total_income) + log(total_income):gorkha_hh ~ rainfall_month_7 + rainfall_month_8 + rainfall_month_9 + rainfall_month_10 + 
                            rainfall_month_11 + rainfall_month_12 + rainfall_month_1 + rainfall_month_2 + rainfall_month_3 + 
                            rainfall_month_4 + rainfall_month_5 + rainfall_month_6 + 
                           gorkha_hh:(rainfall_month_7 + rainfall_month_8 + rainfall_month_9 + rainfall_month_10 + 
                            rainfall_month_11 + rainfall_month_12 + rainfall_month_1 + rainfall_month_2 + rainfall_month_3 + 
                            rainfall_month_4 + rainfall_month_5 + rainfall_month_6),
                        data = df, weights = df$wt_hh)

mods <- list(risksharing_all, risksharing_hc1, risksharing_fh1, risksharing_l1, risksharing_q1)

modelsummary(dvnames(mods), stars = TRUE, gof_omit = "IC|Adj|Within|RMSE")
```

### Cyclicality - ways of smoothing- HH FE

```{r}
aidreg <- feols(quake_aid ~ log(total_income) | as.factor(hhid) ,
                    data = df, weights = df$wt_hh, vcov = ~strata)

govreg <- feols(non_quake_aid ~ log(total_income) | as.factor(hhid) ,
                    data = df, weights = df$wt_hh, vcov = ~strata)

ngoreg <- feols(NGO_transfers ~ log(total_income) | as.factor(hhid),
                    data = df, weights = df$wt_hh, vcov = ~strata)

migreg <- feols(migrants_past_year ~ log(total_income) | as.factor(hhid),
                    data = df, weights = df$wt_hh, vcov = ~strata)

remreg2 <- feols(remittance_income ~ log(total_income) | as.factor(hhid),
                    data = df, weights = df$wt_hh, vcov = ~strata)

loanreg2 <- feols(new_loans_taken ~ log(total_income) | as.factor(hhid),
                    data = df, weights = df$wt_hh, vcov = ~strata)

infreg <- feols(net_informal ~ log(total_income) | as.factor(hhid),
                    data = df, weights = df$wt_hh, vcov = ~strata)

finreg <- feols(cash_savings ~ log(total_income) | as.factor(hhid),
                    data = df, weights = df$wt_hh, vcov = ~strata)

mods <- list(aidreg, ngoreg, govreg, infreg, finreg, remreg2, migreg, loanreg2)

modelsummary(dvnames(mods), gof_omit = "IC|Adj|Within|RMSE", stars = TRUE)
```


### Progressivity - land value - VDC-YR FE

```{r}
caidregvdc <- feols(quake_aid ~ as.factor(land_med) | as.factor(vdc_yr),
                    data = df, weights = df$wt_hh, vcov = ~strata)

cpubtransregvdc2 <- feols(non_quake_aid ~ as.factor(land_med) | as.factor(vdc_yr),
                    data = df, weights = df$wt_hh, vcov = ~strata)

cngoregvdc <- feols(NGO_transfers ~ as.factor(land_med) | as.factor(vdc_yr),
                    data = df, weights = df$wt_hh, vcov = ~strata)

cinftransregvdc <- feols(net_informal ~ as.factor(land_med) | as.factor(vdc_yr),
                    data = df, weights = df$wt_hh, vcov = ~strata)

cmigregvdc <- feols(migrants_past_year ~ as.factor(land_med) | as.factor(vdc_yr),
                    data = df, weights = df$wt_hh, vcov = ~strata)

cremregvdc <- feols(remittance_income ~ as.factor(land_med) | as.factor(vdc_yr),
                    data = df, weights = df$wt_hh, vcov = ~strata)

cloanregvdc <- feols(new_loans_taken ~ as.factor(land_med) | as.factor(vdc_yr),
                    data = df, weights = df$wt_hh, vcov = ~strata)

cpubtransregvdc <- feols(cash_savings ~ as.factor(land_med) | as.factor(vdc_yr),
                    data = df, weights = df$wt_hh, vcov = ~strata)

mods <- list(caidregvdc, cngoregvdc, cpubtransregvdc2, cinftransregvdc, cpubtransregvdc, cremregvdc, cmigregvdc, cloanregvdc)

modelsummary(dvnames(mods), gof_omit = "IC|Adj|Within|RMSE", stars = TRUE)
```


#### Summary Stats

```{r}
dfsum <- df.hh[,c("consumption", "food_consumption", "total_income", "productive_assets", "investments", "jewelery", "school_costs",
              "home_value", "home_investment", "years_ago_built", 
              "currentlyliving", "n_migrants", "migrants_past_year", "migrants_overseas", "femalehh", "cash_savings", "remittance_income", 
              "new_loans_taken", "loans_made_past_year", "implied_default", 
              "skipped_meal", "aid_total", "received_aid", 
              "NGO_transfers", "pub_transfers", "inf_transfers", "gorkha_hh", "gorkha_loss_ever")]

xtabwts <- sumstats.wtd(dfsum, df.hh$wt_hh, d = 2, labs = c("Consumption", "Food Consumption", "Income", "Productive Assets", 
                              "Investments", "Jewelery", "School Costs", "Home Value", "Home Investment", "Age of House", 
                              "Household Members", "Connected Migrants", "Migrants Past Year", 
                              "Overseas Migrants", "Female Headed(%)", "Cash Savings",
                              "Remittance Income",  "Loans Taken Past Year", "Loans Made Past Year", "Default(%)",
                              "Skipped Meal(%)", "Earthquake Aid", "Earthquake Aid(%)", "NGO Aid", 
                              "Public Transfers", "Informal Transfers", "Earthquake Losses (%)", "Earthquake Losses"))
print(xtabwts, include.rownames = FALSE)

weighted.mean(df.hh$n_migrants > 0, df.hh$wt_hh)
weighted.mean(df.hh$migrants_overseas, df.hh$wt_hh)/weighted.mean(df.hh$n_migrants, df.hh$wt_hh)
weighted.mean(df.hh$migrants_past_year, df.hh$wt_hh)/weighted.mean(df.hh$n_migrants, df.hh$wt_hh)
weighted.mean(df.hh$skipped_meal[df.hh$wave==1], df.hh$wt_hh[df.hh$wave==1])
weighted.mean(df.hh$skipped_meal[df.hh$wave==2], df.hh$wt_hh[df.hh$wave==2])
weighted.mean(df.hh$skipped_meal[df.hh$wave==3], df.hh$wt_hh[df.hh$wave==3])
```

```{r}
aidtab <- df.hh %>%
  group_by(wave, quake_aid) %>%
  summarize(n = n())

ggplot(filter(aidtab, between(quake_aid, 1, 250000))) +
  geom_col(aes(x = as.factor(quake_aid/1000), y = n, fill = as.factor(wave), group = as.factor(wave)), position = "dodge") +
  theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), text = element_text(size = 20)) + 
  labs(x = "Aid (000s NPR)", fill = "Wave")
ggsave(paste(rootdir, "/presentation_materials/aid_hist.png", sep = ""), width = 10, height = 7)

disttab <- df.hh %>%
  group_by(designation) %>%
  summarize(affected_hhs = mean(gorkha_hh, na.rm = TRUE)*10e4,
            avg_losses = mean(quake_losses, na.rm = TRUE)) %>%
  pivot_longer(-designation, names_to = "var", values_to = "val")
disttab$designation <- factor(disttab$designation, levels = c("severe", "crisis", "heavy", "hit", "slight", "none"))
disttab$var <- factor(disttab$var, levels = c("avg_losses", "affected_hhs"))

ggplot(disttab) +
  geom_col(aes(x = designation, y = val, fill = var, group = var), position = "dodge") +
  theme_bw() + theme(text = element_text(size = 20)) + 
  labs(x = "", fill = "") + scale_y_continuous("Quake Losses (NPR)", label = scales::comma, sec.axis = sec_axis(~ ./10e4, name = "Affected HHs")) +
  scale_fill_discrete(labels = c("Average Loss", "Fraction Affected"))
ggsave(paste(rootdir, "/presentation_materials/distdesignations.png", sep = ""), width = 12, height = 7)

disttabfine <- df.hh %>%
  group_by(district, designation) %>%
  summarize(affected_hhs = mean(gorkha_hh, na.rm = TRUE),
            avg_losses = mean(quake_losses, na.rm = TRUE))

df.loss <- read.dta13(paste(rootdir, "/data/NPL_2016-2018_HRVS_v01_M_STATA12/Wave 1 - Household/Section_15a.dta", sep = "")) %>%
  filter(shockid %in% c("Earthquake", "Landslide") & s15q02!=4) %>%
  group_by(s15q02) %>%
  summarize(loss_type = n()*200,
            loss_amt = mean(s15q03, na.rm = TRUE)) %>%
  pivot_longer(-s15q02, names_to = "var", values_to = "val")

ggplot(df.loss) +
  geom_col(aes(x = as.factor(s15q02), y = val, fill = var, group = var), position = "dodge") +
  theme_bw() + theme(text = element_text(size = 20)) + 
  labs(x = "", fill = "") + scale_y_continuous("Quake Losses (NPR)", label = scales::comma, sec.axis = sec_axis(~ ./200, name = "Number of HHs")) +
  scale_fill_discrete(labels = c("Loss Amount", "Number of HHs")) + scale_x_discrete(labels = c("Income", "Assets", "Both"))
ggsave(paste(rootdir, "/presentation_materials/typeofloss.png", sep = ""), width = 12, height = 7)
```


### Quake effects on income 

```{r}
qinc <- lm(log(total_income) ~ gorkha_loss_ever,
              data = df, weights = df$wt_hh)

qincfe <- lm(log(total_income) ~ gorkha_loss_ever + as.factor(vdc_code) + as.factor(wave),
              data = df, weights = df$wt_hh)

qinciv2 <- ivreg(log(total_income) ~ gorkha_loss_ever | shake_pga,
              data = df, weights = df$wt_hh)

qinciv3 <- ivreg(log(total_income) ~ gorkha_loss_ever + as.factor(district)| shake_pga + as.factor(district) + as.factor(wave),
              data = df, weights = df$wt_hh)

qinc4 <- ivreg(log(total_income) ~ gorkha_loss_ever + as.factor(district) + as.factor(wave) + log(elevation) + log(distance_epicenter) | 
              shake_pga + as.factor(district) + as.factor(wave) + log(elevation) + log(distance_epicenter),
              data = df, weights = df$wt_hh)

qinc1 <- lm(log(total_income) ~ gorkha_loss_ever,
              data = df, weights = df$wt_hh, subset = df$wave==1)

qincfe1 <- lm(log(total_income) ~ gorkha_loss_ever + as.factor(vdc_code),
              data = df, weights = df$wt_hh, subset = df$wave==1)

qinciv21 <- ivreg(log(total_income) ~ gorkha_loss_ever | shake_pga,
              data = df, weights = df$wt_hh, subset = df$wave==1)

qinciv31 <- ivreg(log(total_income) ~ gorkha_loss_ever + as.factor(district)| shake_pga + as.factor(district),
              data = df, weights = df$wt_hh, subset = df$wave==1)

qinc41 <- ivreg(log(total_income) ~ gorkha_loss_ever + as.factor(district) + log(elevation) + log(distance_epicenter) | 
              shake_pga + as.factor(district) + log(elevation) + log(distance_epicenter),
              data = df, weights = df$wt_hh, subset = df$wave==1) 

mods <- list(qinc, qincfe, qinciv2, qinciv3, qinc4)

modelsummary(dvnames(mods), gof_omit = "IC|Within|Adj|RMSE|F|Lik", stars = TRUE, coef_omit = "vdc_code|district|wave", 
            add_rows = data.frame(rbind(c("Fixed Effects", "", "Village + Wave", "", "District + Wave", "District + Wave"),
                                        c("IV", "", "", "Shake Intensity", "Shake Intensity", "Shake Intensity"),
                                        c("Wave", rep("All", 5)))))

mods <- list(qinc1, qincfe1, qinciv21, qinciv31, qinc41)

modelsummary(dvnames(mods), gof_omit = "IC|Within|Adj|RMSE|F|Lik", stars = TRUE, coef_omit = "vdc_code|district", 
            add_rows = data.frame(rbind(c("Fixed Effects", "", "Village", "", "District", "District"),
                                        c("IV", "", "", "Shake Intensity", "Shake Intensity", "Shake Intensity"),
                                        c("Wave", rep("1", 5)))))


weighted.mean(df$gorkha_loss_ever[df$wave==1 & df$gorkha_loss_ever>0], df$wt_hh[df$wave==1 & df$gorkha_loss_ever>0])
```


### Is Housing Value a good proxy for Earthquake damages?

```{r}
df$h1 <- log(df$home_value + 1) ## model summary sometimes hangs when you put log+1 in the formula

qinc <- lm(h1 ~ gorkha_loss_ever,
              data = df, weights = df$wt_hh)

qincfe <- lm(h1 ~ gorkha_loss_ever + as.factor(vdc_code) + as.factor(wave),
              data = df, weights = df$wt_hh)

qinciv2 <- ivreg(h1 ~ gorkha_loss_ever | shake_pga,
              data = df, weights = df$wt_hh)

qinciv3 <- ivreg(h1 ~ gorkha_loss_ever + as.factor(district)| shake_pga + as.factor(district) + as.factor(wave),
              data = df, weights = df$wt_hh)

qinc4 <- ivreg(h1 ~ gorkha_loss_ever + as.factor(district) + as.factor(wave) + log(elevation) + log(distance_epicenter) | 
              shake_pga + as.factor(district) + as.factor(wave) + log(elevation) + log(distance_epicenter),
              data = df, weights = df$wt_hh)

qinc1 <- lm(h1 ~ gorkha_loss_ever,
              data = df, weights = df$wt_hh, subset = df$wave==1)

qincfe1 <- lm(h1 ~ gorkha_loss_ever + as.factor(vdc_code),
              data = df, weights = df$wt_hh, subset = df$wave==1)

qinciv21 <- ivreg(h1 ~ gorkha_loss_ever | shake_pga,
              data = df, weights = df$wt_hh, subset = df$wave==1)

qinciv31 <- ivreg(h1 ~ gorkha_loss_ever + as.factor(district)| shake_pga + as.factor(district),
              data = df, weights = df$wt_hh, subset = df$wave==1)

qinc41 <- ivreg(h1 ~ gorkha_loss_ever + as.factor(district) + log(elevation) + log(distance_epicenter) | 
              shake_pga + as.factor(district) + log(elevation) + log(distance_epicenter),
              data = df, weights = df$wt_hh, subset = df$wave==1) 

mods <- list(qinc, qincfe, qinciv2, qinciv3, qinc4)

modelsummary(dvnames(mods), gof_omit = "IC|Within|Adj|RMSE|F|Lik", coef_omit = "vdc_code|district", stars = TRUE,
            add_rows = data.frame(rbind(c("Fixed Effects", "", "Village", "", "District", "District"),
                                        c("IV", "", "", "Shake Intensity", "Shake Intensity", "Shake Intensity"),
                                        c("Wave", rep("All", 5)))))

mods <- list(qinc1, qincfe1, qinciv21, qinciv31, qinc41)

modelsummary(dvnames(mods), gof_omit = "IC|Within|Adj|RMSE|F|Lik", coef_omit = "vdc_code|district", stars = TRUE,
            add_rows = data.frame(rbind(c("Fixed Effects", "", "Village", "", "District", "District"),
                                        c("IV", "", "", "Shake Intensity", "Shake Intensity", "Shake Intensity"),
                                        c("Wave", rep("1", 5)))))


weighted.mean(df$gorkha_loss_ever[df$wave==1 & df$gorkha_loss_ever>0], df$wt_hh[df$wave==1 & df$gorkha_loss_ever>0])
```

```{r} 
df.housing <- filter(df.hh, wave==1) %>%
  mutate(hstock = home_value/avg_income) %>%
  group_by(gorkha_hh) %>%
  summarize(hstock = mean(hstock, na.rm = TRUE),
            hval = mean(home_value))

ggplot(df.housing, aes(x = as.factor(gorkha_hh), y = hstock)) + 
  geom_col(fill = "darkorchid1") + labs(x = "Gorkha HH", y = "Housing Stock/Avg Income") + 
  theme_bw()

mean(df.hh$home_value[df.hh$wave==1 & df.hh$gorkha_hh==1])/mean(df.hh$home_value[df.hh$wave==1 & df.hh$gorkha_hh==0])

ggsave(paste(rootdir, "/presentation_materials/hstock_aid.png", sep = ""), width = 12, height = 7)

df.hh %>% 
  group_by(hhid) %>%
  summarize(n_invest = sum(home_investment > 0, na.rm = TRUE)) %>%
  group_by(n_invest) %>%
  summarize(n = n())
```

### Housing depreciation

```{r}
depreg1 <- feols(log(home_value) ~ years_ago_built | as.factor(hhid) + as.factor(wave),
                 data = df, weights = df$wt_hh, vcov = ~strata)

depreg1a <- feols(h1 ~ years_ago_built | as.factor(hhid) + as.factor(wave),
                 data = df, weights = df$wt_hh, vcov = ~strata)

depreg1b <- fepois(home_value ~ years_ago_built | as.factor(hhid) + as.factor(wave),
                 data = df, weights = df$wt_hh, vcov = ~strata)

depreg2 <- feols(log(home_value) ~ years_ago_built + home_investment| as.factor(hhid) + as.factor(wave),
                 data = df, weights = df$wt_hh, vcov = ~strata)

depreg2a <- feols(h1 ~ years_ago_built + home_investment | as.factor(hhid) + as.factor(wave),
                 data = df, weights = df$wt_hh, vcov = ~strata)

depreg2b <- fepois(home_value ~ years_ago_built + home_investment | as.factor(hhid) + as.factor(wave),
                 data = df, weights = df$wt_hh, vcov = ~strata)

depreg3 <- feols(log(home_value) ~ years_ago_built + home_investment + 
                   wave + as.factor(district):wave | as.factor(hhid),
                 data = df, weights = df$wt_hh, vcov = ~strata)

depreg3a <- feols(h1 ~ years_ago_built + home_investment + 
                   wave + as.factor(district):wave | as.factor(hhid),
                 data = df, weights = df$wt_hh, vcov = ~strata)

depreg3b <- fepois(home_value ~ years_ago_built + home_investment +
                   wave + as.factor(district):wave | as.factor(hhid),
                 data = df, weights = df$wt_hh, vcov = ~strata)

mods <- list(depreg1, depreg1a, depreg1b, depreg2, depreg2a, depreg2b, depreg3, depreg3a, depreg3b)

modelsummary(mods, gof_omit = "IC|Within|Adj|RMSE", stars = TRUE, coef_omit = "district")
```


### sources of income
~ 100 nepali rupees = 1 dollar in 2016
Avg income ~ $2000
Best interpreted as fraction with source of income in a given year - eg total # of hhs that get a remittance over the study period is 48%, but only about 34% in a given year

```{r}
df.inc <- df.hh %>% 
  mutate(home_food_production = if_else(food_home_production > 0, 1, 0),
         agriculture = if_else(wet_ag_sales >0 | dry_ag_sales > 0, 1, 0),
         livestock = if_else(livestock_income > 0, 1, 0),
         business = if_else(business_revenues >0 ,1, 0),
         wages = if_else(annual_wages > 0, 1, 0),
         rental = if_else(landrents > 0 | equip_rental_income > 0 | cap_gains > 0 | rent_earned > 0, 1, 0),
         remittance = if_else(remittance_income > 0, 1, 0),
         informal = if_else(inf_transfers > 0, 1, 0),
         NGO_aid = if_else(NGO_transfers > 0, 1, 0),
         pub_transfers = if_else(pub_transfers > 0, 1, 0)) %>%
  summarize(home_food_production = weighted.mean(home_food_production, w = wt_hh, na.rm = TRUE),
            agriculture = weighted.mean(agriculture, w = wt_hh, na.rm = TRUE),
            livestock = weighted.mean(livestock, w = wt_hh, na.rm = TRUE),
            business = weighted.mean(business, w = wt_hh, na.rm = TRUE),
            wages = weighted.mean(wages, w = wt_hh, na.rm = TRUE),
            rental = weighted.mean(rental, w = wt_hh, na.rm = TRUE),
            remittance = weighted.mean(remittance, w = wt_hh, na.rm = TRUE),
            quake_aid = weighted.mean(received_aid, w = wt_hh, na.rm = TRUE),
            pub_aid = weighted.mean(pub_transfers, w = wt_hh, na.rm = TRUE),
            inf_aid = weighted.mean(informal, w = wt_hh, na.rm = TRUE),
            NGO_aid = weighted.mean(NGO_aid, w = wt_hh, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "source", values_to = "fraction")

df.inc$source <- factor(df.inc$source, levels = c("home_food_production", "agriculture", "livestock", "wages", "business", "rental", 
                                                  "quake_aid", "remittance", "pub_aid", "inf_aid", "NGO_aid"))

g1 <- ggplot(df.inc) + geom_bar(aes(x = source, weight = fraction, fill = source)) +
      theme_light() + theme(legend.position = "none", text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + 
      labs(y = "fraction of HHs with income", x = "") +
      scale_x_discrete(labels = c("Home Production", "Agriculture", "Livestock",
                                  "Wages", "Business", "Rental", "Quake Aid",
                                  "Remittances", "Govt Aid", "Informal Gifts", "NGO Aid"))

df.inc <- df.hh %>% 
  mutate(home_food_productionwt = if_else(food_home_production > 0, 1, 0)*wt_hh,
         agriculturewt = if_else(wet_ag_sales >0 | dry_ag_sales > 0, 1, 0)*wt_hh,
         livestockwt = if_else(livestock_income > 0, 1, 0)*wt_hh,
         businesswt = if_else(business_revenues >0 ,1, 0)*wt_hh,
         wageswt = if_else(annual_wages > 0, 1, 0)*wt_hh,
         rentalwt = if_else(landrents > 0 | equip_rental_income > 0 | cap_gains > 0 | rent_earned > 0, 1, 0)*wt_hh,
         remittancewt = if_else(remittance_income > 0, 1, 0)*wt_hh,
         pubwt = if_else(pub_transfers > 0, 1, 0)*wt_hh,
         infwt = if_else(inf_transfers > 0, 1, 0)*wt_hh,
         ngowt = if_else(NGO_transfers > 0, 1, 0)*wt_hh) %>%
  summarize(home_food_production = 52*weighted.mean(food_home_production, w = home_food_productionwt, na.rm = TRUE),
            agriculture = weighted.mean(x = (wet_ag_sales + dry_ag_sales), w = agriculturewt, na.rm = TRUE),
            ag_costs = -1*weighted.mean(ag_costs, w = agriculturewt, na.rm = TRUE),
            landrent_paid = -1*weighted.mean(x = (landrent_paid_cash + landrent_paid_inkind), w = agriculturewt, na.rm = TRUE),
            livestock = weighted.mean(livestock_income, w = livestockwt, na.rm = TRUE),
            livestock_costs = -1*weighted.mean(livestock_costs, w = livestockwt, na.rm = TRUE),
            business = weighted.mean(business_revenues, w = businesswt, na.rm = TRUE),
            business_costs = -1*weighted.mean(business_expenses, w = businesswt, na.rm = TRUE),
            wages = weighted.mean(annual_wages, w = wageswt, na.rm = TRUE),
            rental = weighted.mean(x = (landrents + equip_rental_income + cap_gains + rent_earned), w = rentalwt, na.rm = TRUE),
            remittance = weighted.mean(remittance_income, w = remittancewt, na.rm = TRUE),
            quake_aid = weighted.mean(aid_total, w = received_aid*wt_hh, na.rm = TRUE),
            pub_aid = weighted.mean(pub_transfers, w = pubwt, na.rm = TRUE),
            inf_aid = weighted.mean(inf_transfers, w = infwt, na.rm = TRUE),
            NGO_aid = weighted.mean(NGO_transfers, w = ngowt, na.rm = TRUE),
            income = weighted.mean(total_income, w = wt_hh, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "source", values_to = "fraction")

df.inc$source <- factor(df.inc$source, levels = c("home_food_production", "agriculture", "ag_costs", "landrent_paid", "livestock", "livestock_costs", 
                                                  "wages", "business", "business_costs", "rental", "quake_aid", "remittance", "pub_aid", "inf_aid", "NGO_aid", "income"))

g2 <- ggplot(df.inc) + geom_bar(aes(x = source, weight = fraction, fill = source)) +
      theme_light() + theme(legend.position = "none", text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + 
      labs(y = "Avg Income | source > 0", x = "") + scale_y_continuous(labels = scales::comma) +
      scale_x_discrete(labels = c("Home Production", "Agriculture", "Ag Costs", "Land Rent Paid", "Livestock", "Livestock Costs",
                                  "Wages", "Business", "Business Costs", "Rental", "Quake Aid",
                                  "Remittances", "Govt Aid", "Informal Gifts", "NGO Aid", "Total Income"))

plot_grid(g1, g2, nrow = 1, rel_widths = c(4/9, 5/9))
ggsave(paste(rootdir, "/presentation_materials/income.png", sep = ""), width = 10, height = 7)
```

### types of assets

```{r}
df.assets <- df.hh %>% 
  mutate(home_value = if_else(home_value > 0, 1, 0),
         durables_stock = if_else(durables_stock > 0, 1, 0),
         landvalue = if_else(landvalue > 0, 1, 0),
         equip_stock = if_else(equip_stock >0 ,1, 0),
         livestock_value = if_else(livestock_value > 0, 1, 0),
         financial_assets = if_else(financial_assets > 0, 1, 0),
         savings_group = if_else(savings_group > 0, 1, 0),
         insurance_assets = if_else(insurance_assets > 0, 1, 0)) %>%
  summarize(home_value = weighted.mean(home_value, w = wt_hh, na.rm = TRUE),
            durables_stock = weighted.mean(durables_stock, w = wt_hh, na.rm = TRUE),
            landvalue = weighted.mean(landvalue, w = wt_hh, na.rm = TRUE),
            equip_stock = weighted.mean(equip_stock, w = wt_hh, na.rm = TRUE),
            livestock_value = weighted.mean(livestock_value, w = wt_hh, na.rm = TRUE),
            financial_assets = weighted.mean(financial_assets, w = wt_hh, na.rm = TRUE),
            savings_group = weighted.mean(savings_group, w = wt_hh, na.rm = TRUE),
            insurance_assets = weighted.mean(insurance_assets, w = wt_hh, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "asset_type", values_to = "fraction")

g1 <- ggplot(df.assets) + geom_bar(aes(x = asset_type, weight = fraction, fill = asset_type)) +
      theme_light() + theme(legend.position = "none", text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + 
      labs(y = "fraction of HHs with asset", x = "") +
      scale_x_discrete(labels = c("Durables", "Ag Equipment", "Cash and Savings", "Housing", "Insurance", "Land",
                                  "Livestock", "Savings Group"))

df.assets <- df.hh %>% 
  mutate(home_valuewt = if_else(home_value > 0, 1, 0)*wt_hh,
         durables_stockwt = if_else(durables_stock > 0, 1, 0)*wt_hh,
         landvaluewt = if_else(landvalue > 0, 1, 0)*wt_hh,
         equip_stockwt = if_else(equip_stock >0 ,1, 0)*wt_hh,
         livestock_valuewt = if_else(livestock_value > 0, 1, 0)*wt_hh,
         financial_assetswt = if_else(financial_assets > 0, 1, 0)*wt_hh,
         savings_groupwt = if_else(savings_group > 0, 1, 0)*wt_hh,
         insurance_assetswt = if_else(insurance_assets > 0, 1, 0)*wt_hh) %>%
  summarize(home_value = weighted.mean(home_value, w = home_valuewt, na.rm = TRUE),
            durables_stock = weighted.mean(durables_stock, w = durables_stockwt, na.rm = TRUE),
            landvalue = weighted.mean(landvalue, w = landvaluewt, na.rm = TRUE),
            equip_stock = weighted.mean(equip_stock, w = equip_stockwt, na.rm = TRUE),
            livestock_value = weighted.mean(livestock_value, w = livestock_valuewt, na.rm = TRUE),
            financial_assets = weighted.mean(financial_assets, w = financial_assetswt, na.rm = TRUE),
            savings_group = weighted.mean(savings_group, w = savings_groupwt, na.rm = TRUE),
            insurance_assets = weighted.mean(insurance_assets, w = insurance_assetswt, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "asset_type", values_to = "fraction")

g2 <- ggplot(df.assets) + geom_bar(aes(x = asset_type, weight = fraction, fill = asset_type)) +
      theme_light() + theme(legend.position = "none", text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + 
      labs(y = "Avg Value | asset_type > 0", x = "") + scale_y_continuous(labels = scales::comma) +
      scale_x_discrete(labels = c("Durables", "Ag Equipment", "Cash and Savings", "Housing", "Insurance", "Land",
                                  "Livestock", "Savings Group"))

plot_grid(g1, g2, nrow = 1, rel_widths = c(4/9, 5/9))
ggsave(paste(rootdir, "/presentation_materials/assets.png", sep = ""), width = 10, height = 7)
```

### Investments
## note about half of loans come from and go to friends and relatives

```{r}
df.investments <- df.hh %>% 
  mutate(land_purchased = if_else(land_purchased > 0, 1, 0),
         land_sales = if_else(land_sales > 0, 1, 0),
         livestock_purchases = if_else(livestock_purchases > 0, 1, 0),
         livestock_sales = if_else(livestock_sales >0 ,1, 0),
         equip_purchases = if_else(equip_purchases > 0, 1, 0),
         equip_sales = if_else(equip_sales > 0, 1, 0),
         business_investment = if_else(business_investment > 0, 1, 0),
         business_asset_sales = if_else(business_asset_sales > 0, 1, 0),
         school_costs = if_else(school_costs > 0, 1, 0),
         migration_costs = if_else(migration_costs > 0, 1, 0)) %>%
  summarize(land_purchased = weighted.mean(land_purchased, w = wt_hh, na.rm = TRUE),
            land_sales = weighted.mean(land_sales, w = wt_hh, na.rm = TRUE),
            livestock_purchases = weighted.mean(livestock_purchases, w = wt_hh, na.rm = TRUE),
            livestock_sales = weighted.mean(livestock_sales, w = wt_hh, na.rm = TRUE),
            equip_purchases = weighted.mean(equip_purchases, w = wt_hh, na.rm = TRUE),
            equip_sales = weighted.mean(equip_sales, w = wt_hh, na.rm = TRUE),
            business_investment = weighted.mean(business_investment, w = wt_hh, na.rm = TRUE),
            business_asset_sales = weighted.mean(business_asset_sales, w = wt_hh, na.rm = TRUE),
            school_costs = weighted.mean(school_costs, w = wt_hh, na.rm = TRUE),
            migration_costs = weighted.mean(migration_costs, w = wt_hh, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "investment_type", values_to = "fraction")

g1 <- ggplot(df.investments) + geom_bar(aes(x = investment_type, weight = fraction, fill = investment_type)) +
      theme_light() + theme(legend.position = "none", text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + 
      labs(y = "fraction of HHs making investment", x = "") +
      scale_x_discrete(labels = c("Business Asset Sales", "Business Investment", "Equipment Purchases", "Equipment Sales", 
                                  "Land Purchases", "Land Sales", "Livestock Purchases", "Livestock Sales",
                                  "School Costs", "Migration Costs"))

df.investments <- df.hh %>% 
  mutate(land_purchasedwt = if_else(land_purchased > 0, 1, 0)*wt_hh,
         land_saleswt = if_else(land_sales > 0, 1, 0)*wt_hh,
         livestock_purchaseswt = if_else(livestock_purchases > 0, 1, 0)*wt_hh,
         livestock_saleswt = if_else(livestock_sales >0 ,1, 0)*wt_hh,
         equip_purchaseswt = if_else(equip_purchases > 0, 1, 0)*wt_hh,
         equip_saleswt = if_else(equip_sales > 0, 1, 0)*wt_hh,
         business_investmentwt = if_else(business_investment > 0, 1, 0)*wt_hh,
         business_asset_saleswt = if_else(business_asset_sales > 0, 1, 0)*wt_hh,
         school_costswt = if_else(school_costs > 0, 1, 0)*wt_hh,
         migration_costswt = if_else(migration_costs > 0, 1, 0)*wt_hh) %>%
  summarize(land_purchased = weighted.mean(land_purchased, w = land_purchasedwt, na.rm = TRUE),
            land_sales = weighted.mean(land_sales, w = land_saleswt, na.rm = TRUE),
            livestock_purchases = weighted.mean(livestock_purchases, w = livestock_purchaseswt, na.rm = TRUE),
            livestock_sales = weighted.mean(livestock_sales, w = livestock_saleswt, na.rm = TRUE),
            equip_purchases = weighted.mean(equip_purchases, w = equip_purchaseswt, na.rm = TRUE),
            equip_sales = weighted.mean(equip_sales, w = equip_saleswt, na.rm = TRUE),
            business_investment = weighted.mean(business_investment, w = business_investmentwt, na.rm = TRUE),
            business_asset_sales = weighted.mean(business_asset_sales, w = business_asset_saleswt, na.rm = TRUE),
            school_costs = weighted.mean(school_costs, w = school_costswt, na.rm = TRUE),
            migration_costs = weighted.mean(migration_costs, w = migration_costswt, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "investment_type", values_to = "fraction")

g2 <- ggplot(df.investments) + geom_bar(aes(x = investment_type, weight = fraction, fill = investment_type)) +
      theme_light() + theme(legend.position = "none", text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + 
      labs(y = "Avg Amount | investment > 0", x = "") + scale_y_continuous(labels = scales::comma) +
      scale_x_discrete(labels = c("Business Asset Sales", "Business Investment", "Equipment Purchases", "Equipment Sales", 
                                  "Land Purchases", "Land Sales", "Livestock Purchases", "Livestock Sales",
                                  "School Costs", "Migration Costs"))

plot_grid(g1, g2, nrow = 1, rel_widths = c(4/9, 5/9))
ggsave(paste(rootdir, "/presentation_materials/investments.png", sep = ""), width = 10, height = 7)
```


### Consumption

```{r}
df.consumption <- df.hh %>% 
  mutate(other = entertainment_other + other_expenses + craft_consumption) %>%
  summarize(food_home_production = weighted.mean(food_home_production, w = wt_hh, na.rm = TRUE)*52,
            food_market = weighted.mean(food_market, w = wt_hh, na.rm = TRUE)*52,
            food_inkind = weighted.mean(food_inkind, w = wt_hh, na.rm = TRUE)*52,
            durables_consumption = weighted.mean(durables_consumption, w = wt_hh, na.rm = TRUE),
            energy = weighted.mean(energy, w = wt_hh, na.rm = TRUE),
            utilities = weighted.mean(utilities_paid, w = wt_hh, na.rm = TRUE),
            rent = weighted.mean(rent_paid, w = wt_hh, na.rm = TRUE),
            transportation = weighted.mean(transportation, w = wt_hh, na.rm = TRUE),
            clothing_cleaning_home = weighted.mean(clothing_cleaning_home, w = wt_hh, na.rm = TRUE),
            other = weighted.mean(other, w = wt_hh, na.rm = TRUE),
            ceremonial_expenses = weighted.mean(ceremonial_expenses, w = wt_hh, na.rm = TRUE),
            taxes = weighted.mean(taxes, w = wt_hh, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "consumption_type", values_to = "average_spending")

df.consumption$consumption_type <- factor(df.consumption$consumption_type, levels = c("food_market", "food_home_production", "food_inkind", "durables_consumption",
                                                                                      "clothing_cleaning_home", "energy", "utilities", "rent", "transportation", 
                                                                                      "ceremonial_expenses", "taxes", "other"))

ggplot(df.consumption) + geom_bar(aes(x = consumption_type, weight = average_spending, fill = consumption_type)) +
      theme_light() + theme(legend.position = "none", text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + 
      labs(y = "HH Average Expenditures (NPR)", x = "") + scale_y_continuous(labels = scales::comma) +
      scale_x_discrete(labels = c("Food Purchases", "Home Production", "Food Gifts", "Durables",
                                  "Household Items", "Energy", "Other Utilities", "Rent",
                                  "Transportation", "Ceremonial Expenses", "Taxes", "Other"))
ggsave(paste(rootdir, "/presentation_materials/consumption.png", sep = ""), width = 10, height = 7)

df.hh %>% mutate(food_share = (food_market + food_home_production)/consumption) %>% ggplot() +
  geom_point(aes(x = log(consumption), y = food_share))
```

### Savings

```{r}
df.transfers <- df.hh %>% 
  summarize(new_loans_taken = weighted.mean(new_loans_taken, w = wt_hh, na.rm = TRUE),
            loans_made_past_year = weighted.mean(loans_made_past_year, w = wt_hh, na.rm = TRUE),
            financial_assets = weighted.mean(financial_assets, w = wt_hh, na.rm = TRUE),
            informal_transfers = weighted.mean(inf_transfers, w = wt_hh, na.rm = TRUE) - 
              weighted.mean(inf_transfers_made, w = wt_hh, na.rm = TRUE),
            migration_costs = weighted.mean(migration_costs, w = wt_hh, na.rm = TRUE),
            remittance_income = weighted.mean(remittance_income, w = wt_hh, na.rm = TRUE),
            insurance_assets = weighted.mean(insurance_assets, w = wt_hh, na.rm = TRUE),
            savings_group = weighted.mean(savings_group, w = wt_hh, na.rm = TRUE),
            jewelery = weighted.mean(jewelery, w = wt_hh, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "forms_of_saving", values_to = "amount")

df.transfers$forms_of_saving <- factor(df.transfers$forms_of_saving, levels = c("loans_taken_past_year", "loans_made_past_year", "informal_transfers",
                                                                                "migration_costs", "remittance_income", "financial_assets",
                                                                                "insurance_assets", "savings_group", "jewelery"))

g1 <- ggplot(df.transfers) + geom_bar(aes(x = forms_of_saving, weight = amount, fill = forms_of_saving)) +
      theme_light() + theme(legend.position = "none", text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + 
      labs(y = "Average Amount", x = "") +
      scale_x_discrete(labels = c("Loans Taken", "Loans Made", "Informal Transfers",
                                  "Migration Costs", "Remittance Income", "Financial Assets", "Insurance Assets",
                                  "Savings Group Assets", "Jewelry"))
g1

df.transfers <- df.hh %>% 
  summarize(loans_taken = weighted.mean(new_loans_taken>0, w = wt_hh, na.rm = TRUE),
            loans_made = weighted.mean(loans_made_past_year>0, w = wt_hh, na.rm = TRUE),
            financial_assets = weighted.mean(financial_assets>0, w = wt_hh, na.rm = TRUE),
            inf_transfer_rec = weighted.mean(inf_transfers>0, w = wt_hh, na.rm = TRUE),
            inf_transfer_made = weighted.mean(inf_transfers_made>0, w = wt_hh, na.rm = TRUE),
            migration_costs = weighted.mean(migration_costs>0, w = wt_hh, na.rm = TRUE),
            remittance_income = weighted.mean(remittance_income>0, w = wt_hh, na.rm = TRUE),
            insurance_assets = weighted.mean(insurance_assets>0, w = wt_hh, na.rm = TRUE),
            savings_group = weighted.mean(savings_group>0, w = wt_hh, na.rm = TRUE),
            jewelery = weighted.mean(jewelery>0, w = wt_hh, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "forms_of_saving", values_to = "fraction_of_hhs")

df.transfers$forms_of_saving <- factor(df.transfers$forms_of_saving, levels = c("loans_taken", "loans_made",
                                                                                "inf_transfer_rec", "inf_transfer_made", 
                                                                                "migration_costs", "remittance_income",
                                                                                "financial_assets", "insurance_assets", "savings_group", "jewelery"))

g2 <- ggplot(df.transfers) + geom_bar(aes(x = forms_of_saving, weight = fraction_of_hhs, fill = forms_of_saving)) +
      theme_light() + theme(legend.position = "none", text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + 
      labs(y = "Fraction of HHs", x = "") + scale_y_continuous(labels = scales::comma) +
      scale_x_discrete(labels = c("Loans Taken", "Loans Made", "Informal Transfers Received", "Informal Transfers Made",
                                  "Migration Costs", "Remittance Income", "Financial Assets", "Insurance Assets",
                                  "Savings Group Assets", "Jewelry"))
g2
cowplot::plot_grid(g2, g1)
ggsave(paste(rootdir, "/presentation_materials/savingtransfers.png", sep = ""), width = 10, height = 7)

```

### experienced shocks

```{r}
df.shocks <- df.hh %>%
  group_by(wave) %>%
  summarize(quake = weighted.mean(quake, w = wt_hh, na.rm = TRUE),
            riot = weighted.mean(riot, w = wt_hh, na.rm = TRUE),
            price_shock = weighted.mean(price_shock, w = wt_hh, na.rm = TRUE),
            livestock_farm_shock = weighted.mean(livestock_farm_shock, w = wt_hh, na.rm = TRUE),
            illness_injury_shock = weighted.mean(illness_injury_shock, w = wt_hh, na.rm = TRUE),
            job_default_shock = weighted.mean(job_default_shock, w = wt_hh, na.rm = TRUE),
            violence_shock = weighted.mean(violence_shock, w = wt_hh, na.rm = TRUE),
            other_nat_disaster = weighted.mean(other_nat_disaster, w = wt_hh, na.rm = TRUE),
            quake_aid = weighted.mean(quake_aid_bin, w = wt_hh, na.rm = TRUE)) %>%
  pivot_longer(-wave, names_to = "shock_type", values_to = "fraction_of_hh")

g1 <- ggplot(df.shocks) +
  geom_col(aes(x = shock_type, y = fraction_of_hh, group = as.factor(wave), fill = as.factor(wave)), position = "dodge") +
  scale_fill_viridis_d() +
  theme_light() + labs(fill = "wave", x = "") + theme(legend.position = "none", text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) +
      scale_x_discrete(labels = c("Illness/Injury", "Job Loss or Default", "Livestock/Farm Shock", "Other Disaster",
                                  "Price Shock", "Earthquake", "Earthquake Aid", "Riots",
                                  "Violence/Theft"))

df.shocks <- df.hh %>%
  group_by(wave) %>%
  summarize(quake = weighted.mean(quake_losses, w = wt_hh*quake, na.rm = TRUE),
            riot = weighted.mean(riot_losses, w = wt_hh*riot, na.rm = TRUE),
            price_shock = weighted.mean(price_shock_losses, w = wt_hh*price_shock, na.rm = TRUE),
            livestock_farm_shock = weighted.mean(livestock_farm_losses, w = wt_hh*livestock_farm_shock, na.rm = TRUE),
            illness_injury_shock = weighted.mean(illness_injury_losses, w = wt_hh*illness_injury_shock, na.rm = TRUE),
            job_default_shock = weighted.mean(job_default_losses, w = wt_hh*job_default_shock, na.rm = TRUE),
            violence_shock = weighted.mean(violence_losses, w = wt_hh*violence_shock, na.rm = TRUE),
            other_nat_disaster = weighted.mean(other_nat_disaster_losses, w = wt_hh*other_nat_disaster, na.rm = TRUE),
            quake_aid = weighted.mean(quake_aid, w = wt_hh*quake_aid_bin, na.rm = TRUE)) %>%
  pivot_longer(-wave, names_to = "shock_type", values_to = "reported_losses")

g2 <- ggplot(df.shocks) +
  geom_col(aes(x = shock_type, y = reported_losses, group = as.factor(wave), fill = as.factor(wave)), position = "dodge") +
  scale_fill_viridis_d() +
  theme_light() + labs(fill = "wave", y = "reported_losses | shock", x = "") + 
  theme(text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + scale_y_continuous(labels = scales::comma) +
      scale_x_discrete(labels = c("Illness/Injury", "Job Loss or Default", "Livestock/Farm Shock", "Other Disaster",
                                  "Price Shock", "Earthquake", "Earthquake Aid", "Riots",
                                  "Violence/Theft"))

plot_grid(g1, g2, nrow = 1, rel_widths = c(4/9, 5/9))
ggsave(paste(rootdir, "/presentation_materials/shocks.png", sep = ""), width = 10, height = 7)
```

### Migration

```{r, message = FALSE, warning = FALSE, echo = FALSE}
df.migr <- df.hh %>%
  group_by(hhmembers) %>% 
  summarize(migrants = mean(n_migrants, na.rm = TRUE),
            n = n())

ggplot(filter(df.migr, hhmembers < 15)) +
  geom_col(aes(x = hhmembers, y = migrants, fill = hhmembers)) +
  scale_fill_viridis_c() + theme_light() + theme(legend.position = "none")


print("fraction of hhs with migrant")
sum(df.hh$wt_hh[df.hh$wave==1 & df.hh$n_migrants > 0])/sum(df.hh$wt_hh[df.hh$wave==1])
sum(df.hh$wt_hh[df.hh$wave==2 & df.hh$n_migrants > 0])/sum(df.hh$wt_hh[df.hh$wave==2])
sum(df.hh$wt_hh[df.hh$wave==3 & df.hh$n_migrants > 0])/sum(df.hh$wt_hh[df.hh$wave==3])

print("avg # of migrants in hhs conditional on at least 1")
weighted.mean(df.hh$n_migrants[df.hh$wave==1 & df.hh$n_migrants>0], w = df.hh$wt_hh[df.hh$wave==1 & df.hh$n_migrants>0])
weighted.mean(df.hh$n_migrants[df.hh$wave==2 & df.hh$n_migrants>0], w = df.hh$wt_hh[df.hh$wave==2 & df.hh$n_migrants>0])
weighted.mean(df.hh$n_migrants[df.hh$wave==3 & df.hh$n_migrants>0], w = df.hh$wt_hh[df.hh$wave==3 & df.hh$n_migrants>0])

print("fraction overseas")
sum(df.hh$migrants_overseas[df.hh$wave==1]*df.hh$wt_hh[df.hh$wave==1])/sum(df.hh$n_migrants[df.hh$wave==1]*df.hh$wt_hh[df.hh$wave==1])
sum(df.hh$migrants_overseas[df.hh$wave==2]*df.hh$wt_hh[df.hh$wave==2])/sum(df.hh$n_migrants[df.hh$wave==2]*df.hh$wt_hh[df.hh$wave==2])
sum(df.hh$migrants_overseas[df.hh$wave==3]*df.hh$wt_hh[df.hh$wave==3])/sum(df.hh$n_migrants[df.hh$wave==3]*df.hh$wt_hh[df.hh$wave==3])

print("fraction that left more than 1 year/2 years ago")
setwd(paste(rootdir, "/data/NPL_2016-2018_HRVS_v01_M_STATA12/", sep = ""))
folders <- c("Wave 1 - Household", "Wave 2 - Household", "Wave 3 - Household")

for (i in c(1:3)) {
  setwd(folders[i])
  df.11 <- read.dta13("Section_11.dta")
  df.11 <- merge(df.hh[df.hh$wave==i,], df.11, by = "hhid")
  a <- weighted.mean(df.11$s11q03 > 11, w = df.11$wt_hh, na.rm = TRUE)
  b <- weighted.mean(df.11$s11q03 > 23, w = df.11$wt_hh, na.rm = TRUE)
  print(a)
  print(b)
  setwd("..")
}

```
### Coping strategies

```{r}

df.coping <- df.hh %>% mutate(asset_sales = if_else(investments - asset_sales<0,1,0),
                              migrate = if_else(migrants_past_year>0,1,0),
                              loans = if_else(new_loans_taken>0,1,0),
                              remittances = if_else(remittance_income>0,1,0)) %>%
  group_by(wave) %>%
  summarize(cut_food = mean(cut_food, na.rm = TRUE),
            dissaving = mean(dissaving, na.rm = TRUE),
            cut_nonfood = mean(cut_nonfood, na.rm = TRUE),
            school_interrupt = mean(school_interrupt, na.rm = TRUE),
            asset_sales = mean(asset_sales, na.rm = TRUE),
            child_labor = mean(child_labor, na.rm = TRUE),
            child_wage_labor = mean(child_wage_labor, na.rm = TRUE),
            migration = mean(migrate, na.rm = TRUE),
            loans = mean(loans, na.rm = TRUE),
            remittances = mean(remittances, na.rm = TRUE)) %>%
  pivot_longer(cols = -c("wave"), names_to = "var", values_to = "frac_hh")

df.coping$var <- factor(df.coping$var, levels = c("dissaving", "loans", "asset_sales", "remittances", "migration", "cut_food", "cut_nonfood",
                                                  "school_interrupt", "child_labor", "child_wage_labor"))

ggplot(df.coping) +
  geom_col(aes(x = var, y = frac_hh, group = as.factor(wave), fill = as.factor(wave)), position = "dodge") +
  scale_fill_viridis_d() + theme_light() + labs(x = "", y = "Fraction of households", fill = "Wave") +
  theme(text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) +
      scale_x_discrete(labels = c("Dissaving", "Loans", "Sold Assets", "Received Remittances",
                                  "Migration", "Cut Food", "Cut Non Food exp.", "School Interrupted",
                                  "Children working", "Children working for wage"))

ggsave(paste(rootdir, "/presentation_materials/coping.png", sep = ""), width = 10, height = 7)
```


FEMA data from: https://www.fema.gov/openfema-data-page/individuals-and-households-program-valid-registrations-v1 

```{r}
library(data.table)
df.fema <- fread(paste(rootdir, "/data/FEMA/ihp.csv", sep = "")) 
  
df.femasum <- df.fema %>%
  mutate(year = year(declarationDate)) %>%
  group_by(year) %>%
  summarize(repair = sum(repairAmount),
            rental = sum(rentalAssistanceAmount),
            replace = sum(replacementAmount),
            other = sum(personalPropertyAmount))

df.femafrac <- transmute(df.femasum, year = year,
                     tot = repair + rental + replace + other,
                     repair = repair/tot,
                     rental = rental/tot,
                     replace = replace/tot,
                     other = other/tot) %>%
  pivot_longer(-year, names_to = "type", values_to = "amt")

df.femasum <- df.femasum %>%
  pivot_longer(-year, names_to = "type", values_to = "amt")

ggplot(filter(df.femafrac, type != "tot")) +
  geom_line(aes(x = year, y = amt, color = type))

ggplot(df.femasum) +
  geom_line(aes(x = year, y = amt, color = type))

ggplot(filter(df.femafrac, type == "tot")) +
  geom_line(aes(x = year, y = amt, color = type))

sum(df.femasum$amt[df.femasum$year>2009 & df.femasum$type=="repair"])/sum(df.femasum$amt[df.femasum$year>2009])
sum(df.femasum$amt[df.femasum$year>2009 & df.femasum$type=="rental"])/sum(df.femasum$amt[df.femasum$year>2009])
sum(df.femasum$amt[df.femasum$year>2009 & df.femasum$type=="replace"])/sum(df.femasum$amt[df.femasum$year>2009])
sum(df.femasum$amt[df.femasum$year>2009 & df.femasum$type=="other"])/sum(df.femasum$amt[df.femasum$year>2009])
sum(df.femasum$amt[df.femasum$year>2009 & df.femasum$type %in% c("repair", "rental", "replace")])
```



