---
title: "WB HRVS descriptive"
author: "Matthew Gordon"
date: "7/7/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
rootdir <- dirname(getwd())
```

### Load packages and data

```{r, messages=FALSE, echo=FALSE, warnings=FALSE}
library(tidyverse)
library(sf)
library(lfe)
library(AER)
library(quantreg)
library(ggnewscale)
library(cowplot)
library(stargazer)
library(xtable)
library(sandwich)
library(readstata13)
#devtools::install_github("mdgordo/dumbells",ref="master")
library(dumbells)

df.hh <- read_csv(paste(rootdir, "/data/processed/full_panel.csv", sep = ""), guess_max = 7500)
df <- filter(df.hh, !is.na(income_gross) & income_gross>0 & food_consumption>0)
```

#### Summary Stats

```{r}
dfsum <- df[,c("consumption", "food_consumption", "income_gross", "productive_assets",
              "loans_taken_past_year", "loans_made_past_year", "remittance_income",
              "currentlyliving", "n_migrants", "skipped_meal", "aid_cumulative", "received_aid", 
              "NGO_transfers", "pub_transfers", "inf_transfers", "gorkha_hh")]

xtabwts <- sumstats.wtd(dfsum, df$wt_hh, d = 2, labs = c("Consumption", "Food Consumption", "Income", "Productive Assets", "Loans Taken Past Year",
                              "Loans Made Past Year", "Remittance Income", "Household Members", "Connected Migrants", "Skipped Meal(%)",
                              "Earthquake Aid", "Earthquake Aid(%)", "NGO Aid", 
                              "Public Transfers", "Informal Transfers", "Affected by Earthquake"))
print(xtabwts, include.rownames = FALSE)

weighted.mean(df$n_migrants > 0, df$wt_hh)
weighted.mean(df$migrants_overseas, df$wt_hh)/weighted.mean(df$n_migrants, df$wt_hh)
weighted.mean(df$migrants_past_year, df$wt_hh)/weighted.mean(df$n_migrants, df$wt_hh)
```

```{r}
aidtab <- df.hh %>%
  group_by(wave, quake_aid) %>%
  summarize(n = n())

ggplot(filter(aidtab, between(quake_aid, 1, 250000))) +
  geom_col(aes(x = as.factor(quake_aid/1000), y = n, fill = as.factor(wave), group = as.factor(wave)), position = "dodge") +
  theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), text = element_text(size = 20)) + 
  labs(x = "Aid (000s NPR)", fill = "Wave")
ggsave(paste(rootdir, "/presentation_materials/aid_hist.png", sep = ""), width = 10, height = 7)
```

### Risk sharing regressions
Income doesnt include remittances/transfers/loans or inputs - zeros dropped
coefficients usually about .2 (see Morten/Townsend)

Heterogeneity

```{r}
risksharing_all <- felm(log(food_consumption) ~ log(income_gross) 
                        | as.factor(hhid) + as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

risksharing_hc1 <- felm(log(food_consumption) ~ log(income_gross) + log(income_gross):caste_recode
                       | as.factor(hhid) + as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

risksharing_fh1 <- felm(log(food_consumption) ~ log(income_gross) + log(income_gross):femalehh
                        | as.factor(hhid) + as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

risksharing_l1 <- felm(log(food_consumption) ~ log(income_gross) + log(income_gross):land_qtle
                       | as.factor(hhid) + as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

risksharing_r1 <- felm(log(food_consumption) ~ log(income_gross) + log(income_gross):region
                       | as.factor(hhid) + as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

mods <- list(risksharing_all, risksharing_hc1, risksharing_fh1, risksharing_l1, risksharing_r1)

stargazer(mods, type = "text", style = "QJE", df = FALSE, omit.stat = c("adj.rsq", "ser"),
          notes = c("All regressions include household and village-year fixed effects. Standard errors clustered at the ward."), notes.align = "l")

weighted.mean(df.hh$remittance_income[df.hh$femalehh==1]>0, df.hh$wt_hh[df.hh$femalehh==1], na.rm = TRUE)
weighted.mean(df.hh$remittance_income[df.hh$femalehh==0]>0, df.hh$wt_hh[df.hh$femalehh==0], na.rm = TRUE)
```

### Cyclicality - ways of smoothing- HH FE
Interestingly, more likely to sell livestock than buy in a good year, but must be investing in other assets

```{r}
pubtransreg <- felm(log(pub_transfers + 1) ~ log(income_gross) | as.factor(hhid) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

inftransreg <- felm(log(inf_transfers + 1) ~ log(income_gross) | as.factor(hhid) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

aidreg <- felm(log(quake_aid + 1) ~ log(income_gross) | as.factor(hhid) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

ngoreg <- felm(log(NGO_transfers + 1) ~ log(income_gross) | as.factor(hhid) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

migreg <- felm(log(migrants_past_year+1) ~ log(income_gross) | as.factor(hhid) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

remreg2 <- felm(log(remittance_income + 1) ~ log(income_gross) + log(lag_remitt + 1) | as.factor(hhid) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

loanreg2 <- felm(log(loans_taken_past_year + 1) ~ log(income_gross) + log(lag_loan + 1) | as.factor(hhid) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

livereg2 <- felm(log(productive_assets+1) ~ log(income_gross) | as.factor(hhid) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

mods <- list(aidreg, pubtransreg, inftransreg, ngoreg, remreg2, migreg, loanreg2, livereg2)

stargazer(mods, type = "text", style = "QJE", df = FALSE, omit.stat = c("adj.rsq", "ser"),
          add.lines = list(c("Fixed Effects", rep("Household", 8)),
                           c("Cluster", rep("Ward", 8))))
```

### Progressivity - Income - VDC-YR FE

```{r}
pubtransregvdc <- felm(log(pub_transfers + 1) ~ log(income_gross) | as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

inftransregvdc <- felm(log(inf_transfers + 1) ~ log(income_gross) | as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

aidregvdc <- felm(log(quake_aid + 1) ~ log(income_gross) | as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

ngoregvdc <- felm(log(NGO_transfers + 1) ~ log(income_gross) | as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

migregvdc <- felm(log(migrants_past_year+1) ~ log(income_gross) | as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

remregvdc <- felm(log(remittance_income + 1) ~ log(income_gross) | as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

loanregvdc <- felm(log(loans_taken_past_year+1) ~ log(income_gross) | as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

mods <- list(aidregvdc, pubtransregvdc, inftransregvdc, ngoregvdc, remregvdc, migregvdc, loanregvdc)

stargazer(mods, type = "text", style = "QJE", df = FALSE, omit.stat = c("adj.rsq", "ser"),
          add.lines = list(c("Fixed Effects", rep("Village-Year", 8)),
                           c("Cluster", rep("Ward", 8))))
```

### Progressivity - Consumption - VDC-YR FE
Obviously could be reverse causal, but within a village year - high consumption/income correlated with aid received

```{r}
cpubtransregvdc <- felm(log(pub_transfers + 1) ~ log(consumption) | as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

cinftransregvdc <- felm(log(inf_transfers + 1) ~ log(consumption) | as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

caidregvdc <- felm(log(quake_aid + 1) ~ log(consumption) | as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

cngoregvdc <- felm(log(NGO_transfers + 1) ~ log(consumption) | as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

cmigregvdc <- felm(log(migrants_past_year+1) ~ log(consumption) | as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

cremregvdc <- felm(log(remittance_income + 1) ~ log(consumption) | as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

cloanregvdc <- felm(log(loans_taken_past_year+1) ~ log(consumption) | as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

mods <- list(caidregvdc, cpubtransregvdc, cinftransregvdc, cngoregvdc, cremregvdc, cmigregvdc, cloanregvdc)

stargazer(mods, type = "text", style = "QJE", df = FALSE, omit.stat = c("adj.rsq", "ser"),
          add.lines = list(c("Fixed Effects", rep("Village-Year", 8)),
                           c("Cluster", rep("Ward", 8))))
```

### Determinants of Damages - VDC FE control for shaking
Supplement with Eq survey analysis
Damages uncorrelated with assets/home materials, but positive correlation with consumption - is this bc aid went to richer hhs or bc aid increased consumption

```{r}
pdam1 <- felm(gorkha_loss ~ log(durables_stock+1)
                        | as.factor(vdc) | 0 | strata,
                    data = df, weights = df$wt_hh[df$wave==1], subset = df$wave==1, na.action = na.omit)

pdam2 <- felm(gorkha_loss ~ home_sqft
                       | as.factor(vdc) | 0 | strata,
                    data = df, weights = df$wt_hh[df$wave==1], subset = df$wave==1, na.action = na.omit)

pdam3 <- felm(gorkha_loss ~ as.factor(caste_recode)
                       | as.factor(vdc) | 0 | strata,
                    data = df, weights = df$wt_hh[df$wave==1], subset = df$wave==1, na.action = na.omit)

pdam4 <- felm(gorkha_loss ~ as.factor(femalehh)
                        | as.factor(vdc) | 0 | strata,
                    data = df, weights = df$wt_hh[df$wave==1], subset = df$wave==1, na.action = na.omit)

pdam5 <- felm(gorkha_loss ~ land_qtle
                        | as.factor(vdc) | 0 | strata,
                    data = df, weights = df$wt_hh[df$wave==1], subset = df$wave==1, na.action = na.omit)

pdam6 <- felm(gorkha_loss ~ log(asset_stock+1)
                       | as.factor(vdc) | 0 | strata,
                    data = df, weights = df$wt_hh[df$wave==1], subset = df$wave==1, na.action = na.omit)

pdam7 <- felm(gorkha_loss ~ log(productive_assets+1)
                       | as.factor(vdc) | 0 | strata,
                    data = df, weights = df$wt_hh[df$wave==1], subset = df$wave==1, na.action = na.omit)

mods <- list(pdam2, pdam3, pdam4, pdam5, pdam6, pdam7, pdam1)

stargazer(mods, type = "text", style = "QJE", df = FALSE, omit.stat = c("adj.rsq", "ser"),
          notes = c("All regressions include village-year fixed effects. Standard errors clustered at the ward."), notes.align = "l")
```

### Probability of Getting aid
VDC-yr FE - wave of aid and earthquake shaking constant

```{r}
paid1 <- felm(received_aid ~ gorkha_hh
                        | as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

paid2 <- felm(received_aid ~ gorkha_hh + caste_recode
                       | as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

paid3 <- felm(received_aid ~ gorkha_hh + femalehh
                        | as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

paid4 <- felm(received_aid ~ gorkha_hh + land_qtle
                       | as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

mods <- list(paid1, paid2, paid3, paid4)

stargazer(mods, type = "text", style = "QJE", df = FALSE, omit.stat = c("adj.rsq", "ser"),
          notes = c("All regressions include village-year fixed effects. Standard errors clustered at the ward."), notes.align = "l")

weighted.mean(df.hh$received_aid[df.hh$gorkha_hh==1], df.hh$wt_hh[df.hh$gorkha_hh==1], na.rm = TRUE)
weighted.mean(df.hh$received_aid[df.hh$gorkha_hh==0], df.hh$wt_hh[df.hh$gorkha_hh==0], na.rm = TRUE)
```

Summarizing:
Remittances, loans, migration are counter cyclical
Productive assets are procyclical
Within village aid is positively correlated with income/consumption - could be reverse causal
Within village loans uncorrelated w income but strong correlation w consumption, remittances negative w income, positive w consumption
Damage is most robust predictor of receiving aid

Argument: 
Wealthy suffer lower damages, but even conditional on damage,
damages are a noisy measure of need - wealthy hhs are insured through remittances/loans
Disasters are double whammy for poor - more damage + less insured


### sources of income
~ 100 nepali rupees = 1 dollar in 2016
Avg income ~ $2000
Best interpreted as fraction with source of income in a given year - eg total # of hhs that get a remittance over the study period is 48%, but only about 34% in a given year

```{r}
df.inc <- df.hh %>% 
  mutate(home_food_production = if_else(food_home_production > 0, 1, 0),
         agriculture = if_else(wet_ag_sales >0 | dry_ag_sales > 0, 1, 0),
         livestock = if_else(livestock_income > 0, 1, 0),
         business = if_else(business_revenues >0 ,1, 0),
         wages = if_else(annual_wages > 0, 1, 0),
         rental = if_else(landrents > 0 | equip_rental_income > 0 | cap_gains > 0 | rent_earned > 0, 1, 0),
         remittance = if_else(remittance_income > 0, 1, 0),
         informal = if_else(inf_transfers > 0, 1, 0),
         NGO_aid = if_else(NGO_transfers > 0, 1, 0),
         pub_transfers = if_else(pub_transfers > 0, 1, 0)) %>%
  summarize(home_food_production = weighted.mean(home_food_production, w = wt_hh, na.rm = TRUE),
            agriculture = weighted.mean(agriculture, w = wt_hh, na.rm = TRUE),
            livestock = weighted.mean(livestock, w = wt_hh, na.rm = TRUE),
            business = weighted.mean(business, w = wt_hh, na.rm = TRUE),
            wages = weighted.mean(wages, w = wt_hh, na.rm = TRUE),
            rental = weighted.mean(rental, w = wt_hh, na.rm = TRUE),
            remittance = weighted.mean(remittance, w = wt_hh, na.rm = TRUE),
            quake_aid = weighted.mean(received_aid, w = wt_hh, na.rm = TRUE),
            pub_aid = weighted.mean(pub_transfers, w = wt_hh, na.rm = TRUE),
            inf_aid = weighted.mean(informal, w = wt_hh, na.rm = TRUE),
            NGO_aid = weighted.mean(NGO_aid, w = wt_hh, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "source", values_to = "fraction")

df.inc$source <- factor(df.inc$source, levels = c("home_food_production", "agriculture", "livestock", "wages", "business", "rental", 
                                                  "quake_aid", "remittance", "pub_aid", "inf_aid", "NGO_aid"))

g1 <- ggplot(df.inc) + geom_bar(aes(x = source, weight = fraction, fill = source)) +
      theme_light() + theme(legend.position = "none", text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + 
      labs(y = "fraction of HHs with income", x = "")

df.inc <- df.hh %>% 
  mutate(home_food_productionwt = if_else(food_home_production > 0, 1, 0)*wt_hh,
         agriculturewt = if_else(wet_ag_sales >0 | dry_ag_sales > 0, 1, 0)*wt_hh,
         livestockwt = if_else(livestock_income > 0, 1, 0)*wt_hh,
         businesswt = if_else(business_revenues >0 ,1, 0)*wt_hh,
         wageswt = if_else(annual_wages > 0, 1, 0)*wt_hh,
         rentalwt = if_else(landrents > 0 | equip_rental_income > 0 | cap_gains > 0 | rent_earned > 0, 1, 0)*wt_hh,
         remittancewt = if_else(remittance_income > 0, 1, 0)*wt_hh,
         pubwt = if_else(pub_transfers > 0, 1, 0)*wt_hh,
         infwt = if_else(inf_transfers > 0, 1, 0)*wt_hh,
         ngowt = if_else(NGO_transfers > 0, 1, 0)*wt_hh) %>%
  summarize(home_food_production = 52*weighted.mean(food_home_production, w = home_food_productionwt, na.rm = TRUE),
            agriculture = weighted.mean(x = (wet_ag_sales + dry_ag_sales), w = agriculturewt, na.rm = TRUE),
            ag_costs = -1*weighted.mean(ag_costs, w = agriculturewt, na.rm = TRUE),
            landrent_paid = -1*weighted.mean(x = (landrent_paid_cash + landrent_paid_inkind), w = agriculturewt, na.rm = TRUE),
            livestock = weighted.mean(livestock_income, w = livestockwt, na.rm = TRUE),
            livestock_costs = -1*weighted.mean(livestock_costs, w = livestockwt, na.rm = TRUE),
            business = weighted.mean(business_revenues, w = businesswt, na.rm = TRUE),
            business_costs = -1*weighted.mean(business_expenses, w = businesswt, na.rm = TRUE),
            wages = weighted.mean(annual_wages, w = wageswt, na.rm = TRUE),
            rental = weighted.mean(x = (landrents + equip_rental_income + cap_gains + rent_earned), w = rentalwt, na.rm = TRUE),
            remittance = weighted.mean(remittance_income, w = remittancewt, na.rm = TRUE),
            quake_aid = weighted.mean(aid_total, w = received_aid*wt_hh, na.rm = TRUE),
            pub_aid = weighted.mean(pub_transfers, w = pubwt, na.rm = TRUE),
            inf_aid = weighted.mean(inf_transfers, w = infwt, na.rm = TRUE),
            NGO_aid = weighted.mean(NGO_transfers, w = ngowt, na.rm = TRUE),
            income = weighted.mean(income, w = wt_hh, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "source", values_to = "fraction")

df.inc$source <- factor(df.inc$source, levels = c("home_food_production", "agriculture", "ag_costs", "landrent_paid", "livestock", "livestock_costs", 
                                                  "wages", "business", "business_costs", "rental", "remittance", "quake_aid", "pub_aid", "inf_aid", "NGO_aid", "income"))

g2 <- ggplot(df.inc) + geom_bar(aes(x = source, weight = fraction, fill = source)) +
      theme_light() + theme(legend.position = "none", text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + 
      labs(y = "Avg Income | source > 0", x = "")

plot_grid(g1, g2, nrow = 1, rel_widths = c(4/9, 5/9))
ggsave(paste(rootdir, "/presentation_materials/income.png", sep = ""), width = 10, height = 7)
```

### types of assets

```{r}
df.assets <- df.hh %>% 
  mutate(home_value = if_else(home_value > 0, 1, 0),
         durables_stock = if_else(durables_stock > 0, 1, 0),
         landvalue = if_else(landvalue > 0, 1, 0),
         equip_stock = if_else(equip_stock >0 ,1, 0),
         livestock_value = if_else(livestock_value > 0, 1, 0),
         financial_assets = if_else(financial_assets > 0, 1, 0),
         savings_group = if_else(savings_group > 0, 1, 0),
         insurance_assets = if_else(insurance_assets > 0, 1, 0)) %>%
  summarize(home_value = weighted.mean(home_value, w = wt_hh, na.rm = TRUE),
            durables_stock = weighted.mean(durables_stock, w = wt_hh, na.rm = TRUE),
            landvalue = weighted.mean(landvalue, w = wt_hh, na.rm = TRUE),
            equip_stock = weighted.mean(equip_stock, w = wt_hh, na.rm = TRUE),
            livestock_value = weighted.mean(livestock_value, w = wt_hh, na.rm = TRUE),
            financial_assets = weighted.mean(financial_assets, w = wt_hh, na.rm = TRUE),
            savings_group = weighted.mean(savings_group, w = wt_hh, na.rm = TRUE),
            insurance_assets = weighted.mean(insurance_assets, w = wt_hh, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "asset_type", values_to = "fraction")

g1 <- ggplot(df.assets) + geom_bar(aes(x = asset_type, weight = fraction, fill = asset_type)) +
      theme_light() + theme(legend.position = "none", text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + 
      labs(y = "fraction of HHs with asset", x = "")

df.assets <- df.hh %>% 
  mutate(home_valuewt = if_else(home_value > 0, 1, 0)*wt_hh,
         durables_stockwt = if_else(durables_stock > 0, 1, 0)*wt_hh,
         landvaluewt = if_else(landvalue > 0, 1, 0)*wt_hh,
         equip_stockwt = if_else(equip_stock >0 ,1, 0)*wt_hh,
         livestock_valuewt = if_else(livestock_value > 0, 1, 0)*wt_hh,
         financial_assetswt = if_else(financial_assets > 0, 1, 0)*wt_hh,
         savings_groupwt = if_else(savings_group > 0, 1, 0)*wt_hh,
         insurance_assetswt = if_else(insurance_assets > 0, 1, 0)*wt_hh) %>%
  summarize(home_value = weighted.mean(home_value, w = home_valuewt, na.rm = TRUE),
            durables_stock = weighted.mean(durables_stock, w = durables_stockwt, na.rm = TRUE),
            landvalue = weighted.mean(landvalue, w = landvaluewt, na.rm = TRUE),
            equip_stock = weighted.mean(equip_stock, w = equip_stockwt, na.rm = TRUE),
            livestock_value = weighted.mean(livestock_value, w = livestock_valuewt, na.rm = TRUE),
            financial_assets = weighted.mean(financial_assets, w = financial_assetswt, na.rm = TRUE),
            savings_group = weighted.mean(savings_group, w = savings_groupwt, na.rm = TRUE),
            insurance_assets = weighted.mean(insurance_assets, w = insurance_assetswt, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "asset_type", values_to = "fraction")

g2 <- ggplot(df.assets) + geom_bar(aes(x = asset_type, weight = fraction, fill = asset_type)) +
      theme_light() + theme(legend.position = "none", text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + 
      labs(y = "Avg Value | asset_type > 0", x = "")

plot_grid(g1, g2, nrow = 1, rel_widths = c(4/9, 5/9))
ggsave(paste(rootdir, "/presentation_materials/assets.png", sep = ""), width = 10, height = 7)
```

### Investments
## note about half of loans come from and go to friends and relatives

```{r}
df.investments <- df.hh %>% 
  mutate(land_purchased = if_else(land_purchased > 0, 1, 0),
         land_sales = if_else(land_sales > 0, 1, 0),
         livestock_purchases = if_else(livestock_purchases > 0, 1, 0),
         livestock_sales = if_else(livestock_sales >0 ,1, 0),
         equip_purchases = if_else(equip_purchases > 0, 1, 0),
         equip_sales = if_else(equip_sales > 0, 1, 0),
         business_investment = if_else(business_investment > 0, 1, 0),
         business_asset_sales = if_else(business_asset_sales > 0, 1, 0),
         loans_taken_past_year = if_else(loans_taken_past_year > 0, 1, 0),
         loans_made_past_year = if_else(loans_made_past_year > 0, 1, 0)) %>%
  summarize(land_purchased = weighted.mean(land_purchased, w = wt_hh, na.rm = TRUE),
            land_sales = weighted.mean(land_sales, w = wt_hh, na.rm = TRUE),
            livestock_purchases = weighted.mean(livestock_purchases, w = wt_hh, na.rm = TRUE),
            livestock_sales = weighted.mean(livestock_sales, w = wt_hh, na.rm = TRUE),
            equip_purchases = weighted.mean(equip_purchases, w = wt_hh, na.rm = TRUE),
            equip_sales = weighted.mean(equip_sales, w = wt_hh, na.rm = TRUE),
            business_investment = weighted.mean(business_investment, w = wt_hh, na.rm = TRUE),
            business_asset_sales = weighted.mean(business_asset_sales, w = wt_hh, na.rm = TRUE),
            loans_taken_past_year = weighted.mean(loans_taken_past_year, w = wt_hh, na.rm = TRUE),
            loans_made_past_year = weighted.mean(loans_made_past_year, w = wt_hh, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "investment_type", values_to = "fraction")

g1 <- ggplot(df.investments) + geom_bar(aes(x = investment_type, weight = fraction, fill = investment_type)) +
      theme_light() + theme(legend.position = "none", text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + 
      labs(y = "fraction of HHs making investment", x = "")

df.investments <- df.hh %>% 
  mutate(land_purchasedwt = if_else(land_purchased > 0, 1, 0)*wt_hh,
         land_saleswt = if_else(land_sales > 0, 1, 0)*wt_hh,
         livestock_purchaseswt = if_else(livestock_purchases > 0, 1, 0)*wt_hh,
         livestock_saleswt = if_else(livestock_sales >0 ,1, 0)*wt_hh,
         equip_purchaseswt = if_else(equip_purchases > 0, 1, 0)*wt_hh,
         equip_saleswt = if_else(equip_sales > 0, 1, 0)*wt_hh,
         business_investmentwt = if_else(business_investment > 0, 1, 0)*wt_hh,
         business_asset_saleswt = if_else(business_asset_sales > 0, 1, 0)*wt_hh,
         loans_taken_past_yearwt = if_else(loans_taken_past_year > 0, 1, 0)*wt_hh,
         loans_made_past_yearwt = if_else(loans_made_past_year > 0, 1, 0)*wt_hh) %>%
  summarize(land_purchased = weighted.mean(land_purchased, w = land_purchasedwt, na.rm = TRUE),
            land_sales = weighted.mean(land_sales, w = land_saleswt, na.rm = TRUE),
            livestock_purchases = weighted.mean(livestock_purchases, w = livestock_purchaseswt, na.rm = TRUE),
            livestock_sales = weighted.mean(livestock_sales, w = livestock_saleswt, na.rm = TRUE),
            equip_purchases = weighted.mean(equip_purchases, w = equip_purchaseswt, na.rm = TRUE),
            equip_sales = weighted.mean(equip_sales, w = equip_saleswt, na.rm = TRUE),
            business_investment = weighted.mean(business_investment, w = business_investmentwt, na.rm = TRUE),
            business_asset_sales = weighted.mean(business_asset_sales, w = business_asset_saleswt, na.rm = TRUE),
            loans_taken_past_year = weighted.mean(loans_taken_past_year, w = loans_taken_past_yearwt, na.rm = TRUE),
            loans_made_past_year = weighted.mean(loans_made_past_year, w = loans_made_past_yearwt, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "investment_type", values_to = "fraction")

g2 <- ggplot(df.investments) + geom_bar(aes(x = investment_type, weight = fraction, fill = investment_type)) +
      theme_light() + theme(legend.position = "none", text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + 
      labs(y = "Avg Amount | investment > 0", x = "")

plot_grid(g1, g2, nrow = 1, rel_widths = c(4/9, 5/9))
ggsave(paste(rootdir, "/presentation_materials/investments.png", sep = ""), width = 10, height = 7)
```

### Consumption

```{r}
df.consumption <- df.hh %>% 
  mutate(other = entertainment_other + other_expenses + craft_consumption) %>%
  summarize(food_home_production = weighted.mean(food_home_production, w = wt_hh, na.rm = TRUE)*52,
            food_market = weighted.mean(food_market, w = wt_hh, na.rm = TRUE)*52,
            food_inkind = weighted.mean(food_inkind, w = wt_hh, na.rm = TRUE)*52,
            durables_consumption = weighted.mean(durables_consumption, w = wt_hh, na.rm = TRUE),
            energy = weighted.mean(energy, w = wt_hh, na.rm = TRUE),
            utilities = weighted.mean(utilities_paid, w = wt_hh, na.rm = TRUE),
            rent = weighted.mean(rent_paid, w = wt_hh, na.rm = TRUE),
            transportation = weighted.mean(transportation, w = wt_hh, na.rm = TRUE),
            clothing_cleaning_home = weighted.mean(clothing_cleaning_home, w = wt_hh, na.rm = TRUE),
            other = weighted.mean(other, w = wt_hh, na.rm = TRUE),
            ceremonial_expenses = weighted.mean(ceremonial_expenses, w = wt_hh, na.rm = TRUE),
            taxes = weighted.mean(taxes, w = wt_hh, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "consumption_type", values_to = "average_spending")

df.consumption$consumption_type <- factor(df.consumption$consumption_type, levels = c("food_market", "food_home_production", "food_inkind", "durables_consumption",
                                                                                      "clothing_cleaning_home", "energy", "utilities", "rent", "transportation", "ceremonial_expenses",
                                                                                      "taxes", "other"))

ggplot(df.consumption) + geom_bar(aes(x = consumption_type, weight = average_spending, fill = consumption_type)) +
      theme_light() + theme(legend.position = "none", text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + 
      labs(y = "average_consumption", x = "")
ggsave(paste(rootdir, "/presentation_materials/consumption.png", sep = ""), width = 10, height = 7)

df.hh %>% mutate(food_share = (food_market + food_home_production)/consumption) %>% ggplot() +
  geom_point(aes(x = log(consumption), y = food_share))
```

### experienced shocks

```{r}
df.shocks <- df.hh %>%
  group_by(wave) %>%
  summarize(quake = weighted.mean(quake, w = wt_hh, na.rm = TRUE),
            riot = weighted.mean(riot, w = wt_hh, na.rm = TRUE),
            price_shock = weighted.mean(price_shock, w = wt_hh, na.rm = TRUE),
            livestock_farm_shock = weighted.mean(livestock_farm_shock, w = wt_hh, na.rm = TRUE),
            illness_injury_shock = weighted.mean(illness_injury_shock, w = wt_hh, na.rm = TRUE),
            job_default_shock = weighted.mean(job_default_shock, w = wt_hh, na.rm = TRUE),
            violence_shock = weighted.mean(violence_shock, w = wt_hh, na.rm = TRUE),
            other_nat_disaster = weighted.mean(other_nat_disaster, w = wt_hh, na.rm = TRUE),
            quake_aid = weighted.mean(quake_aid_bin, w = wt_hh, na.rm = TRUE)) %>%
  pivot_longer(-wave, names_to = "shock_type", values_to = "fraction_of_hh")

g1 <- ggplot(df.shocks) +
  geom_col(aes(x = shock_type, y = fraction_of_hh, group = as.factor(wave), fill = as.factor(wave)), position = "dodge") +
  scale_fill_viridis_d() +
  theme_light() + labs(fill = "wave", x = "") + theme(legend.position = "none", text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1))

df.shocks <- df.hh %>%
  group_by(wave) %>%
  summarize(quake = weighted.mean(quake_losses, w = wt_hh*quake, na.rm = TRUE),
            riot = weighted.mean(riot_losses, w = wt_hh*riot, na.rm = TRUE),
            price_shock = weighted.mean(price_shock_losses, w = wt_hh*price_shock, na.rm = TRUE),
            livestock_farm_shock = weighted.mean(livestock_farm_losses, w = wt_hh*livestock_farm_shock, na.rm = TRUE),
            illness_injury_shock = weighted.mean(illness_injury_losses, w = wt_hh*illness_injury_shock, na.rm = TRUE),
            job_default_shock = weighted.mean(job_default_losses, w = wt_hh*job_default_shock, na.rm = TRUE),
            violence_shock = weighted.mean(violence_losses, w = wt_hh*violence_shock, na.rm = TRUE),
            other_nat_disaster = weighted.mean(other_nat_disaster_losses, w = wt_hh*other_nat_disaster, na.rm = TRUE),
            quake_aid = weighted.mean(quake_aid, w = wt_hh*quake_aid_bin, na.rm = TRUE)) %>%
  pivot_longer(-wave, names_to = "shock_type", values_to = "reported_losses")

g2 <- ggplot(df.shocks) +
  geom_col(aes(x = shock_type, y = reported_losses, group = as.factor(wave), fill = as.factor(wave)), position = "dodge") +
  scale_fill_viridis_d() +
  theme_light() + labs(fill = "wave", y = "reported_losses | shock", x = "") + 
  theme(text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1))

plot_grid(g1, g2, nrow = 1, rel_widths = c(4/9, 5/9))
ggsave(paste(rootdir, "/presentation_materials/shocks.png", sep = ""), width = 10, height = 7)
```

### Migration

```{r, message = FALSE, warning = FALSE, echo = FALSE}
df.migr <- df.hh %>%
  group_by(tot_hhmembers) %>%
  summarize(migrants = mean(n_migrants, na.rm = TRUE),
            n = n())

ggplot(filter(df.migr, tot_hhmembers < 15)) +
  geom_col(aes(x = tot_hhmembers, y = migrants, fill = tot_hhmembers)) +
  scale_fill_viridis_c() + theme_light() + theme(legend.position = "none")


print("fraction of hhs with migrant")
sum(df.hh$wt_hh[df.hh$wave==1 & df.hh$n_migrants > 0])/sum(df.hh$wt_hh[df.hh$wave==1])
sum(df.hh$wt_hh[df.hh$wave==2 & df.hh$n_migrants > 0])/sum(df.hh$wt_hh[df.hh$wave==2])
sum(df.hh$wt_hh[df.hh$wave==3 & df.hh$n_migrants > 0])/sum(df.hh$wt_hh[df.hh$wave==3])

print("avg # of migrants in hhs conditional on at least 1")
weighted.mean(df.hh$n_migrants[df.hh$wave==1 & df.hh$n_migrants>0], w = df.hh$wt_hh[df.hh$wave==1 & df.hh$n_migrants>0])
weighted.mean(df.hh$n_migrants[df.hh$wave==2 & df.hh$n_migrants>0], w = df.hh$wt_hh[df.hh$wave==2 & df.hh$n_migrants>0])
weighted.mean(df.hh$n_migrants[df.hh$wave==3 & df.hh$n_migrants>0], w = df.hh$wt_hh[df.hh$wave==3 & df.hh$n_migrants>0])

print("fraction overseas")
sum(df.hh$migrants_overseas[df.hh$wave==1]*df.hh$wt_hh[df.hh$wave==1])/sum(df.hh$n_migrants[df.hh$wave==1]*df.hh$wt_hh[df.hh$wave==1])
sum(df.hh$migrants_overseas[df.hh$wave==2]*df.hh$wt_hh[df.hh$wave==2])/sum(df.hh$n_migrants[df.hh$wave==2]*df.hh$wt_hh[df.hh$wave==2])
sum(df.hh$migrants_overseas[df.hh$wave==3]*df.hh$wt_hh[df.hh$wave==3])/sum(df.hh$n_migrants[df.hh$wave==3]*df.hh$wt_hh[df.hh$wave==3])

print("fraction that left more than 1 year/2 years ago")
setwd(paste(rootdir, "/data/NPL_2016-2018_HRVS_v01_M_STATA12/", sep = ""))
folders <- c("Wave 1 - Household", "Wave 2 - Household", "Wave 3 - Household")

for (i in c(1:3)) {
  setwd(folders[i])
  df.11 <- read.dta13("Section_11.dta")
  df.11 <- merge(df.hh[df.hh$wave==i,], df.11, by = "hhid")
  a <- weighted.mean(df.11$s11q03 > 11, w = df.11$wt_hh, na.rm = TRUE)
  b <- weighted.mean(df.11$s11q03 > 23, w = df.11$wt_hh, na.rm = TRUE)
  print(a)
  print(b)
  setwd("..")
}

```
### Coping strategies
Cutting food more than non food suggests maybe some asset smoothing

```{r}
df.coping <- df.hh %>% mutate(asset_sales = if_else(investments - asset_sales<0,1,0),
                              migrate = if_else(migrants_past_year>0,1,0),
                              loans = if_else(loans_taken_past_year>0,1,0),
                              remittances = if_else(remittance_income>0,1,0)) %>%
  group_by(wave) %>%
  summarize(cut_food = mean(cut_food, na.rm = TRUE),
            dissaving = mean(dissaving, na.rm = TRUE),
            cut_nonfood = mean(cut_nonfood, na.rm = TRUE),
            school_interrupt = mean(school_interrupt, na.rm = TRUE),
            asset_sales = mean(asset_sales, na.rm = TRUE),
            child_labor = mean(child_labor, na.rm = TRUE),
            child_wage_labor = mean(child_wage_labor, na.rm = TRUE),
            migration = mean(migrate, na.rm = TRUE),
            loans = mean(loans, na.rm = TRUE),
            remittances = mean(remittances, na.rm = TRUE)) %>%
  pivot_longer(cols = -c("wave"), names_to = "var", values_to = "frac_hh")

df.coping$var <- factor(df.coping$var, levels = c("dissaving", "loans", "asset_sales", "remittances", "migration", "cut_food", "cut_nonfood",
                                                  "school_interrupt", "child_labor", "child_wage_labor"))

ggplot(df.coping) +
  geom_col(aes(x = var, y = frac_hh, group = as.factor(wave), fill = as.factor(wave)), position = "dodge") +
  scale_fill_viridis_d() + theme_light() + labs(x = "", y = "Fraction of households", fill = "Wave") +
  theme(text = element_text(size = 20), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1))

ggsave(paste(rootdir, "/presentation_materials/coping.png", sep = ""), width = 10, height = 7)
```
### Mapping district designations: 
https://www.preventionweb.net/files/63268_18moderatelyaffecteddistrictsovervi.pdf 
#### green dots are border districts (<50 km)

```{r, message=FALSE}
df.districts <- data.frame("district_name" = c("Gorkha", "Dhading", "Rasuwa", "Nuwakot", "Sindhupalchok", "Dolakha", "Ramechhap",
                                               "Kathmandu", "Bhaktapur", "Lalitpur", "Kabhrepalanchok", "Okhaldhunga", "Sindhuli", "Makwanpur",
                                               "Lamjung", "Tanahun", "Chitwan", "Solukhumbu", "Khotang", 
                                               "Kaski", "Parbat", "Syangja", "Palpa", "Gulmi", "Baglung",
                                               "Myagdi", "Arghakhanchi", "Nawalparasi", "Bhojpur", "Dhankuta", "Sankhuwasabha"),
                           "district" = c(36, 30, 29, 28, 23, 22, 21, 27, 26, 25, 24, 12, 20, 31, 37, 38, 35, 11, 13,
                                          40, 44, 39, 47, 46, 45, 43, 51, 48, 10, 7, 9), 
                           "dist_14" = c(rep(1, times = 14), rep(0, times = 17)),
                           "designation" = c(rep("severe", 7), rep("crisis", 7), rep("heavy", 5), rep("hit", 6), rep("slight", 6)))

df.wards <- read_csv(paste(rootdir, "/data/NPL_2016-2018_HRVS_v01_M_STATA12/HRVS_gps.csv", sep = ""))
df.wards <- st_as_sf(df.wards, coords = c("long", "lat"), crs = 4326)

df.shp <- st_read(paste(rootdir, "/data/shapefiles/NPL_adm", sep = ""), "NPL_adm3") %>%
              mutate(district_name = if_else(NAME_3=="Chitawan", "Chitwan",
                                                 if_else(NAME_3=="Tanahu", "Tanahun",
                                                         if_else(NAME_3=="Kavrepalanchok","Kabhrepalanchok",as.character(NAME_3)))))

df.shp <- merge(df.shp, df.districts, by = "district_name", all = TRUE) %>%
            mutate(dist_14 = if_else(is.na(dist_14),0,dist_14),
                 designation = if_else(is.na(designation),"none",as.character(designation)))

severe <- st_union(filter(df.shp, designation == "severe"))
crisis <- st_union(filter(df.shp, designation == "crisis"))
heavy_losses <- st_union(filter(df.shp, designation == "heavy"))
moderate <- st_union(filter(df.shp, designation == "hit"))
slight <- st_union(filter(df.shp, designation == "slight"))
dist_14 <- st_cast(st_union(severe, crisis), "LINESTRING")
df.designations <- st_sf(designation = factor(c("severe", "crisis", "heavy losses", "moderate", "slight"), 
                                              levels = c("severe", "crisis", "heavy losses", "moderate", "slight")), 
                         geometry = c(severe, crisis, heavy_losses, moderate, slight))

df.wards$location <- "sample wards"
epicenter <- st_sfc(st_point(x = c(84.731, 28.23)), crs = 4326)
epicenter <- st_sf(district = c(36), distname = c("Gorkha"), vdc = c("na"), ward = c("na"), geometry = c(epicenter), location = c("epicenter"))
df.wards <- rbind(df.wards, epicenter)

df.sample <- filter(df.hh, abs(dist_2_seg13) <= 38.6)
samplewards <- unique(df.sample[,c("district", "vdc", "ward")])
samplewards <- paste(samplewards$district, samplewards$vdc, samplewards$ward)
df.wards <- mutate(df.wards, borderward14 = if_else(paste(district, vdc, ward) %in% samplewards, "border vdc", 
                                                    if_else(location == "epicenter", "epicenter", "other vdc")))

df.wards$borderward14 <- factor(df.wards$borderward14, levels = c("epicenter", "border vdc", "other vdc"))

vdcmap <- ggplot() +
        geom_sf(data = df.shp) +
        geom_sf(data = df.designations, aes(color = designation, fill = designation), alpha = .3) +
        scale_color_manual(values = c("red", "orange", "yellow", "green", "blue")) +
        scale_fill_manual(values = c("red", "orange", "yellow", "green", "blue")) +
        new_scale_fill() +
        geom_sf(data = df.wards, aes(shape = as.factor(borderward14), fill = as.factor(borderward14), size = as.factor(borderward14))) +
        scale_fill_manual(values = c("firebrick1", "cyan2", "grey32")) +
        scale_size_manual(values = c(5,2,2)) +
        scale_shape_manual(values = c(24,21,21)) + 
        theme_light() + theme(text = element_text(size = 20), legend.title = element_blank(), axis.text = element_blank()) + xlim(82,88) + ylim(26.4,29)
vdcmap
ggsave(paste(rootdir, "/presentation_materials/map.png", sep = ""), width = 10, height = 7)
```
```{r}
df.RS <- read_csv(paste(rootdir, "/data/remote_sensing/UF1416_masked.csv", sep = "")) %>%
  mutate(UFchg_100m = UF16_100m_mean - UF14_100m_mean,
         UFchg_250m = UF16_250m_mean - UF14_250m_mean,
         UFchg_500m = UF16_500m_mean - UF14_500m_mean)

df.wards <- merge(df.wards, df.RS[,c("district", "distname", "vdc", "ward", "UFchg_100m", "UFchg_250m", "UFchg_500m")], 
                  by = c("district", "distname", "vdc", "ward"))
```

```{r}
RSmap <- ggplot() +
        geom_sf(data = df.shp) +
        geom_sf(data = df.designations, aes(color = designation, fill = designation), alpha = .3) +
        scale_color_manual(values = c("red", "orange", "yellow", "green", "blue")) +
        scale_fill_manual(values = c("red", "orange", "yellow", "green", "blue")) +
        new_scale_color() +
        geom_sf(data = df.wards, aes(color = UFchg_250m)) + scale_color_gradient2(low = "red", high = "blue") +
        theme_light() + theme(legend.title = element_blank(), axis.text = element_blank())
RSmap
```

