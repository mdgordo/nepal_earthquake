---
title: "WB HRVS descriptive"
author: "Matthew Gordon"
date: "7/7/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
knitr::opts_knit$set(root.dir = "~/data/processed/")
```

### Load packages and data

```{r, message=FALSE, echo=FALSE, warning=FALSE}
library(tidyverse)
library(sf)
library(lfe)
library(AER)
library(quantreg)
library(ggnewscale)
library(cowplot)
library(stargazer)
library(xtable)
library(sandwich)
library(readstata13)
#devtools::install_github("mdgordo/dumbells",ref="master")
library(dumbells)

df.hh <- read_csv("full_panel.csv", guess_max = 7500)

df <- df.hh[,c("consumption", "food_consumption", "income_gross", "productive_assets", 
                              "loans_taken_past_year", "loans_made_past_year", "remittance_income",
                              "currentlyliving", "n_migrants", "skipped_meal", "child_labor",
                              "aid_cumulative", "received_aid", "NGO_transfers", "pub_transfers", "inf_transfers", "gorkha_loss_ever")]

xtabwts <- sumstats.wtd(df, df.hh$wt_hh, d = 2, labs = c("Consumption", "Food Consumption", "Income", "Productive Assets", "Loans Taken Past Year",
                              "Loans Made Past Year", "Remittance Income", "Household Members", "Connected Migrants", "Skipped Meal(%)",
                              "Child Labor(%)", "Earthquake Aid", "Earthquake Aid(%)", "NGO Aid", 
                              "Public Transfers", "Informal Transfers", "Affected by Earthquake"))
print(xtabwts, include.rownames = FALSE)

weighted.mean(df.hh$n_migrants > 0, df.hh$wt_hh)
weighted.mean(df.hh$migrants_overseas, df.hh$wt_hh)/weighted.mean(df.hh$n_migrants, df.hh$wt_hh)
weighted.mean(df.hh$migrants_past_year, df.hh$wt_hh)/weighted.mean(df.hh$n_migrants, df.hh$wt_hh)
```

#### Summary Stats

```{r}
ggplot(df.hh) +
  geom_histogram(aes(x = log(consumption) - avg_cons), bins = 1000)

ggplot(df.hh) +
  geom_point(aes(x = avg_cons, y = var_cons))

ggplot(df.hh) +
  geom_point(aes(x = ihs(income_gross), y = log(food_consumption)))

ggplot() +
  geom_density(data = filter(df.hh, high_caste==1), aes(x = avg_cons, weight = wt_hh), fill = "red", position = "identity", bins = 100, alpha = .3) + 
  geom_density(data = filter(df.hh, high_caste==0), aes(x = avg_cons, weight = wt_hh), fill = "blue", position = "identity", bins = 100, alpha = .3) +
  xlim(8,15)

ggplot() +
  geom_density(data = filter(df.hh, high_caste==1, wave==1), aes(x = income, weight = wt_hh), fill = "red", position = "identity", bins = 100, alpha = .3) + 
  geom_density(data = filter(df.hh, high_caste==0, wave==1), aes(x = income, weight = wt_hh), fill = "blue", position = "identity", bins = 100, alpha = .3) +
  xlim(0, 1000000)

aidtab <- df.hh %>%
  group_by(wave, quake_aid) %>%
  summarize(n = n())

ggplot(filter(aidtab, between(quake_aid, 1, 250000))) +
  geom_col(aes(x = as.factor(quake_aid/1000), y = n, fill = as.factor(wave), group = as.factor(wave)), position = "dodge") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

### historic earthquakes
Largest since 1934 - https://earthquake.usgs.gov/earthquakes/search/

```{r}
df.quakes <- read_csv("/Users/mdgordo/Dropbox (Yale_FES)/Nepal/aid_distribution_model/data/raw/nepal_earthquakes_USGS.csv") %>%
    mutate(decade = paste(substr(time, 1, 3), "0", sep = ""))

df.quakes$decade <- factor(df.quakes$decade, levels = c("1930", "1940", "1950", "1960", "1970", "1980", "1990", "2000", "2010", "2020"))

ggplot(df.quakes) + geom_histogram(aes(x = mag, fill = decade)) +
  theme_light() + labs(x = "magnitude")
```

### Risk sharing regressions
10% increase in income associated with .6% increase in consumption
Doesnt include remittances/transfers/loans or inputs - including transfers increases coefficients - those are procyclical?
Much lower than ICRISAT data - coefficients usually about .2 (see Morten/Townsend)

```{r}
risksharing_caste <- felm(log(consumption) ~ log(income_gross + 1) | as.factor(hhid) | 0 | strata,
                    data = df.hh, weights = df.hh$wt_hh)

risksharing_vdc <- felm(log(consumption) ~ log(income_gross + 1) | as.factor(hhid) + as.factor(vdc_yr) | 0 | strata,
                    data = df.hh, weights = df.hh$wt_hh)

basic_caste <- felm(log(non_durables) ~ log(income_gross + 1) | as.factor(hhid) | 0 | strata, 
                    data = df.hh, weights = df.hh$wt_hh)

basic_vdc <- felm(log(non_durables) ~ log(income_gross + 1) | as.factor(hhid) + as.factor(vdc_yr) | 0 | strata,
                    data = df.hh, weights = df.hh$wt_hh)

assets_caste <- felm(log(productive_assets+1) ~ log(income_gross + 1) | as.factor(hhid) | 0 | strata,
                    data = df.hh, weights = df.hh$wt_hh)

assets_vdc <- felm(log(productive_assets+1) ~ log(income_gross + 1) | as.factor(hhid) + as.factor(vdc_yr) | 0 | strata,
                    data = df.hh, weights = df.hh$wt_hh)

invest_caste <- felm(ihs(net_asset_investment) ~ log(income_gross + 1) | as.factor(hhid) | 0 | strata,
                    data = df.hh, weights = df.hh$wt_hh)

invest_vdc <- felm(ihs(net_asset_investment) ~ log(income_gross + 1) | as.factor(hhid) + as.factor(vdc_yr) | 0 | strata,
                    data = df.hh, weights = df.hh$wt_hh)

input_caste <- felm(log(inputs+1) ~ log(income_gross + 1) | as.factor(hhid) | 0 | strata,
                    data = df.hh, weights = df.hh$wt_hh)

input_vdc <- felm(log(inputs+1) ~ log(income_gross + 1) | as.factor(hhid) + as.factor(vdc_yr) | 0 | strata,
                    data = df.hh, weights = df.hh$wt_hh)

loans_caste <- felm(ihs(net_loans) ~ log(income_gross + 1) | as.factor(hhid) | 0 | strata,
                    data = df.hh, weights = df.hh$wt_hh)

loans_vdc <- felm(ihs(net_loans) ~ log(income_gross + 1) | as.factor(hhid) + as.factor(vdc_yr) | 0 | strata,
                    data = df.hh, weights = df.hh$wt_hh)

mods <- list(risksharing_caste, risksharing_vdc, basic_caste, basic_vdc, assets_caste, assets_vdc, 
             invest_caste, invest_vdc, input_caste, input_vdc, loans_caste, loans_vdc)

stargazer(mods, type = "text", style = "QJE", df = FALSE,
          add.lines = list(c("Fixed Effects", rep(c("HH only", "Village-Year"), 6)),
                           c("Cluster", rep("Ward", 12))))
```

Heterogeneity

something weird going on here - gross income/income/total income, interactions or not
food consumption throws errors - plot stuff? need to create interaction as new variable? - looks same as subset regressioins now but not before
age educ

```{r}
df <- filter(df.hh, !is.na(income_gross) & income_gross>0)

risksharing_all <- felm(log(non_durables) ~ log(income_gross) 
                        | as.factor(hhid) + as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

risksharing_hc1 <- felm(log(non_durables) ~ log(income_gross) + log(income_gross):caste_recode
                       | as.factor(hhid) + as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

risksharing_fh1 <- felm(log(non_durables) ~ log(income_gross) + log(income_gross):femalehh
                        | as.factor(hhid) + as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

risksharing_l1 <- felm(log(non_durables) ~ log(income_gross) + log(income_gross):land_qtle
                       | as.factor(hhid) + as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

risksharing_r1 <- felm(log(non_durables) ~ log(income_gross) + log(income_gross):region
                       | as.factor(hhid) + as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

mods <- list(risksharing_all, risksharing_hc1, risksharing_fh1, risksharing_l1, risksharing_r1)

stargazer(mods, type = "latex", style = "QJE", df = FALSE, omit.stat = c("adj.rsq", "ser"),
          notes = c("All regressions include household and village-year fixed effects. Standard errors clustered at the ward."), notes.align = "l", 
          out = "/Users/mdgordo/Dropbox (Yale_FES)/Nepal/presentation_materials/tables/townsend.tex")

weighted.mean(df.hh$remittance_income[df.hh$femalehh==1]>0, df.hh$wt_hh[df.hh$femalehh==1], na.rm = TRUE)
weighted.mean(df.hh$remittance_income[df.hh$femalehh==0]>0, df.hh$wt_hh[df.hh$femalehh==0], na.rm = TRUE)
```


### Transfers and targetting

```{r}
pubtransreg <- felm(log(pub_transfers + 1) ~ log(income_gross) | as.factor(hhid) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

pubtransregvdc <- felm(log(pub_transfers + 1) ~ log(income_gross) | as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

inftransreg <- felm(log(inf_transfers + 1) ~ log(income_gross) | as.factor(hhid) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

inftransregvdc <- felm(log(inf_transfers + 1) ~ log(income_gross) | as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

aidreg <- felm(log(quake_aid + 1) ~ log(income_gross) | as.factor(hhid) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

aidregvdc <- felm(log(quake_aid + 1) ~ log(income_gross) | as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

ngoreg <- felm(log(NGO_transfers + 1) ~ log(income_gross) | as.factor(hhid) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

ngoregvdc <- felm(log(NGO_transfers + 1) ~ log(income_gross) | as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

migreg <- felm(migrants_past_year ~ log(income_gross) | as.factor(hhid) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

migregvdc <- felm(migrants_past_year ~ log(income_gross) | as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

remreg2 <- felm(log(remittance_income + 1) ~ log(income_gross) + log(lag_remitt + 1) | as.factor(hhid) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

loanreg2 <- felm(log(loans_taken_past_year + 1) ~ log(income_gross) + log(lag_loan + 1) | as.factor(hhid) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

remregvdc <- felm(log(remittance_income + 1) ~ log(income_gross) | as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

loanregvdc <- felm(log(loans_taken_past_year+1) ~ log(income_gross) | as.factor(vdc_yr) | 0 | strata,
                    data = df, weights = df$wt_hh, na.action = na.omit)

mods1 <- list(aidreg, pubtransreg, inftransreg, ngoreg, remreg2, migreg, loanreg2)

stargazer(mods1, type = "text", style = "QJE", df = FALSE, omit.stat = c("adj.rsq", "ser"),
          add.lines = list(c("Fixed Effects", rep("Household", 7)),
                           c("Cluster", rep("Ward", 7))),
          out = "/Users/mdgordo/Dropbox (Yale_FES)/Nepal/presentation_materials/tables/cyclical.tex")

mods2 <- list(aidregvdc, pubtransregvdc, inftransregvdc, ngoregvdc, remregvdc, migregvdc, loanregvdc)

stargazer(mods2, type = "text", style = "QJE", df = FALSE, omit.stat = c("adj.rsq", "ser"),
          add.lines = list(c("Fixed Effects", rep("Village-Year", 7)),
                           c("Cluster", rep("Ward", 7))),
          out = "/Users/mdgordo/Dropbox (Yale_FES)/Nepal/presentation_materials/tables/inequality.tex")

```

### livelihood strategies

```{r}
df.lhs <- df.hh %>%
  mutate(no_inc = if_else(wet_ag_sales + dry_ag_sales + livestock_income + annual_wages + business_revenues==0, 1, 0)) %>%
  summarize(ag_1season = weighted.mean(ag_1season, w = wt_hh, na.rm = TRUE),
            ag_2season = weighted.mean(ag_2season, w = wt_hh, na.rm = TRUE),
            livestock_only = weighted.mean(livestock_only, w = wt_hh, na.rm = TRUE),
            ag_livestock = weighted.mean(ag_livestock, w = wt_hh, na.rm = TRUE),
            ag_ls_wages = weighted.mean(ag_ls_wages, w = wt_hh, na.rm = TRUE),
            ag_ls_business = weighted.mean(ag_ls_business, w = wt_hh, na.rm = TRUE),
            wage_only = weighted.mean(wage_only, w = wt_hh, na.rm = TRUE),
            business_only = weighted.mean(business_only, w = wt_hh, na.rm = TRUE),
            wage_bus = weighted.mean(wage_bus, w = wt_hh, na.rm = TRUE),
            ag_wage_bus = weighted.mean(ag_wage_bus, w = wt_hh, na.rm = TRUE),
            none = weighted.mean(no_inc, w = wt_hh, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "livelihood_type", values_to = "frac_hhs")

ggplot(df.lhs) +
  geom_col(aes(x = livelihood_type, y = frac_hhs))
```

### sources of income
~ 100 nepali rupees = 1 dollar in 2016
Avg income ~ $2000
Best interpreted as fraction with source of income in a given year - eg total # of hhs that get a remittance over the study period is 48%, but only about 34% in a given year

```{r}
df.inc <- df.hh %>% 
  mutate(home_food_production = if_else(food_home_production > 0, 1, 0),
         agriculture = if_else(wet_ag_sales >0 | dry_ag_sales > 0, 1, 0),
         livestock = if_else(livestock_income > 0, 1, 0),
         business = if_else(business_revenues >0 ,1, 0),
         wages = if_else(annual_wages > 0, 1, 0),
         rental = if_else(landrents > 0 | equip_rental_income > 0 | cap_gains > 0 | rent_earned > 0, 1, 0),
         remittance = if_else(remittance_income > 0, 1, 0),
         informal = if_else(inf_transfers > 0, 1, 0),
         NGO_aid = if_else(NGO_transfers > 0, 1, 0),
         pub_transfers = if_else(pub_transfers > 0, 1, 0)) %>%
  summarize(home_food_production = weighted.mean(home_food_production, w = wt_hh, na.rm = TRUE),
            agriculture = weighted.mean(agriculture, w = wt_hh, na.rm = TRUE),
            livestock = weighted.mean(livestock, w = wt_hh, na.rm = TRUE),
            business = weighted.mean(business, w = wt_hh, na.rm = TRUE),
            wages = weighted.mean(wages, w = wt_hh, na.rm = TRUE),
            rental = weighted.mean(rental, w = wt_hh, na.rm = TRUE),
            remittance = weighted.mean(remittance, w = wt_hh, na.rm = TRUE),
            quake_aid = weighted.mean(received_aid, w = wt_hh, na.rm = TRUE),
            pub_aid = weighted.mean(pub_transfers, w = wt_hh, na.rm = TRUE),
            inf_aid = weighted.mean(informal, w = wt_hh, na.rm = TRUE),
            NGO_aid = weighted.mean(NGO_aid, w = wt_hh, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "source", values_to = "fraction")

df.inc$source <- factor(df.inc$source, levels = c("home_food_production", "agriculture", "livestock", "wages", "business", "rental", 
                                                  "quake_aid", "remittance", "pub_aid", "inf_aid", "NGO_aid"))

g1 <- ggplot(df.inc) + geom_bar(aes(x = source, weight = fraction, fill = source)) +
      theme_light() + theme(legend.position = "none", text = element_text(size = 13), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + 
      labs(y = "fraction of HHs with income", x = "")

df.inc <- df.hh %>% 
  mutate(home_food_productionwt = if_else(food_home_production > 0, 1, 0)*wt_hh,
         agriculturewt = if_else(wet_ag_sales >0 | dry_ag_sales > 0, 1, 0)*wt_hh,
         livestockwt = if_else(livestock_income > 0, 1, 0)*wt_hh,
         businesswt = if_else(business_revenues >0 ,1, 0)*wt_hh,
         wageswt = if_else(annual_wages > 0, 1, 0)*wt_hh,
         rentalwt = if_else(landrents > 0 | equip_rental_income > 0 | cap_gains > 0 | rent_earned > 0, 1, 0)*wt_hh,
         remittancewt = if_else(remittance_income > 0, 1, 0)*wt_hh,
         pubwt = if_else(pub_transfers > 0, 1, 0)*wt_hh,
         infwt = if_else(inf_transfers > 0, 1, 0)*wt_hh,
         ngowt = if_else(NGO_transfers > 0, 1, 0)*wt_hh) %>%
  summarize(home_food_production = 52*weighted.mean(food_home_production, w = home_food_productionwt, na.rm = TRUE),
            agriculture = weighted.mean(x = (wet_ag_sales + dry_ag_sales), w = agriculturewt, na.rm = TRUE),
            ag_costs = -1*weighted.mean(ag_costs, w = agriculturewt, na.rm = TRUE),
            landrent_paid = -1*weighted.mean(x = (landrent_paid_cash + landrent_paid_inkind), w = agriculturewt, na.rm = TRUE),
            livestock = weighted.mean(livestock_income, w = livestockwt, na.rm = TRUE),
            livestock_costs = -1*weighted.mean(livestock_costs, w = livestockwt, na.rm = TRUE),
            business = weighted.mean(business_revenues, w = businesswt, na.rm = TRUE),
            business_costs = -1*weighted.mean(business_expenses, w = businesswt, na.rm = TRUE),
            wages = weighted.mean(annual_wages, w = wageswt, na.rm = TRUE),
            rental = weighted.mean(x = (landrents + equip_rental_income + cap_gains + rent_earned), w = rentalwt, na.rm = TRUE),
            remittance = weighted.mean(remittance_income, w = remittancewt, na.rm = TRUE),
            quake_aid = weighted.mean(aid_total, w = received_aid*wt_hh, na.rm = TRUE),
            pub_aid = weighted.mean(pub_transfers, w = pubwt, na.rm = TRUE),
            inf_aid = weighted.mean(inf_transfers, w = infwt, na.rm = TRUE),
            NGO_aid = weighted.mean(NGO_transfers, w = ngowt, na.rm = TRUE),
            income = weighted.mean(income, w = wt_hh, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "source", values_to = "fraction")

df.inc$source <- factor(df.inc$source, levels = c("home_food_production", "agriculture", "ag_costs", "landrent_paid", "livestock", "livestock_costs", 
                                                  "wages", "business", "business_costs", "rental", "remittance", "quake_aid", "pub_aid", "inf_aid", "NGO_aid", "income"))

g2 <- ggplot(df.inc) + geom_bar(aes(x = source, weight = fraction, fill = source)) +
      theme_light() + theme(legend.position = "none", text = element_text(size = 13), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + 
      labs(y = "Avg Income | source > 0", x = "")

plot_grid(g1, g2, nrow = 1, rel_widths = c(4/9, 5/9))
ggsave("/Users/mdgordo/Dropbox (Yale_FES)/Nepal/presentation_materials/figures/income.png", width = 11, height = 7)
```

### types of assets

```{r}
df.assets <- df.hh %>% 
  mutate(home_value = if_else(home_value > 0, 1, 0),
         durables_stock = if_else(durables_stock > 0, 1, 0),
         landvalue = if_else(landvalue > 0, 1, 0),
         equip_stock = if_else(equip_stock >0 ,1, 0),
         livestock_value = if_else(livestock_value > 0, 1, 0),
         financial_assets = if_else(financial_assets > 0, 1, 0),
         savings_group = if_else(savings_group > 0, 1, 0),
         insurance_assets = if_else(insurance_assets > 0, 1, 0)) %>%
  summarize(home_value = weighted.mean(home_value, w = wt_hh, na.rm = TRUE),
            durables_stock = weighted.mean(durables_stock, w = wt_hh, na.rm = TRUE),
            landvalue = weighted.mean(landvalue, w = wt_hh, na.rm = TRUE),
            equip_stock = weighted.mean(equip_stock, w = wt_hh, na.rm = TRUE),
            livestock_value = weighted.mean(livestock_value, w = wt_hh, na.rm = TRUE),
            financial_assets = weighted.mean(financial_assets, w = wt_hh, na.rm = TRUE),
            savings_group = weighted.mean(savings_group, w = wt_hh, na.rm = TRUE),
            insurance_assets = weighted.mean(insurance_assets, w = wt_hh, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "asset_type", values_to = "fraction")

g1 <- ggplot(df.assets) + geom_bar(aes(x = asset_type, weight = fraction, fill = asset_type)) +
      theme_light() + theme(legend.position = "none", text = element_text(size = 13), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + 
      labs(y = "fraction of HHs with asset", x = "")

df.assets <- df.hh %>% 
  mutate(home_valuewt = if_else(home_value > 0, 1, 0)*wt_hh,
         durables_stockwt = if_else(durables_stock > 0, 1, 0)*wt_hh,
         landvaluewt = if_else(landvalue > 0, 1, 0)*wt_hh,
         equip_stockwt = if_else(equip_stock >0 ,1, 0)*wt_hh,
         livestock_valuewt = if_else(livestock_value > 0, 1, 0)*wt_hh,
         financial_assetswt = if_else(financial_assets > 0, 1, 0)*wt_hh,
         savings_groupwt = if_else(savings_group > 0, 1, 0)*wt_hh,
         insurance_assetswt = if_else(insurance_assets > 0, 1, 0)*wt_hh) %>%
  summarize(home_value = weighted.mean(home_value, w = home_valuewt, na.rm = TRUE),
            durables_stock = weighted.mean(durables_stock, w = durables_stockwt, na.rm = TRUE),
            landvalue = weighted.mean(landvalue, w = landvaluewt, na.rm = TRUE),
            equip_stock = weighted.mean(equip_stock, w = equip_stockwt, na.rm = TRUE),
            livestock_value = weighted.mean(livestock_value, w = livestock_valuewt, na.rm = TRUE),
            financial_assets = weighted.mean(financial_assets, w = financial_assetswt, na.rm = TRUE),
            savings_group = weighted.mean(savings_group, w = savings_groupwt, na.rm = TRUE),
            insurance_assets = weighted.mean(insurance_assets, w = insurance_assetswt, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "asset_type", values_to = "fraction")

g2 <- ggplot(df.assets) + geom_bar(aes(x = asset_type, weight = fraction, fill = asset_type)) +
      theme_light() + theme(legend.position = "none", text = element_text(size = 13), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + 
      labs(y = "Avg Value | asset_type > 0", x = "")

plot_grid(g1, g2, nrow = 1, rel_widths = c(4/9, 5/9))
ggsave("/Users/mdgordo/Dropbox (Yale_FES)/Nepal/presentation_materials/figures/assets.png", width = 12, height = 7)
```

### Investments
## note about half of loans come from and go to friends and relatives

```{r}
df.investments <- df.hh %>% 
  mutate(land_purchased = if_else(land_purchased > 0, 1, 0),
         land_sales = if_else(land_sales > 0, 1, 0),
         livestock_purchases = if_else(livestock_purchases > 0, 1, 0),
         livestock_sales = if_else(livestock_sales >0 ,1, 0),
         equip_purchases = if_else(equip_purchases > 0, 1, 0),
         equip_sales = if_else(equip_sales > 0, 1, 0),
         business_investment = if_else(business_investment > 0, 1, 0),
         business_asset_sales = if_else(business_asset_sales > 0, 1, 0),
         loans_taken_past_year = if_else(loans_taken_past_year > 0, 1, 0),
         loans_made_past_year = if_else(loans_made_past_year > 0, 1, 0)) %>%
  summarize(land_purchased = weighted.mean(land_purchased, w = wt_hh, na.rm = TRUE),
            land_sales = weighted.mean(land_sales, w = wt_hh, na.rm = TRUE),
            livestock_purchases = weighted.mean(livestock_purchases, w = wt_hh, na.rm = TRUE),
            livestock_sales = weighted.mean(livestock_sales, w = wt_hh, na.rm = TRUE),
            equip_purchases = weighted.mean(equip_purchases, w = wt_hh, na.rm = TRUE),
            equip_sales = weighted.mean(equip_sales, w = wt_hh, na.rm = TRUE),
            business_investment = weighted.mean(business_investment, w = wt_hh, na.rm = TRUE),
            business_asset_sales = weighted.mean(business_asset_sales, w = wt_hh, na.rm = TRUE),
            loans_taken_past_year = weighted.mean(loans_taken_past_year, w = wt_hh, na.rm = TRUE),
            loans_made_past_year = weighted.mean(loans_made_past_year, w = wt_hh, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "investment_type", values_to = "fraction")

g1 <- ggplot(df.investments) + geom_bar(aes(x = investment_type, weight = fraction, fill = investment_type)) +
      theme_light() + theme(legend.position = "none", text = element_text(size = 13), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + 
      labs(y = "fraction of HHs making investment", x = "")

df.investments <- df.hh %>% 
  mutate(land_purchasedwt = if_else(land_purchased > 0, 1, 0)*wt_hh,
         land_saleswt = if_else(land_sales > 0, 1, 0)*wt_hh,
         livestock_purchaseswt = if_else(livestock_purchases > 0, 1, 0)*wt_hh,
         livestock_saleswt = if_else(livestock_sales >0 ,1, 0)*wt_hh,
         equip_purchaseswt = if_else(equip_purchases > 0, 1, 0)*wt_hh,
         equip_saleswt = if_else(equip_sales > 0, 1, 0)*wt_hh,
         business_investmentwt = if_else(business_investment > 0, 1, 0)*wt_hh,
         business_asset_saleswt = if_else(business_asset_sales > 0, 1, 0)*wt_hh,
         loans_taken_past_yearwt = if_else(loans_taken_past_year > 0, 1, 0)*wt_hh,
         loans_made_past_yearwt = if_else(loans_made_past_year > 0, 1, 0)*wt_hh) %>%
  summarize(land_purchased = weighted.mean(land_purchased, w = land_purchasedwt, na.rm = TRUE),
            land_sales = weighted.mean(land_sales, w = land_saleswt, na.rm = TRUE),
            livestock_purchases = weighted.mean(livestock_purchases, w = livestock_purchaseswt, na.rm = TRUE),
            livestock_sales = weighted.mean(livestock_sales, w = livestock_saleswt, na.rm = TRUE),
            equip_purchases = weighted.mean(equip_purchases, w = equip_purchaseswt, na.rm = TRUE),
            equip_sales = weighted.mean(equip_sales, w = equip_saleswt, na.rm = TRUE),
            business_investment = weighted.mean(business_investment, w = business_investmentwt, na.rm = TRUE),
            business_asset_sales = weighted.mean(business_asset_sales, w = business_asset_saleswt, na.rm = TRUE),
            loans_taken_past_year = weighted.mean(loans_taken_past_year, w = loans_taken_past_yearwt, na.rm = TRUE),
            loans_made_past_year = weighted.mean(loans_made_past_year, w = loans_made_past_yearwt, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "investment_type", values_to = "fraction")

g2 <- ggplot(df.investments) + geom_bar(aes(x = investment_type, weight = fraction, fill = investment_type)) +
      theme_light() + theme(legend.position = "none", text = element_text(size = 13), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + 
      labs(y = "Avg Amount | investment > 0", x = "")

plot_grid(g1, g2, nrow = 1, rel_widths = c(4/9, 5/9))
ggsave("/Users/mdgordo/Dropbox (Yale_FES)/Nepal/presentation_materials/figures/investments.png", width = 12, height = 7)
```

### Consumption

```{r}
df.consumption <- df.hh %>% 
  mutate(other = entertainment_other + other_expenses + craft_consumption) %>%
  summarize(food_home_production = weighted.mean(food_home_production, w = wt_hh, na.rm = TRUE)*52,
            food_market = weighted.mean(food_market, w = wt_hh, na.rm = TRUE)*52,
            food_inkind = weighted.mean(food_inkind, w = wt_hh, na.rm = TRUE)*52,
            durables_consumption = weighted.mean(durables_consumption, w = wt_hh, na.rm = TRUE),
            energy = weighted.mean(energy, w = wt_hh, na.rm = TRUE),
            utilities = weighted.mean(utilities_paid, w = wt_hh, na.rm = TRUE),
            rent = weighted.mean(rent_paid, w = wt_hh, na.rm = TRUE),
            transportation = weighted.mean(transportation, w = wt_hh, na.rm = TRUE),
            clothing_cleaning_home = weighted.mean(clothing_cleaning_home, w = wt_hh, na.rm = TRUE),
            other = weighted.mean(other, w = wt_hh, na.rm = TRUE),
            ceremonial_expenses = weighted.mean(ceremonial_expenses, w = wt_hh, na.rm = TRUE),
            taxes = weighted.mean(taxes, w = wt_hh, na.rm = TRUE)) %>%
  pivot_longer(cols = colnames(.), names_to = "consumption_type", values_to = "average_spending")

df.consumption$consumption_type <- factor(df.consumption$consumption_type, levels = c("food_market", "food_home_production", "food_inkind", "durables_consumption",
                                                                                      "clothing_cleaning_home", "energy", "utilities", "rent", "transportation", "ceremonial_expenses",
                                                                                      "taxes", "other"))

ggplot(df.consumption) + geom_bar(aes(x = consumption_type, weight = average_spending, fill = consumption_type)) +
      theme_light() + theme(legend.position = "none", text = element_text(size = 13), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1)) + 
      labs(y = "average_consumption", x = "")
ggsave("/Users/mdgordo/Dropbox (Yale_FES)/Nepal/presentation_materials/figures/consumption.png", width = 12, height = 7)

df.hh %>% mutate(food_share = (food_market + food_home_production)/consumption) %>% ggplot() +
  geom_point(aes(x = log(consumption), y = food_share))
```

### experienced shocks

```{r}
df.shocks <- df.hh %>%
  group_by(wave) %>%
  summarize(quake = weighted.mean(quake, w = wt_hh, na.rm = TRUE),
            riot = weighted.mean(riot, w = wt_hh, na.rm = TRUE),
            price_shock = weighted.mean(price_shock, w = wt_hh, na.rm = TRUE),
            livestock_farm_shock = weighted.mean(livestock_farm_shock, w = wt_hh, na.rm = TRUE),
            illness_injury_shock = weighted.mean(illness_injury_shock, w = wt_hh, na.rm = TRUE),
            job_default_shock = weighted.mean(job_default_shock, w = wt_hh, na.rm = TRUE),
            violence_shock = weighted.mean(violence_shock, w = wt_hh, na.rm = TRUE),
            other_nat_disaster = weighted.mean(other_nat_disaster, w = wt_hh, na.rm = TRUE),
            quake_aid = weighted.mean(quake_aid_bin, w = wt_hh, na.rm = TRUE)) %>%
  pivot_longer(-wave, names_to = "shock_type", values_to = "fraction_of_hh")

g1 <- ggplot(df.shocks) +
  geom_col(aes(x = shock_type, y = fraction_of_hh, group = as.factor(wave), fill = as.factor(wave)), position = "dodge") +
  scale_fill_viridis_d() +
  theme_light() + labs(fill = "wave", x = "") + theme(legend.position = "none", text = element_text(size = 13), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1))

df.shocks <- df.hh %>%
  group_by(wave) %>%
  summarize(quake = weighted.mean(quake_losses, w = wt_hh*quake, na.rm = TRUE),
            riot = weighted.mean(riot_losses, w = wt_hh*riot, na.rm = TRUE),
            price_shock = weighted.mean(price_shock_losses, w = wt_hh*price_shock, na.rm = TRUE),
            livestock_farm_shock = weighted.mean(livestock_farm_losses, w = wt_hh*livestock_farm_shock, na.rm = TRUE),
            illness_injury_shock = weighted.mean(illness_injury_losses, w = wt_hh*illness_injury_shock, na.rm = TRUE),
            job_default_shock = weighted.mean(job_default_losses, w = wt_hh*job_default_shock, na.rm = TRUE),
            violence_shock = weighted.mean(violence_losses, w = wt_hh*violence_shock, na.rm = TRUE),
            other_nat_disaster = weighted.mean(other_nat_disaster_losses, w = wt_hh*other_nat_disaster, na.rm = TRUE),
            quake_aid = weighted.mean(quake_aid, w = wt_hh*quake_aid_bin, na.rm = TRUE)) %>%
  pivot_longer(-wave, names_to = "shock_type", values_to = "reported_losses")

g2 <- ggplot(df.shocks) +
  geom_col(aes(x = shock_type, y = reported_losses, group = as.factor(wave), fill = as.factor(wave)), position = "dodge") +
  scale_fill_viridis_d() +
  theme_light() + labs(fill = "wave", y = "reported_losses | shock", x = "") + 
  theme(text = element_text(size = 13), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1))

plot_grid(g1, g2, nrow = 1, rel_widths = c(4/9, 5/9))
ggsave("/Users/mdgordo/Dropbox (Yale_FES)/Nepal/presentation_materials/figures/shocks.png", width = 12, height = 7)
```

### Migration

```{r, message = FALSE, warning = FALSE, echo = FALSE}
df.migr <- df.hh %>%
  group_by(tot_hhmembers) %>%
  summarize(migrants = mean(n_migrants, na.rm = TRUE),
            n = n())

ggplot(filter(df.migr, tot_hhmembers < 15)) +
  geom_col(aes(x = tot_hhmembers, y = migrants, fill = tot_hhmembers)) +
  scale_fill_viridis_c() + theme_light() + theme(legend.position = "none")


print("fraction of hhs with migrant")
sum(df.hh$wt_hh[df.hh$wave==1 & df.hh$n_migrants > 0])/sum(df.hh$wt_hh[df.hh$wave==1])
sum(df.hh$wt_hh[df.hh$wave==2 & df.hh$n_migrants > 0])/sum(df.hh$wt_hh[df.hh$wave==2])
sum(df.hh$wt_hh[df.hh$wave==3 & df.hh$n_migrants > 0])/sum(df.hh$wt_hh[df.hh$wave==3])

print("avg # of migrants in hhs conditional on at least 1")
weighted.mean(df.hh$n_migrants[df.hh$wave==1 & df.hh$n_migrants>0], w = df.hh$wt_hh[df.hh$wave==1 & df.hh$n_migrants>0])
weighted.mean(df.hh$n_migrants[df.hh$wave==2 & df.hh$n_migrants>0], w = df.hh$wt_hh[df.hh$wave==2 & df.hh$n_migrants>0])
weighted.mean(df.hh$n_migrants[df.hh$wave==3 & df.hh$n_migrants>0], w = df.hh$wt_hh[df.hh$wave==3 & df.hh$n_migrants>0])

print("fraction overseas")
sum(df.hh$migrants_overseas[df.hh$wave==1]*df.hh$wt_hh[df.hh$wave==1])/sum(df.hh$n_migrants[df.hh$wave==1]*df.hh$wt_hh[df.hh$wave==1])
sum(df.hh$migrants_overseas[df.hh$wave==2]*df.hh$wt_hh[df.hh$wave==2])/sum(df.hh$n_migrants[df.hh$wave==2]*df.hh$wt_hh[df.hh$wave==2])
sum(df.hh$migrants_overseas[df.hh$wave==3]*df.hh$wt_hh[df.hh$wave==3])/sum(df.hh$n_migrants[df.hh$wave==3]*df.hh$wt_hh[df.hh$wave==3])

print("fraction that left more than 1 year/2 years ago")
setwd("/Users/mdgordo/Dropbox (Yale_FES)/Nepal/aid_distribution_model/data/raw/NPL_2016-2018_HRVS_v01_M_STATA12/")
folders <- c("Wave 1 - Household", "Wave 2 - Household", "Wave 3 - Household")

for (i in c(1:3)) {
  setwd(folders[i])
  df.11 <- read.dta13("Section_11.dta")
  df.11 <- merge(df.hh[df.hh$wave==i,], df.11, by = "hhid")
  a <- weighted.mean(df.11$s11q03 > 11, w = df.11$wt_hh, na.rm = TRUE)
  b <- weighted.mean(df.11$s11q03 > 23, w = df.11$wt_hh, na.rm = TRUE)
  print(a)
  print(b)
  setwd("..")
}

```


```{r}
df.coping <- df.hh %>% mutate(asset_sales = if_else(investments - asset_sales<0,1,0),
                              migrate = if_else(migrants_past_year>0,1,0),
                              loans = if_else(loans_taken_past_year>0,1,0),
                              remittances = if_else(remittance_income>0,1,0)) %>%
  group_by(wave) %>%
  summarize(cut_food = mean(cut_food, na.rm = TRUE),
            dissaving = mean(dissaving, na.rm = TRUE),
            cut_nonfood = mean(cut_nonfood, na.rm = TRUE),
            school_interrupt = mean(school_interrupt, na.rm = TRUE),
            asset_sales = mean(asset_sales, na.rm = TRUE),
            child_labor = mean(child_labor, na.rm = TRUE),
            child_wage_labor = mean(child_wage_labor, na.rm = TRUE),
            migration = mean(migrate, na.rm = TRUE),
            loans = mean(loans, na.rm = TRUE),
            remittances = mean(remittances, na.rm = TRUE)) %>%
  pivot_longer(cols = -c("wave"), names_to = "var", values_to = "frac_hh")

df.coping$var <- factor(df.coping$var, levels = c("dissaving", "loans", "asset_sales", "remittances", "migration", "cut_food", "cut_nonfood",
                                                  "school_interrupt", "child_labor", "child_wage_labor"))

ggplot(df.coping) +
  geom_col(aes(x = var, y = frac_hh, group = as.factor(wave), fill = as.factor(wave)), position = "dodge") +
  scale_fill_viridis_d() + theme_light() + labs(x = "", y = "Fraction of households", fill = "Wave") +
  theme(text = element_text(size = 13), axis.text.x = element_text(angle = -80, hjust = 0, vjust = 1))

ggsave("/Users/mdgordo/Dropbox (Yale_FES)/Nepal/presentation_materials/figures/coping.png", width = 12, height = 7)
```

### Predicting Vulnerability

Simplest version

```{r}
library(gbm)
vallist <- readRDS("vallist.rds")

errors = lapply(vallist, function(x){is.character(x)})
goodlist <- vallist[errors!=TRUE]
sum(errors==TRUE)
sum(as.numeric(lapply(vallist, function(x) x$maxiterE)), na.rm = TRUE)
sum(as.numeric(lapply(vallist, function(x) x$maxiterV)), na.rm = TRUE)
sum(as.numeric(lapply(vallist, function(x) is.na(x$maxiterV))), na.rm = TRUE)
sum(unlist(lapply(vallist, function(x) x$maxflag[1])), na.rm = TRUE)
sum(unlist(lapply(vallist, function(x) x$maxflag[2])), na.rm = TRUE)
sum(unlist(lapply(vallist, function(x) x$maxflag[3])), na.rm = TRUE)
```

```{r}
df.vf <- data.frame("hhid" = unique(df.hh$hhid)[errors!=TRUE],
                    "x1" = sapply(goodlist, function(x) x$x[1]),
                    "x2" = sapply(goodlist, function(x) x$x[2]),
                    "x3" = sapply(goodlist, function(x) x$x[3]),
                    "vx1" = sapply(goodlist, function(x) x$vx[1]),
                    "vx2" = sapply(goodlist, function(x) x$vx[2]),
                    "vx3" = sapply(goodlist, function(x) x$vx[3]),
                    "vdelta251" = sapply(goodlist, function(x) x$vaiddelta25[1]),
                    "vdelta252" = sapply(goodlist, function(x) x$vaiddelta25[2]),
                    "vdelta253" = sapply(goodlist, function(x) x$vaiddelta25[3]),
                    "vdelta1001" = sapply(goodlist, function(x) x$vaiddelta100[1]),
                    "vdelta1002" = sapply(goodlist, function(x) x$vaiddelta100[2]),
                    "vdelta1003" = sapply(goodlist, function(x) x$vaiddelta100[3]),
                    "cdelta251" = sapply(goodlist, function(x) x$caiddelta25[1]),
                    "cdelta252" = sapply(goodlist, function(x) x$caiddelta25[2]),
                    "cdelta253" = sapply(goodlist, function(x) x$caiddelta25[3]),
                    "cdelta1001" = sapply(goodlist, function(x) x$caiddelta100[1]),
                    "cdelta1002" = sapply(goodlist, function(x) x$caiddelta100[2]),
                    "cdelta1003" = sapply(goodlist, function(x) x$caiddelta100[3]))

df.hh <- merge(df.hh, df.vf, by = "hhid", all.x = TRUE)
```

```{r}
ggplot(filter(df.hh, vdelta1001 < 1e-7)) +
  geom_point(aes(x = log(vdelta1001), y = log(consumption), color = log(gorkha_loss_amt)), alpha = .2) +
  scale_color_viridis_c() + theme_bw()

ggplot(filter(df.hh, vdelta1001 < 1e-7)) +
  geom_point(aes(x = log(vdelta1001), y = log(vdelta251), color = log(gorkha_loss_amt)), alpha = .2) +
  scale_color_viridis_c() + theme_bw()

ggplot(filter(df.hh, vdelta1001 < 1e-7 & wave==1)) +
  geom_point(aes(x = x1, y = log(vdelta251), color = log(gorkha_loss_amt)), alpha = .2) +
  scale_color_viridis_c() + theme_bw()

ggplot(filter(df.hh, vdelta1001 < 1e-7 & wave==1)) +
  geom_point(aes(x = x1, y = log(cdelta251), color = log(gorkha_loss_amt)), alpha = .2) +
  scale_color_viridis_c() + theme_bw()

ggplot(filter(df.hh, vdelta1001 < 1e-7 & wave==1)) +
  geom_point(aes(x = log(consumption), y = log(cdelta251), color = log(gorkha_loss_amt)), alpha = .2) +
  scale_color_viridis_c() + theme_bw()

ggplot(filter(df.hh, vdelta1001 < 1e-7 & wave==1)) +
  geom_point(aes(x = log(consumption), y = x1, color = log(gorkha_loss_amt)), alpha = .2) +
  scale_color_viridis_c() + theme_bw()

ggplot(filter(df.hh, x1 < 500000)) +
  geom_histogram(aes(x = x1)) + theme_bw() + labs(x = "Buffer stock") +
  theme(text = element_text(size = 20))
ggsave("/Users/mdgordo/Dropbox (Yale_FES)/Nepal/presentation_materials/figures/xhist.png")

ggplot(filter(df.hh, x1 < 500000 & x1 > -500000 & wave==1)) +
  geom_histogram(aes(x = x1 - total_income)) + theme_bw() + labs(x = "Buffer stock") +
  theme(text = element_text(size = 20)) + xlim(-500000,500000)
ggsave("/Users/mdgordo/Dropbox (Yale_FES)/Nepal/presentation_materials/figures/xminusyhist.png")

ggplot(filter(df.hh, wave==1)) +
  geom_point(aes(x = log(x1), y = log(total_income))) + theme_bw() + labs(x = "Buffer stock") +
  theme(text = element_text(size = 20))
ggsave("/Users/mdgordo/Dropbox (Yale_FES)/Nepal/presentation_materials/figures/xinc.png")

ggplot(filter(df.hh, wave==1)) +
  geom_point(aes(x = log(x1), y = log(consumption))) + theme_bw() + labs(x = "Buffer stock") +
  theme(text = element_text(size = 20))
ggsave("/Users/mdgordo/Dropbox (Yale_FES)/Nepal/presentation_materials/figures/xcons.png")

ggplot(filter(df.hh, wave==1)) +
  geom_point(aes(x = log(x1), y = log(x2))) + theme_bw() + labs(x = "Buffer stock")

ggplot(filter(df.hh, wave==1)) +
  geom_point(aes(x = log(x1), y = log(x3))) + theme_bw() + labs(x = "Buffer stock wave 1", y = "Buffer stock wave 3") +
  theme(text = element_text(size = 20))
```

Variable importance is very unstable

### why am I filtering by not receiving aid?

```{r}
df.gbm0 <- filter(df.hh, wave==1 & vdelta1001 < 1e-7)

df.gbm1 <- df.gbm0 %>% filter(aid_cumulative_bin==0) %>%
  select(hhid, vdelta1001, slope, elevation, shake_pga, walls, foundation, roof, gorkha_loss) %>%
  mutate(walls = as.factor(walls), foundation = as.factor(foundation), roof = as.factor(roof)) %>%
  filter(complete.cases(.)) 

df.gbm2 <- df.gbm0 %>% filter(aid_cumulative_bin==0) %>% 
  mutate(asset_stock = log(asset_stock), equip_stock = log(equip_stock+1), durables_stock = log(durables_stock+1), landvalue = log(landvalue+1), 
         home_value = log(home_value+1), livestock_value = log(livestock_value+1)) %>%
  select(hhid, vdelta1001, high_caste, hhmembers, under5, under18, over65, slope, elevation, shake_pga, walls, foundation, roof, fuel, stove, asset_stock, equip_stock, durables_stock, landvalue, 
         home_value, livestock_value, pension, femalehh, wage_only, no_inc, ag_1season, ag_2season, livestock_only, ag_livestock, ag_ls_wages, ag_ls_business, business_only,
         wage_bus, ag_wage_bus, ag_ls_all, diversified, temp_earth_housing, age_hh, highest_ed, prev_loans, gorkha_loss) %>%
  mutate(walls = as.factor(walls), foundation = as.factor(foundation), roof = as.factor(roof), fuel = as.factor(fuel), stove = as.factor(stove)) %>%
  filter(complete.cases(.)) 

train1 = sample(1:nrow(df.gbm1), 250)
train2 = sample(1:nrow(df.gbm2), 250)

modgbm1 <- gbm(vdelta1001 ~ ., data = df.gbm1[train1, colnames(df.gbm1)!="hhid"], n.trees=1000, shrinkage=0.01, interaction.depth = 4, cv.folds = 5)
modgbm2 <- gbm(vdelta1001 ~ ., data = df.gbm2[train2, colnames(df.gbm2)!="hhid"], n.trees=3000, shrinkage=0.01, interaction.depth = 4, cv.folds = 5)

best.iter1 <- gbm.perf(modgbm1, method = "cv")
best.iter2 <- gbm.perf(modgbm2, method = "cv")

df.gbm0$preds1 <- predict(modgbm1, newdata = df.gbm0, n.trees = best.iter1)
df.gbm0$preds2 <- predict(modgbm2, newdata = df.gbm0, n.trees = best.iter2)

df.mod1 <- summary(modgbm1, n.trees = best.iter1)
df.mod2 <- summary(modgbm2, n.trees = best.iter2)

ggplot(df.mod1) + 
  geom_col(aes(y = var, x = rel.inf, fill = var)) +
  theme_bw() + labs(x = "relative influence", y = "") +
  theme(text = element_text(size = 24)) + guides(fill = FALSE)
ggsave("/Users/mdgordo/Dropbox (Yale_FES)/Nepal/presentation_materials/figures/relinf1.png")

ggplot(filter(df.mod2, rel.inf>5)) + 
  geom_col(aes(y = var, x = rel.inf, fill = var)) +
  theme_bw() + labs(x = "relative influence", y = "") +
  theme(text = element_text(size = 24)) + guides(fill = FALSE)
ggsave("/Users/mdgordo/Dropbox (Yale_FES)/Nepal/presentation_materials/figures/relinf2.png")

plot.gbm(modgbm1, i.var = c("slope", "elevation"))
plot.gbm(modgbm1, i.var = c("roof", "gorkha_loss"))
plot.gbm(modgbm1, i.var = c("walls", "shake_pga"))
plot.gbm(modgbm1, i.var = c("slope", "shake_pga"))

a <- plot.gbm(modgbm2, i.var = c("hhmembers", "durables_stock"))
b <- plot.gbm(modgbm2, i.var = c("slope", "shake_pga"))
c <- plot.gbm(modgbm2, i.var = c("age_hh", "highest_ed"))
d <- plot.gbm(modgbm2, i.var = c("high_caste", "femalehh"))

cowplot::plot_grid(a, b, c, d) + theme_bw()
ggsave("/Users/mdgordo/Dropbox (Yale_FES)/Nepal/presentation_materials/figures/gbmmargin.png")

plot.gbm(modgbm2, i.var = c("elevation", "livestock_value"))
plot.gbm(modgbm2, i.var = c("age_hh", "asset_stock"))

```

```{r}
ggplot(filter(df.gbm0, vdelta1001 < 5e-10)) + 
  geom_point(aes(x = vdelta1001, y = preds1, color = received_aid)) +
  geom_abline(aes(slope = 1, intercept = 0))

ggplot(filter(df.gbm0, vdelta1001 < 5e-10)) + 
  geom_point(aes(x = vdelta1001, y = preds2, color = received_aid)) +
  geom_abline(aes(slope = 1, intercept = 0))

ggplot(filter(df.gbm0, vdelta1001 < 5e-10)) + 
  geom_point(aes(x = preds1, y = preds2, color = received_aid)) +
  geom_abline(aes(slope = 1, intercept = 0))
```
Confusion matrix 


```{r}
q <- sum(df.hh$received_aid==1 & df.hh$wave==1)/nrow(filter(df.hh, wave==1))
q
tclass <- c("True Pos", "True Pos", "True Neg", "True Neg")
pclass <- c("Pred Neg", "Pred Pos", "Pred Neg", "Pred Pos")

y <- c(sum(df.gbm0$received_aid==0 & df.gbm0$vdelta1001>quantile(df.gbm0$vdelta1001, 1-q))/nrow(df.gbm0),
       sum(df.gbm0$received_aid==1 & df.gbm0$vdelta1001>quantile(df.gbm0$vdelta1001, 1-q))/nrow(df.gbm0),
       sum(df.gbm0$received_aid==0 & df.gbm0$vdelta1001<quantile(df.gbm0$vdelta1001, 1-q))/nrow(df.gbm0),
       sum(df.gbm0$received_aid==1 & df.gbm0$vdelta1001<quantile(df.gbm0$vdelta1001, 1-q))/nrow(df.gbm0))

ggplot() +
  geom_tile(aes(x = ordered(tclass, levels = unique(tclass)), y = pclass, fill = y)) +
  geom_text(aes(x = ordered(tclass, levels = unique(tclass)), y = pclass, 
                label = paste(round(y,3), "\n", c("", paste("(",as.character(round(y[2]/q,3)*100), "%)", sep = ""), "", ""))), vjust = 1, color = "white") + 
  theme_bw() + guides(fill = FALSE) + labs(x = "", y = "", title = "Actual Allocations") +
  theme(text = element_text(size = 22))
ggsave("/Users/mdgordo/Dropbox (Yale_FES)/Nepal/presentation_materials/figures/cmatactual.png")

y <- c(sum(df.gbm0$preds1<quantile(df.gbm0$preds1, 1-q) & df.gbm0$vdelta1001>quantile(df.gbm0$vdelta1001, 1-q))/nrow(df.gbm0),
       sum(df.gbm0$preds1>quantile(df.gbm0$preds1, 1-q) & df.gbm0$vdelta1001>quantile(df.gbm0$vdelta1001, 1-q))/nrow(df.gbm0),
       sum(df.gbm0$preds1<quantile(df.gbm0$preds1, 1-q) & df.gbm0$vdelta1001<quantile(df.gbm0$vdelta1001, 1-q))/nrow(df.gbm0),
       sum(df.gbm0$preds1>quantile(df.gbm0$preds1, 1-q) & df.gbm0$vdelta1001<quantile(df.gbm0$vdelta1001, 1-q))/nrow(df.gbm0))

ggplot() +
  geom_tile(aes(x = ordered(tclass, levels = unique(tclass)), y = pclass, fill = y)) +
  geom_text(aes(x = ordered(tclass, levels = unique(tclass)), y = pclass, 
                label = paste(round(y,3), "\n", c("", paste("(",as.character(round(y[2]/q,3)*100), "%)", sep = ""), "", ""))), vjust = 1, color = "white") + 
  theme_bw() + guides(fill = FALSE) + labs(x = "", y = "", title = "Limited Model") +
  theme(text = element_text(size = 22))
ggsave("/Users/mdgordo/Dropbox (Yale_FES)/Nepal/presentation_materials/figures/cmatlim.png")

y <- c(sum(df.gbm0$preds2<quantile(df.gbm0$preds2, 1-q) & df.gbm0$vdelta1001>quantile(df.gbm0$vdelta1001, 1-q))/nrow(df.gbm0),
       sum(df.gbm0$preds2>quantile(df.gbm0$preds2, 1-q) & df.gbm0$vdelta1001>quantile(df.gbm0$vdelta1001, 1-q))/nrow(df.gbm0),
       sum(df.gbm0$preds2<quantile(df.gbm0$preds2, 1-q) & df.gbm0$vdelta1001<quantile(df.gbm0$vdelta1001, 1-q))/nrow(df.gbm0),
       sum(df.gbm0$preds2>quantile(df.gbm0$preds2, 1-q) & df.gbm0$vdelta1001<quantile(df.gbm0$vdelta1001, 1-q))/nrow(df.gbm0))

ggplot() +
  geom_tile(aes(x = ordered(tclass, levels = unique(tclass)), y = pclass, fill = y)) +
  geom_text(aes(x = ordered(tclass, levels = unique(tclass)), y = pclass, 
                label = paste(round(y,3), "\n", c("", paste("(",as.character(round(y[2]/q,3)*100), "%)", sep = ""), "", ""))), vjust = 1, color = "white") + 
  theme_bw() + guides(fill = FALSE) + labs(x = "", y = "", title = "Full Model") +
  theme(text = element_text(size = 22))
ggsave("/Users/mdgordo/Dropbox (Yale_FES)/Nepal/presentation_materials/figures/cmatfull.png")
```

Utility Benefit - 25k emergency aid

### this is avg benefit, for some reason with sum get diff answers - lengths are not same?
### should be weighting?

```{r}
a <- mean(df.gbm0$vdelta251[df.gbm0$preds1>quantile(df.gbm0$preds1, 1-q)])/mean(df.gbm0$vdelta251[df.gbm0$emergency_aid==1])
b <- mean(df.gbm0$vdelta251[df.gbm0$preds2>quantile(df.gbm0$preds2, 1-q)])/mean(df.gbm0$vdelta251[df.gbm0$emergency_aid==1])
c <- mean(df.gbm0$vdelta251[df.gbm0$NGO_transfers>0])/mean(df.gbm0$vdelta251[df.gbm0$emergency_aid==1])

ggplot() +
  geom_col(aes(x = c(1, a, b, c), y = c("Actual", "Limited", "Full", "NGO"), fill = c(1, 2, 3, 4))) +
  theme_bw() + labs(x = "", y = "", title = "Benefits relative to actual allocations") + guides(fill = FALSE) +
  theme(text = element_text(size = 20))

ggsave("/Users/mdgordo/Dropbox (Yale_FES)/Nepal/presentation_materials/figures/bensmodel.png")
```
Benefit by district relative to overall average

```{r}
df.distval <- df.gbm0 %>%
  group_by(distname) %>%
  summarize(avg_need = mean(vdelta251, na.rm = TRUE),
            val_aid = sum(vdelta251*emergency_aid, na.rm = TRUE)/sum(emergency_aid, na.rm = TRUE)) %>%
  mutate(relative_need = avg_need/mean(df.gbm0$vdelta251),
         relative_val = val_aid/mean(df.gbm0$vdelta251[df.gbm0$emergency_aid==1]))

df.districts <- data.frame("district_name" = c("Gorkha", "Dhading", "Rasuwa", "Nuwakot", "Sindhupalchok", "Dolakha", "Ramechhap",
                                               "Kathmandu", "Bhaktapur", "Lalitpur", "Kabhrepalanchok", "Okhaldhunga", "Sindhuli", "Makwanpur",
                                               "Lamjung", "Tanahun", "Chitwan", "Solukhumbu", "Khotang", 
                                               "Kaski", "Parbat", "Syangja", "Palpa", "Gulmi", "Baglung",
                                               "Myagdi", "Arghakhanchi", "Nawalparasi", "Bhojpur", "Dhankuta", "Sankhuwasabha"),
                           "district" = c(36, 30, 29, 28, 23, 22, 21, 27, 26, 25, 24, 12, 20, 31, 37, 38, 35, 11, 13,
                                          40, 44, 39, 47, 46, 45, 43, 51, 48, 10, 7, 9), 
                           "dist_14" = c(rep(1, times = 14), rep(0, times = 17)),
                           "designation" = c(rep("severe", 7), rep("crisis", 7), rep("heavy", 5), rep("hit", 6), rep("slight", 6)))

df.shp <- st_read("/Users/mdgordo/Dropbox (Yale_FES)/Nepal/shapefiles/NPL_adm", "NPL_adm3") %>%
              mutate(district_name = if_else(NAME_3=="Chitawan", "Chitwan",
                                                 if_else(NAME_3=="Tanahu", "Tanahun",
                                                         if_else(NAME_3=="Kavrepalanchok","Kabhrepalanchok",as.character(NAME_3)))))

df.shp <- merge(df.shp, df.districts, by = "district_name", all = TRUE)
df.shp <- merge(df.shp, df.distval, by.x = "district_name", by.y = "distname", all = TRUE)

ggplot(df.shp) +
  geom_sf(aes(fill = relative_need))

ggplot(df.shp) +
  geom_sf(aes(fill = relative_val))
```


Value of speed:
avg utility benefit of 100k reconstruction aid - round 2 and 3, relative to round 1

```{r}
a <- mean(df.hh$vdelta252[df.hh$wave==2], na.rm = TRUE)/mean(df.hh$vdelta251[df.hh$wave==1], na.rm = TRUE)
b <- mean(df.hh$vdelta253[df.hh$wave==3], na.rm = TRUE)/mean(df.hh$vdelta251[df.hh$wave==1], na.rm = TRUE)

ggplot() +
  geom_col(aes(x = c(1, a, b), y = c("First", "Second", "Third"), fill = c(2, 3, 1))) +
  theme_bw() + labs(x = "", y = "", title = "Average value of aid by wave") + guides(fill = FALSE) +
  theme(text = element_text(size = 20))

ggsave("/Users/mdgordo/Dropbox (Yale_FES)/Nepal/presentation_materials/figures/bstock_wave.png")
```

Value of aid actually given

```{r}
a <- mean(df.hh$vdelta252[df.hh$reconstruction_aid_bin==1 & df.hh$wave==2], na.rm = TRUE)/mean(df.hh$vdelta251[df.hh$emergency_aid==1 & df.hh$wave==1], na.rm = TRUE)
b <- mean(df.hh$vdelta253[df.hh$reconstruction_aid_bin==1 & df.hh$wave==3], na.rm = TRUE)/mean(df.hh$vdelta251[df.hh$emergency_aid==1 & df.hh$wave==1], na.rm = TRUE)

ggplot() +
  geom_col(aes(x = c(1, a, b), y = c("First", "Second", "Third"), fill = c(2, 3, 1))) +
  theme_bw() + labs(x = "", y = "", title = "Utility relative to first wave") + guides(fill = FALSE) +
  theme(text = element_text(size = 20))

ggsave("/Users/mdgordo/Dropbox (Yale_FES)/Nepal/presentation_materials/figures/benswave.png")
```
